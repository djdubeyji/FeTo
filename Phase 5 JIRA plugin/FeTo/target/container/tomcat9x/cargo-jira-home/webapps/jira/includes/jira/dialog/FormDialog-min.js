define("jira/dialog/form-dialog",["jira/util/formatter","jira/dialog/dialog","jira/flag","jira/message","jira/ajs/ajax/smart-ajax","jira/focus/set-focus","jira/util/browser","jira/util/events","jira/skate","jquery","jira/libs/parse-uri"],(function(t,e,i,s,o,n,r,a,u,l,c){"use strict";return e.extend({defineResources:function(){this._super.apply(this,arguments);this.isIssueDialog()&&this.requireContext("jira.edit.issue")},_getDefaultOptions:function(){return l.extend(this._super(),{autoClose:!1,targetUrl:"",refreshOnSubmit:!0,onUnSuccessfulSubmit:function(){},onSuccessfulSubmit:function(){},onDialogFinished:function(){var t=this._getTargetUrlValue();this.hide();if(t){a.trigger("page-unload.location-change.from-dialog",[this.$popup]);window.location.href=t}else if(this.options.refreshOnSubmit){a.trigger("page-unload.refresh.from-dialog",[this.$popup]);r.reloadViaWindowLocation()}},submitAjaxOptions:{type:"post",data:{inline:!0,decorator:"dialog"},dataType:"html"},isIssueDialog:!1})},_getFormDataAsObject:function(){var t={};l(this.$form.serializeArray()).each((function(){var e=t[this.name];e?l.isArray(e)?e.push(this.value):e=[e,this.value]:e=this.value;t[this.name]=e}));return t},_getRelativePath:function(){var t=this._getRequestOptions();return c(t.url).directory},_getPath:function(t){var e=this._getRelativePath();return 0===t.indexOf(e)?t:e+t},_submitForm:function(t){this.cancelled=!1;this.xhr=null;this.redirected=!1;this.serverIsDone=!1;var e=this,i=l.extend(!0,{},this.options.submitAjaxOptions),s=l.extend(!0,i,{url:this._getPath(this.$form.attr("action")),data:this._getFormDataAsObject(),complete:function(t,i,s){e.hideFooterLoadingIndicator();if(!e.cancelled){e._showMessagesFromXhrResponse(t);if(s.successful){e.$form.trigger("fakesubmit");e._handleServerSuccess(s.data,t,i,s);e.redirected||e._handleSubmitResponse(s.data,t,s)}else e._handleServerError(t,i,s.errorThrown,s)}e.$form.removeClass("submitting")}});s.data.decorator="dialog";s.data.inline=!0;this.showFooterLoadingIndicator();this.xhr=o.makeRequest(s);t.preventDefault()},_showMessagesFromXhrResponse:function(t){var e=t.getResponseHeader("X-Atlassian-Messages");if(e){var s=JSON.parse(e);i.showMessages(s)}},_handleServerError:function(t,e,i,s){this.options.onUnSuccessfulSubmit&&this.options.onUnSuccessfulSubmit.call(t,e,i,s);var n=o.buildDialogErrorContent(s,!0),r=this.get$popupContent().find(".form-body");1!==r.length&&(r=this.get$popupContent());1===r.length&&!s.hasData?r.prepend(n):this.setSubmitResponseContent(n)},setSubmitResponseContent:function(t){this.options.formatSubmitResponseContent&&(t=this.options.formatSubmitResponseContent.call(this,t));this._setContent(t)},isIssueDialog:function(){return!!this.options.isIssueDialog},_handleServerSuccess:function(t,e,i,o){var n=this._detectMsgInstructions(e),r=this._detectRedirectInstructions(e);this.serverIsDone=r.serverIsDone;n&&(r.redirectUrl||this._getTargetUrlValue()||this.options.refreshOnSubmit?s.showMsgOnReload(n.msg,{type:n.type,closeable:n.closeable,target:n.target}):s.showMsg(n.msg,{type:n.type.toLowerCase(),closeable:n.closeable,target:n.target}));if(r.redirectUrl){this.options.onSuccessfulSubmit&&this.options.onSuccessfulSubmit.call(this,t,e,i,o);this._performRedirect(r.redirectUrl)}else this.serverIsDone||this.setSubmitResponseContent(t)},_detectMsgInstructions:function(t){var e={msg:t.getResponseHeader("X-Atlassian-Dialog-Msg-Html")};if(e.msg){e.type=t.getResponseHeader("X-Atlassian-Dialog-Msg-Type").toUpperCase();e.closeable="true"===t.getResponseHeader("X-Atlassian-Dialog-Msg-Closeable");e.target=t.getResponseHeader("X-Atlassian-Dialog-Msg-Target");return e}},_handleInitialDoneResponse:function(t,e,i){this._handleSubmitResponse(t,e,i)},_handleSubmitResponse:function(t,e,i){if(this.serverIsDone){this.options.onSuccessfulSubmit&&this.options.onSuccessfulSubmit.call(this,t,e,i);this.options.autoClose&&this.hide();this.options.onDialogFinished&&this.options.onDialogFinished.call(this,t,e,i)}else this.$popup&&this.$popup.find("[aria-invalid='true']").first().focus()},_performRedirect:function(t){this.options.stayVisibleOnRedirect||this.hide();this.redirected=!0;this._super(t)},_hasTargetUrl:function(){return this._getTargetUrlHolder().length>0},_getTargetUrlHolder:function(){return l(this.options.targetUrl)},_getTargetUrlValue:function(){return this._getTargetUrlHolder().val()},decorateContent:function(){var i,s,o,n,r,a=this;this.$form=l("form",this.get$popupContent());this._constructHeading();this.$form.submit((function(t){var e=new l.Event("before-submit");a.$form.trigger(e,[t,a]);if(e.isDefaultPrevented())t.preventDefault();else{a.$form.addClass("submitting");l(":submit",a.$form).attr("disabled","disabled");if(a.options.submitHandler){a.showFooterLoadingIndicator();a.options.submitHandler.call(a,t,(function(){if(a.isCurrent()){a.hideFooterLoadingIndicator();a.$form.removeClass("submitting")}}))}else a._submitForm(t)}}));(s=l(".cancel",this.get$popupContent())).click((function(t){a.xhr&&a.xhr.abort();a.xhr=null;a.cancelled=!0;a.hide(!0,{reason:e.HIDE_REASON.cancel});t.preventDefault()}));i=this.get$popupContent().find(".button, .aui-button");o=this.get$popupContent().find("div.buttons");if(0===s.length&&0===i.length){0===o.length&&(o=(n=l('<div class="buttons-container form-footer"><div class="buttons"/></div>').appendTo(this.get$popupContent())).find(".buttons"));AJS.populateParameters();r=l("<button class='aui-button aui-button-link cancel' id='aui-dialog-close'>"+t.I18n.getText("admin.common.words.close")+"</button>");o.append(r);(r=l(".cancel",this.get$popupContent())).click((function(t){a.hide(!0,{reason:e.HIDE_REASON.cancel});t.preventDefault()}))}o.prepend(l("<span class='throbber'/>"));this.get$popupContent().on("click",".shortcut-tip-trigger",(function(e){e.preventDefault();if(!a.get$popupContent().isDirty()||confirm(t.I18n.getText("common.forms.dirty.dialog.message"))){a.hide();l("#keyshortscuthelp").click()}}));n instanceof l||(n=o.closest(".buttons-container, .form-footer")).size()||(n=o);this.$buttonContainer=n},getButtonsContainer:function(){return this.$buttonContainer},_constructHeading:function(){var t,e;if((t=l(":header:first",this.get$popupContent())).length>0){this.addHeading(t.contents());e=t.parent();t.remove();for(;e.is(":empty");){t=e.parent();e.remove();e=t}}},_setContent:function(t,i){this._super(t,i);t&&e.current===this&&(this.options.shouldFocusTitleOnLoad?this.focusTitle():this._focusFirstField())},_focusFirstField:function(t){var e=new n.FocusConfiguration;t?e.focusElementSelector=t:this.$activeTrigger&&this.$activeTrigger.attr("data-field")&&(e.focusElementSelector="[name='"+this.$activeTrigger.attr("data-field")+"']");e.parentElementSelectors.unshift(".aui-dialog-content");e.context=this.get$popup()[0];u.init&&u.init(e.context);n.pushConfiguration(e);n.triggerFocus();n.triggerFocus()},hide:function(t,e){if(!1===this._super(t,e))return!1;this.options.shouldFocusTitleOnLoad&&n.popConfiguration()}})}));AJS.namespace("AJS.FormPopup",null,require("jira/dialog/form-dialog"));AJS.namespace("JIRA.FormDialog",null,require("jira/dialog/form-dialog"));