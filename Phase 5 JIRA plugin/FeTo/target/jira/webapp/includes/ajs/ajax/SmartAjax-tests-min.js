AJS.test.require(["jira.webresources:dialogs"],(function(){"use strict";var e=require("jquery"),t=require("jira/dialog/dialog"),a=require("jira/dialog/form-dialog"),s=require("jira/util/browser"),o=require("jira/ajs/ajax/smart-ajax"),l=null;module("SmartAjax.showWebSudoDialog",{teardown:function(){this.sandbox.restore()},setup:function(){var t=this;l=null;this.sandbox=sinon.sandbox.create();this.sandbox.stub(s,"reloadViaWindowLocation");this.sandbox.stub(a.prototype,"show");this.sandbox.stub(a.prototype,"hide");this.sandbox.stub(a.prototype,"_setContent");this.sandbox.stub(a.prototype,"init",(function(e){this.options=e||{};l=this}));a.prototype.triggerHide=function(a){e(this).trigger("Dialog.hide",[{find:function(){return{attr:function(){return t.href}}}},a])}}});function i(t){var a=t.context||o;o.showWebSudoDialog(t);var s=l;if(t.beforeShow){ok(t.beforeShow.calledOnce,"Before show called.");ok(t.beforeShow.firstCall.calledOn(a),"Show called with correct context.")}ok(s.show.calledOnce,"Dialog was shown.");t.beforeShow&&ok(t.beforeShow.calledBefore(s.show),"beforeShow called before show.");if(t.show){ok(t.show.calledOnce,"Show called.");ok(t.show.firstCall.calledOn(a),"Show called with correct context.");ok(t.show.calledAfter(s.show),"Show called after dialog shown.")}var i=s.options.submitHandler,n=e.Event();n.target=e("<form></form>").attr("action","url").append("<input name='jack' value='jill'/>");var d=this.sandbox.spy(),c=this.sandbox.stub(o,"makeRequest");i(n,d);ok(n.isDefaultPrevented(),"Default operation prevented.");ok(c.calledOnce,"Made the request for the websudo dialog.");var r=c.firstCall.args[0];equal(r.url,n.target.attr("action"),"Correct Action");equal(r.data,n.target.serialize(),"Correct Data");equal(r.type,"POST","Correct type");var u=r.complete,h={getResponseHeader:this.sandbox.stub(),responseText:"callback"};u(h);ok(!d.called,"Close callback should not be called.");ok(!s.hide.called,"Dialog should not be closed.");t.success&&ok(!t.success.called,"Success function should not have been called.");ok(s._setContent.calledWith(h.responseText,!0),"Dialog content reset.");h.getResponseHeader.withArgs("X-Atlassian-WebSudo").returns("Has-Authentication");u(h);if(t.success){ok(t.success.calledOnce,"Success called.");ok(!d.called,"Close callback should not be called.");ok(!s.hide.called,"Dialog should not be closed.");t.success.firstCall.args[0]()}ok(d.calledOnce,"Close callback should be called.");ok(s.hide.calledOnce,"Dialog should be closed.")}test("not success callback",(function(){i.call(this,{})}));test("beforeShow and show success callback",(function(){i.call(this,{beforeShow:this.sandbox.stub(),show:this.sandbox.stub()})}));test("beforeShow and show success callback with context",(function(){i.call(this,{beforeShow:this.sandbox.stub(),show:this.sandbox.stub(),context:{}})}));test("success callback with context",(function(){i.call(this,{success:this.sandbox.stub(),context:{}})}));test("success callback without context",(function(){i.call(this,{success:this.sandbox.stub()})}));test("all callbacks without context",(function(){i.call(this,{beforeShow:this.sandbox.stub(),show:this.sandbox.stub(),success:this.sandbox.stub()})}));test("all callbacks with context",(function(){i.call(this,{beforeShow:this.sandbox.stub(),show:this.sandbox.stub(),success:this.sandbox.stub(),context:{}})}));test("aborted no cancel",(function(){o.showWebSudoDialog({});var e=l;ok(e.show.calledOnce,"Dialog was shown.");e.triggerHide(t.HIDE_REASON.cancel);e.triggerHide(t.HIDE_REASON.escape)}));var n=function(e){s.reloadViaWindowLocation.reset();this.href="i love web sudo";var t=this.sandbox.spy(),a={};o.showWebSudoDialog({cancel:t,context:a});var i=l;ok(i.show.calledOnce,"Dialog was shown.");i.triggerHide(e);ok(t.calledOnce,"Cancel trigger should be called once.");ok(t.alwaysCalledOn(a),"Called on right context.");ok(s.reloadViaWindowLocation.calledWithExactly(this.href))};test("aborted with cancel",(function(){n.call(this,t.HIDE_REASON.cancel)}));test("aborted with escape",(function(){n.call(this,t.HIDE_REASON.escape)}));test("can prevent redirect by e.preventDefault()",(function(){s.reloadViaWindowLocation.reset();o.showWebSudoDialog({cancel:function(e){e.preventDefault()}});ok(!s.reloadViaWindowLocation.called)}));test("can prevent redirect by returning false",(function(){s.reloadViaWindowLocation.reset();o.showWebSudoDialog({cancel:function(){return!1}});ok(!s.reloadViaWindowLocation.called)}));module("SmartAjax.handleWebSudoError",{teardown:function(){this.sandbox.restore()},setup:function(){this.sandbox=sinon.sandbox.create();this.webSudo=require("jira/ajs/ajax/smart-ajax/web-sudo");this.dialog=this.sandbox.stub(this.webSudo,"showWebSudoDialog");this.makeRequest=this.sandbox.stub(o,"makeRequest")}});test("success without delegating handler",(function(){var t={};this.webSudo.handleWebSudoError(t,void 0,{},"something",{});ok(this.dialog.calledOnce,"Delgate to showWebSudoDialog");var a=this.dialog.args[0][0];ok(e.isFunction(a.success),"Provided success.");ok(e.isFunction(a.cancel),"Provided cancel.");var s=this.sandbox.spy();a.success.call(void 0,s);ok(s.calledOnce,"Make sure we close the dialog by default.");ok(this.makeRequest.calledOnce,"Make the request again, it might just work this time.");ok(this.makeRequest.calledWithExactly(t),"Make the request again, it might just work this time.")}));test("success with delegating handler",(function(){var t=this.sandbox.spy(),a={};this.webSudo.handleWebSudoError(a,{success:t},{},"something",{});ok(this.dialog.calledOnce,"Delgate to showWebSudoDialog");var s=this.dialog.args[0][0];ok(e.isFunction(s.success),"Provided success.");ok(e.isFunction(s.cancel),"Provided cancel.");var o=this.sandbox.spy();s.success.call(void 0,o);ok(!o.calledOnce,"With a callback we don't close the dialog.");ok(this.makeRequest.calledOnce,"Make the request again, it might just work this time.");ok(this.makeRequest.calledWithExactly(a),"Make the request again, it might just work this time.");ok(t.calledOnce,"The success handler should have been called.");t.args[0][0]();ok(o.calledOnce,"The callback has now closed the dialog.")}));test("cancel wihtout handler",(function(){this.webSudo.handleWebSudoError({},void 0,{},"something",{});ok(this.dialog.calledOnce,"Delgate to showWebSudoDialog");var t=this.dialog.args[0][0];ok(e.isFunction(t.success),"Provided success.");ok(e.isFunction(t.cancel),"Provided cancel.");t.cancel.call(void 0)}));test("cancel with dialog Handler",(function(){var t=this.sandbox.spy(),a={};this.webSudo.handleWebSudoError({},{cancel:t},{},"something",{});ok(this.dialog.calledOnce,"Delgate to showWebSudoDialog");var s=this.dialog.args[0][0];ok(e.isFunction(s.success),"Provided success.");ok(e.isFunction(s.cancel),"Provided cancel.");s.cancel.call(a);ok(t.calledOnce,"Cancel called on the dialog options.");ok(t.alwaysCalledOn(a),"Called with the right context.")}));test("cancel with ajax handler Handler",(function(){var t=this.sandbox.spy(),a={complete:t},s={},o="something",l={},i={};this.webSudo.handleWebSudoError(a,{cancel:""},s,o,l);ok(this.dialog.calledOnce,"Delgate to showWebSudoDialog");var n=this.dialog.args[0][0];ok(e.isFunction(n.success),"Provided success.");ok(e.isFunction(n.cancel),"Provided cancel.");n.cancel.call(i);ok(t.calledOnce,"Cancel called on the dialog options.");ok(t.alwaysCalledOn(i),"Called with the right context.");ok(t.alwaysCalledWithExactly(s,o,l),"Called with right arguments.")}));module("SmartAjax.makeWebSudoRequest",{teardown:function(){this.sandbox.restore()},setup:function(){this.sandbox=sinon.sandbox.create();this.makeRequest=this.sandbox.stub(o,"makeRequest");this.webSudo=require("jira/ajs/ajax/smart-ajax/web-sudo")}});test("makeWebSudoRequest with non 401 status code.",(function(){var e=this.sandbox.spy(),t=this.sandbox.spy();this.webSudo.makeWebSudoRequest({error:e,copy:"me"}).fail(t);ok(this.makeRequest.calledOnce,"makeRequest called.");var a=this.makeRequest.getCall(0).args;equal(a.length,1,"makeRequest called with 1 argument.");var s=a[0];equal(s.copy,"me","Make sure non-error options copied.");var o={status:38,responseText:"ignored"},l="sjdjakdjakda",i="4897589475893754983",n="rehsjfhdskjfhsdkhgtiu4y4";s.error(o,l,i,n);ok(e.calledOnce,"Called Original Error");ok(e.getCall(0).calledWithExactly(o,l,i,n),"Called error with correct arguments.");ok(t.calledOnce,"Called Original Error");ok(t.getCall(0).calledWithExactly(o,l,i,n),"Called error with correct arguments.")}));test("makeWebSudoRequest with 401 status code but not WebSudo failure.",(function(){var e=this.sandbox.spy(),t=this.sandbox.spy();this.webSudo.makeWebSudoRequest({error:e,copy:"me"}).fail(t);ok(this.makeRequest.calledOnce,"makeRequest called.");var a=this.makeRequest.getCall(0).args;equal(a.length,1,"makeRequest called with 1 argument.");var s=a[0];equal(s.copy,"me","Make sure non-error options copied.");var o={status:401,responseText:"ignored"},l="sjdjakdjakda",i="4897589475893754983",n="rehsjfhdskjfhsdkhgtiu4y4";s.error(o,l,i,n);ok(e.calledOnce,"Called Original Error Again");ok(e.getCall(0).calledWithExactly(o,l,i,n),"Called error.");ok(t.calledOnce,"Called Original Error Again");ok(t.getCall(0).calledWithExactly(o,l,i,n),"Called error.")}));test("makeWebSudoRequest with websudo dialog & success",(function(){this.sandbox.stub(this.webSudo,"handleWebSudoError");var e=this.sandbox.spy(),t=this.sandbox.spy(),a=this.sandbox.spy(),s=this.sandbox.spy(),o=this.sandbox.spy();this.webSudo.makeWebSudoRequest({error:o,success:e,complete:a,copy:"me"}).fail(s).done(t);ok(this.makeRequest.calledOnce,"makeRequest called.");var l=this.makeRequest.getCall(0).args;equal(l.length,1,"makeRequest called with 1 argument.");var i=l[0];equal(i.copy,"me","Make sure non-error options copied.");i.error({status:401,responseText:"websudo"},"sjdjakdjakda","4897589475893754983","rehsjfhdskjfhsdkhgtiu4y4");i.complete();ok(!e.called,"Nothing should be called while websudo detected open.");ok(!t.called,"Nothing should be called while websudo detected open.");ok(!a.called,"Nothing should be called while websudo detected open.");ok(!s.called,"Nothing should be called while websudo detected open.");ok(!o.called,"Nothing should be called while websudo detected open.");ok(this.webSudo.handleWebSudoError.called,"Make sure we open the websudo dialog.");var n=this.webSudo.handleWebSudoError.args[0][0],d={},c={},r={};n.success.call(r,d);n.complete.call(r,c);ok(e.called,"Success should now be called.");ok(e.alwaysCalledWithExactly(d),"Called with correct arguments.");ok(e.alwaysCalledOn(r,d),"Called with correct context.");ok(t.called,"Promise success should now be called.");ok(t.alwaysCalledWithExactly(d),"Called with correct arguments.");ok(t.alwaysCalledOn(r,d),"Called with correct context.");ok(a.called,"Complete should now be called.");ok(a.alwaysCalledWithExactly(c),"Called with correct arguments.");ok(a.alwaysCalledOn(r,c),"Called with correct context.");ok(!s.called,"Error should never have been called.");ok(!o.called,"Error should never have been called.")}));module("SmartAjax test sending X-AUSERNAME header",{setup:function(){var e="someusername";this.username=e;this.meta={};this.meta.get=sinon.stub();this.meta.get.withArgs("remote-user").returns(e);this.mockedContext=AJS.test.mockableModuleContext();this.mockedContext.mock("jira/util/data/meta",this.meta);this.sandbox=sinon.sandbox.create({useFakeServer:!0})},teardown:function(){this.sandbox.restore()}});test("ajax request include 'X-AUSERNAME' header",(function(){this.mockedContext.require("jira/ajs/ajax/smart-ajax").makeRequest({url:"http://someurl",data:"some_data",type:"POST"});equal(this.sandbox.server.requests.length,1,"There should be 1 request");equal(this.sandbox.server.requests[0].requestHeaders["X-AUSERNAME"],this.username,"username should be sent as a header")}));module("SmartAjax test sending undefined X-AUSERNAME header",{setup:function(){this.meta={};this.meta.get=sinon.stub();this.meta.get.withArgs("remote-user").returns(void 0);this.mockedContext=AJS.test.mockableModuleContext();this.mockedContext.mock("jira/util/data/meta",this.meta);this.sandbox=sinon.sandbox.create({useFakeServer:!0})},teardown:function(){this.sandbox.restore()}});test("ajax request include undefined 'X-AUSERNAME' header",(function(){this.mockedContext.require("jira/ajs/ajax/smart-ajax").makeRequest({url:"http://someurl",data:"some_data",type:"POST"});equal(this.sandbox.server.requests.length,1,"There should be 1 request");var e=this.sandbox.server.requests[0].requestHeaders["X-AUSERNAME"];equal(e,"undefined",'"undefined" username should be sent as a header when no username is provided')}));module("SmartAjax test sending empty X-AUSERNAME header",{setup:function(){this.meta={};this.meta.get=sinon.stub();this.meta.get.withArgs("remote-user").returns("");this.mockedContext=AJS.test.mockableModuleContext();this.mockedContext.mock("jira/util/data/meta",this.meta);this.sandbox=sinon.sandbox.create({useFakeServer:!0})},teardown:function(){this.sandbox.restore()}});test("ajax request include empty 'X-AUSERNAME' header",(function(){this.mockedContext.require("jira/ajs/ajax/smart-ajax").makeRequest({url:"http://someurl",data:"some_data",type:"POST"});equal(this.sandbox.server.requests.length,1,"There should be 1 request");var e=this.sandbox.server.requests[0].requestHeaders["X-AUSERNAME"];equal(e,"","empty string should be sent as a header when empty username is provided")}))}));