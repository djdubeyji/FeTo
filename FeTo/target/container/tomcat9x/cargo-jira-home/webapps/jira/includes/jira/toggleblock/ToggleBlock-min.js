define("jira/toggleblock/toggle-block",["jira/util/logger","jira/lib/class","jira/util/events","jira/util/events/types","jira/data/local-storage","jquery","jira/libs/parse-uri"],(function(t,e,i,o,s,n,r){"use strict";var a=/^#[a-zA-Z0-9_\-]+$/;function l(t){var e=t.data.instance;n(this).hasClass(e.options.collapsedClass)&&e.expand(this)}function c(t){var e=t.data.instance;if(!e.options.originalTargetIgnoreSelector||!n(t.originalTarget).is(e.options.originalTargetIgnoreSelector)){e.toggle(t.target);t.preventDefault()}}function d(t){t.data.instance._collapseTwiciBlocksFromStorage()}return e.extend({getDefautOptions:function(){return{blockSelector:".twixi-block",triggerSelector:".twixi",eventType:"click",collapsedClass:"collapsed",expandedClass:"expanded",storageCollectionName:"twixi-blocks",autoFocusTrigger:!0}},_collapseTwiciBlocksFromStorage:function(){var t,e=s.getItem(this.options.storageCollectionName)||"";(e=e.split(",").filter((function(t){return a.test(t)})).join(","))&&(t=n(e)).is(this.options.blockSelector)&&(this.isPermlink()||this._addCollapsedState(t));return this},_addCollapsedState:function(t){t.removeClass(this.options.expandedClass).addClass(this.options.collapsedClass);this._updateAriaLabelForTriggerElement(t,!1)},_addExpandedState:function(t){t.removeClass(this.options.collapsedClass).addClass(this.options.expandedClass);this._updateAriaLabelForTriggerElement(t,!0)},_updateAriaLabelForTriggerElement:function(t,e){var i=t.attr("id");t.find('[aria-controls="'+i+'"]').attr("aria-expanded",e)},_updateTwixiBlockIdInStorage:function(t){if(!this.isPermlink()){if(!a.test(t))return this;var e=(s.getItem(this.options.storageCollectionName)||"").split(",").filter((function(t){return a.test(t)})),i=e.indexOf(t);-1!==i?e.splice(i,1):e.push(t);try{s.setItem(this.options.storageCollectionName,e.join(","))}catch(t){}}return this},contract:function(t){if((t=n(t)).is(this.options.blockSelector)){this._addCollapsedState(t);!1!==this.options.persist&&this._updateTwixiBlockIdInStorage("#"+t.attr("id"))}n(t).trigger("contractBlock");return this},expand:function(t){if((t=n(t)).is(this.options.blockSelector)){this._addExpandedState(t);!1!==this.options.persist&&this._updateTwixiBlockIdInStorage("#"+t.attr("id"))}n(t).trigger("expandBlock");return this},toggle:function(t){var e=n(t).closest(this.options.blockSelector);e.hasClass(this.options.collapsedClass)?this.expand(e):this.contract(e);this.options.autoFocusTrigger&&e.find(this.options.triggerSelector+":visible").focus();return this},isPermlink:function(){return this.checkIsPermlink(location.href)},checkIsPermlink:function(t){var e=r(t).queryKey;return e.hasOwnProperty("focusedId")||e.hasOwnProperty("focusedCommentId")||e.hasOwnProperty("focusedWorklogId")},addTrigger:function(t,e){var i=this,o=0;if(t){"dblclick"===(e=e||"click")&&(document.selection?n(document).delegate(t,"dblclick",(function(){document.selection.empty()})):n(document).delegate(t,"mousedown",(function(){var t=(new Date).getTime(),e=t-o>750;o=t;return e})));n(document).delegate(t,e,(function(){i.toggle(this)}))}return this},addCallback:function(t,e){n.aop.after({target:this,method:t},e);return this},isUnique:function(t){var e=n(document).data("toggleBlockUids")||[];return-1===n.inArray(t,e)},setUid:function(t){var e=n(document).data("toggleBlockUids")||[];e.push(t);n(document).data("toggleBlockUids",e)},init:function(e){var s=this;e=e||{};this.options=n.extend(this.getDefautOptions(),e);var r=this.options.triggerSelector;if(this.isUnique(r)){this.setUid(r);n(document).delegate(this.options.blockSelector,"reveal",{instance:this},l);n(document).delegate(this.options.triggerSelector,this.options.eventType,{instance:this},c);i.bind(o.REFRESH_TOGGLE_BLOCKS,{instance:this},d);!1!==this.options.persist&&n((function(){s._collapseTwiciBlocksFromStorage()}))}else"undefined"!=typeof console&&t.warn&&t.warn("Your are trying to create a ToggleBlock with selector '"+this.options.triggerSelector+"'.One already exists with this trigger so has been ignored.")}})}));AJS.namespace("JIRA.ToggleBlock",null,require("jira/toggleblock/toggle-block"));