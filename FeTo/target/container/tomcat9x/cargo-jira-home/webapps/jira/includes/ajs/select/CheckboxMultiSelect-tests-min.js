AJS.test.require(["jira.webresources:jira-global","jira.webresources:select-pickers","com.atlassian.auiplugin:ajs-underscorejs-amd-shim"],(function(){"use strict";var e=require("jquery"),t=require("underscore"),i=require("jira/ajs/select/checkbox-multi-select");module("CheckboxMultiSelect",{setup:function(){e.fn.tipsy=function(){};var n=e('<select class="select" data-placeholder-text="Find Projects..." id="searcher-pid" multiple="multiple" name="pid" size="5" style="display: none; ">\n    <optgroup label="All Projects">\n        <option selected="selected" data-icon="/jira/secure/projectavatar?pid=10021&amp;size=small" title="Billabong" value="10021">Billabong</option>\n        <option selected="selected" data-icon="/jira/secure/projectavatar?pid=10020&amp;size=small" title="Hurley" value="10020">Hurley</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10023&amp;size=small" title="Insight" value="10023">Insight</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10026&amp;size=small" title="Nike 6.0" value="10026">Nike 6.0</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10022&amp;size=small" title="Quiksilver" value="10022">Quiksilver</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10028&amp;size=small" title="Ripcurl" value="10028">Ripcurl</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10025&amp;size=small" title="Stussy" value="10025">Stussy</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10027&amp;size=small" title="Surfrider Foundation" value="10027">Surfrider Foundation</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10024&amp;size=small" title="Volcom" value="10024">Volcom</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10024&amp;size=small" data-icon-type="rounded" title="Volcom" value="10088">Volly</option>\n    </optgroup>\n</select>').appendTo("body"),s=new i({element:n,stallEventBind:!1,ariaLabel:"Test label"});this.control=s;function o(t){return t?e("#searcher-pid-suggestions").find(t).find("li.check-list-item"):e("#searcher-pid-suggestions li.check-list-item")}function a(e,t){return o(t).filter(":contains("+e+")")}function l(e){return n.find("option:contains("+e+")")}function r(){return s.getQueryVal()}function c(t){var i="string"==typeof t;i||(t={38:"Up",40:"Down",13:"Return",8:"Backspace"}[t]);var n=new e.Event("aui:keydown");n.key=t;s.$field.trigger(n);if(i||"Backspace"===t){(n=new e.Event("aui:keypress")).key=t;s.$field.trigger(n)}i&&s.$field.val(s.$field.val()+t);"Backspace"===t&&s.$field.val(s.$field.val().substring(0,s.$field.val().length-1));s.$field.trigger("keyup")}this.tester={type:function(e){s.$field.focus().val(e).trigger("input");return this},down:function(){s.$field.focus();c(40);return this},up:function(){s.$field.focus();c(38);return this},accept:function(){s.$field.focus();c(13);return this},clear:function(){return this.type("")},selectByText:function(e){a(e).find("input").trigger("change")},clearSelection:function(){n.trigger("clear")},clearQueryField:function(){s.$dropDownIcon.click()}};this.GROUPS={selectedProjects:".selected-group"};this.assert={noneSelected:function(){equal(o().find(":checked").length,0,"No suggestion is checked");equal(n.val(),null,"<select> has empty value")},selected:function(){var e=[];t.each(arguments,(function(t){var i=a(t);i.length&&ok(1===i.find(":checked").length,'Expected suggestion "'+t+'" to be checked');var n=l(t);ok(n.is(":selected"),'Expected option "'+t+'" to be selected in <select>');e.push(n.val())}));equal(JSON.stringify(n.val()),JSON.stringify(e))},selectedInGroup:function(e,i){var s=[];t.each(i,(function(t){var i=a(t,e);i.length&&ok(1===i.find(":checked").length,'Expected suggestion "'+t+'" to be checked');var n=l(t);ok(n.is(":selected"),'Expected option "'+t+'" to be selected in <select>');s.push(n.val())}));equal(JSON.stringify(n.val()),JSON.stringify(s))},suggestions:function(){equal(o().length,arguments.length,"Expected "+arguments.length+" suggestions present");t.each(arguments,(function(e){ok(1===a(e).length,'Expected suggestion "'+e+'" to be present')}))},element:function(e,t){equal(o().find(e).length,t,"Expected "+t+" elements "+e+" present")},noSuggestions:function(){equal(o().length,0,"Expected no suggestions to be present");equal(e("#searcher-pid-suggestions li.no-suggestions").length,1,"Expected the 'No Matches' hint to be present")},bolded:function(){var i=o().find("em");equal(i.length,arguments.length,"Expected "+arguments.length+" to be bolded");t.each(arguments,(function(t,n){equal(e.trim(i.eq(n).text()),t,"Expected text ["+t+"] to be bolded")}))},allSuggestions:function(){this.suggestions("Billabong","Hurley","Quiksilver","Insight","Nike 6.0","Ripcurl","Stussy","Surfrider Foundation","Volcom","Volly")},clearQueryIcon:function(e){equal(!!r(),e,"Expected clear query icon to be visible when the query field has text in it")},emptyQueryField:function(){ok(!r(),"Expected query field to be empty")}}},teardown:function(){e("#searcher-pid-multi-select").remove();e("#searcher-pid").remove()}});test("correct init state",(function(){this.assert.selectedInGroup(this.GROUPS.selectedProjects,["Billabong","Hurley"]);this.assert.allSuggestions()}));test("selecting/unselecting options",(function(){this.tester.down().accept().down().accept();this.assert.selected("Billabong","Insight");this.tester.accept().down().accept().down().accept();this.assert.selected("Billabong","Nike 6.0","Quiksilver")}));test("Querying",(function(){this.tester.type("vol");this.assert.suggestions("Volcom","Volly");this.assert.bolded("Vol","Vol");this.tester.type("xxx");this.assert.noSuggestions();this.assert.bolded();this.tester.clear();this.assert.allSuggestions();this.assert.bolded()}));test("Icon type",(function(){this.tester.type("Volly");this.assert.element(".icon.rounded",1)}));test("Selecting other than highlighted selects only selected",(function(){this.tester.down().down().down();this.tester.selectByText("Insight");this.assert.selected("Billabong","Hurley","Insight")}));test("Selected group is restored when no input value",(function(){this.tester.type("blah").clear();this.assert.selectedInGroup(this.GROUPS.selectedProjects,["Billabong","Hurley"])}));test("Clearing all selections",(function(){this.tester.clearSelection();this.assert.noneSelected()}));test("Clicking clear query icon when there is text removes all text",(function(){this.assert.clearQueryIcon(!1);this.tester.type("vol");this.assert.clearQueryIcon(!0);this.tester.clearQueryField();this.assert.clearQueryIcon(!1);this.assert.emptyQueryField()}));test("aria-label attribute should be set from ariaLabel option.",(function(){equal(this.control.$field.attr("aria-label"),"Test label")}));function n(t,n){t=t||{};var s=e('<select class="select" '+(n=n||"")+' data-placeholder-text="Find Projects..." id="searcher-pid" multiple="multiple" name="pid" size="5" style="display: none; ">\n    <optgroup label="All Projects">\n        <option data-icon="/jira/secure/projectavatar?pid=10021&amp;size=small" title="Billabong" value="10021">Billabong</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10020&amp;size=small" title="Hurley" value="10020">Hurley</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10023&amp;size=small" title="Insight" value="10023">Insight</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10026&amp;size=small" title="Nike 6.0" value="10026">Nike 6.0</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10022&amp;size=small" title="Quiksilver" value="10022">Quiksilver</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10028&amp;size=small" title="Ripcurl" value="10028">Ripcurl</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10025&amp;size=small" title="Stussy" value="10025">Stussy</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10027&amp;size=small" title="Surfrider Foundation" value="10027">Surfrider Foundation</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10024&amp;size=small" title="Volcom" value="10024">Volcom</option>\n        <option data-icon="/jira/secure/projectavatar?pid=10024&amp;size=small" data-icon-type="rounded" title="Volcom" value="10088">Volly</option>\n    </optgroup>\n</select>').appendTo("body");return new i(Object.assign({element:s,stallEventBind:!1},t))}module("CheckboxMultiSelect with limited options",{setup:function(){e.fn.tipsy=function(){}},teardown:function(){e("#searcher-pid-multi-select").remove();e("#searcher-pid").remove()}});test("Initializes with limited options specified with data attribute",(function(){var e=n({},'data-max-inline-results-displayed="5"');equal(e.$container.find(".check-list-item").length,5,"Limits visible options");ok(e.$container.html().includes("common.concepts.too.many.matches"),"Displays notice to end user")}));test("Initializes with limited options specified with JS",(function(){var e=n({maxInlineResultsDisplayed:5});equal(e.$container.find(".check-list-item").length,5,"Limits visible options");ok(e.$container.html().includes("common.concepts.too.many.matches"),"Displays notice to end user")}))}));