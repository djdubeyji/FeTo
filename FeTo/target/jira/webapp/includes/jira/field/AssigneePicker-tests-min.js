var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};AJS.test.require("jira.webresources:jira-global",(function(){"use strict";var e=require("jquery"),t=require("jira/field/assignee-picker"),s=require("underscore"),i="AAA-1",n="AAA",r=function(t,s,i){var n=e('\n            <select id="assignee" name="assignee" class="single-user-picker js-assignee-picker aui-ss-select" data-show-dropdown-button="true" data-user-type="assignee" data-container-class="long-field" data-use-new-endpoint="'+s+'" multiple="multiple" style="display: none;">\n                <optgroup id="assignee-group-suggested" label="Suggestions" data-weight="0">\n                    <option value="admin" data-field-text="admin" data-field-label="admin - admin@localhost (admin)" data-icon="/jira/secure/useravatar?size=xsmall&amp;avatarId=10122">admin</option>\n                    <option value="" data-field-text="Unassigned" data-field-label="Unassigned" data-icon="/jira/secure/useravatar?size=xsmall&amp;avatarId=10123">Unassigned</option>\n                    <option value="-1" data-field-text="Automatic" data-field-label="Automatic" data-icon="/jira/secure/useravatar?size=xsmall&amp;avatarId=10123">Automatic</option>\n                </optgroup>\n            </select>').appendTo(t),r=e('<fieldset class="hidden parameters"></fieldset>');e('<input type="hidden" title="projectKeys" value=AAA>').appendTo(r);i&&e('<input type="hidden" title="assigneeEditIssueKey" value=AAA-1>').appendTo(r);r.appendTo(t);return n};module("JIRA.AssigneePicker",{setup:function(){this.fixture=e("#qunit-fixture");this.xhr=sinon.useFakeXMLHttpRequest();var t=this.requests=[];this.xhr.onCreate=function(e){t.push(e)};var i=0;this.testHelper={responseBuilder:function(e){for(var t=[],s=0;s<e;s++){t.push({name:"user"+i,displayName:"User "+i,emailAddress:"user"+i+"@local",avatarUrls:{"16x16":""}});i++}return JSON.stringify(t)},scroll:function(e,t){e[0].scrollTop=t*e[0].scrollHeight/100;e.trigger("scroll")},respondWith:function(e){s.last(t).respond(200,{"Content-Type":"application/json"},this.responseBuilder(e))},urlFromLastRequest:function(){var e=s.last(t);return"object"===(void 0===e?"undefined":_typeof(e))?e.url:""},parseQueryString:function(e){return s.object(e.split("&").map((function(e){return e.split("=")})))},paramsFromLastRequest:function(){return this.parseQueryString(this.urlFromLastRequest().split("?")[1])}}},tearDown:function(){this.fixture.innerHTML="";this.xhr.restore();this.requests=[]}});test("Selecting invalid Automatic assignee",(function(){var e=r(this.fixture,!1),s=new t({element:e,editValue:"-1"});ok(!s.$container.hasClass("aui-ss-editing"),"input should not be in edit mode");equal(s.$field.val(),"Automatic",'"Automatic" assignee should be displayed as string label')}));test("It should fetch the assignee list when the picker is opened",(function(){var e=r(this.fixture,!1),s=new t({element:e});sinon.spy(s.suggestionsHandler.descriptorFetcher,"execute");s._handleCharacterInput.call(s,!0);ok(s.suggestionsHandler.descriptorFetcher.execute.calledOnce,"AJAX called when the picker is opened");equal(this.testHelper.paramsFromLastRequest().maxResults,100,"Fetches first items");this.testHelper.respondWith(50);equal(s.listController.getAllItems().length,53,"Display 53  (3 suggestions + 50 new items)")}));test("It should debounce calls to the server",(function(){var e=r(this.fixture,!1),s=new t({element:e}),i=sinon.useFakeTimers();s.$field.val("a");s._handleCharacterInput();s.$field.val("ab");s._handleCharacterInput();s.$field.val("abc");s._handleCharacterInput();equal(this.requests.length,0,"Requests are not made immediately");i.tick(300);this.testHelper.respondWith(50);equal(this.requests.length,1,"Server is called once");i.restore()}));[{description:"call the proper URL when legacy endpoint is used and assigneeEditIssueKey is not present",newEndpoint:!1,hasIssueKey:!1,expectedUrl:"/rest/api/latest/user/assignable/multiProjectSearch",expectedIssueKey:void 0,expectedUsernameKey:"username",expectedProjectKeys:n},{description:"call the proper URL when new endpoint is used and assigneeEditIssueKey is not present",newEndpoint:!0,hasIssueKey:!1,expectedUrl:"/rest/internal/2/users/assignee/multiProjectSearch",expectedIssueKey:void 0,expectedUsernameKey:"query",expectedProjectKeys:n},{description:"call the proper URL when legacy endpoint is used and assigneeEditIssueKey is present",newEndpoint:!1,hasIssueKey:!0,expectedUrl:"/rest/api/latest/user/assignable/search",expectedIssueKey:i,expectedUsernameKey:"username",expectedProjectKeys:n},{description:"call the proper URL when new endpoint is used and assigneeEditIssueKey is present",newEndpoint:!0,hasIssueKey:!0,expectedUrl:"/rest/internal/2/users/assignee",expectedIssueKey:i,expectedUsernameKey:"query",expectedProjectKeys:void 0}].forEach((function(s){test(""+s.description,(function(){var i=r(this.fixture,s.newEndpoint,s.hasIssueKey),n=new t({element:i}),a=sinon.useFakeTimers();n.$field.val("abc");n._handleCharacterInput();a.tick(300);ok(this.testHelper.urlFromLastRequest().includes(s.expectedUrl),"Uses the proper URL");equal(this.testHelper.paramsFromLastRequest().issueKey,s.expectedIssueKey,"issueKey param is set correctly");equal(this.testHelper.paramsFromLastRequest()[s.expectedUsernameKey],"abc",s.expectedUsernameKey+" param is set");equal(this.testHelper.paramsFromLastRequest().projectKeys,s.expectedProjectKeys,"projectKeys param is set correctly");a.restore();this.fixture.innerHTML="";this.fixture=e("#qunit-fixture")}))}));test("It should NOT send request to server when user keeps clicking on the field",(function(){var e=r(this.fixture,!1),i=new t({element:e}),n=i.$container.find("#assignee-field");sinon.spy(i.suggestionsHandler.descriptorFetcher,"execute");stop();s.delay(function(){n.click();this.testHelper.respondWith(50);ok(i.suggestionsHandler.descriptorFetcher.execute.calledOnce,"Click on assignee field for the 1st time, request was sent to retrieve data");n.click();ok(i.suggestionsHandler.descriptorFetcher.execute.calledOnce,"Click on assignee field for the 2nd time, NO request was sent");n.click();ok(i.suggestionsHandler.descriptorFetcher.execute.calledOnce,"Click on assignee field for the 3rd time, NO request was sent");start()}.bind(this),100)}));test("It should NOT deduplicate results",(function(){var e=r(this.fixture,!1),s=new t({element:e});notOk(s.options.removeDuplicates,"Assignee picker does not deduplicate the results");ok(s.options.disableRemoveSelected,"Assignee picker does not remove selected options from results")}))}));