AJS.test.require(["jira.webresources:key-commands","jira.webresources:dropdown"],(function(){"use strict";var e,t,i,o,n=require("jquery");module("Dropdown Menus",{setup:function(){this.clock=sinon.useFakeTimers();t=n("<a id='trigger' href='#whoops'>Trigger</a>").appendTo("#qunit-fixture");e=n("<div id='dropDown' class='aui-list'><ul id='list_id'><li><a id='test-link-1' href='/test/path/1'>Test 1</a></li><li><a id='test-link-2' href='/test/path/2'>Test 2</a></li><li><a id='test-link-3' href='/test/path/3'>Test 3</a></li></ul></div>")},teardown:function(){this.clock.restore();n(".ajs-layer").remove();e.remove();t.remove()}});function s(e){return e.click?e.click():n(e).click()}function r(e){return e.focus?e.focus():n(e).focus()}function a(e,t){t=t||document;n(t).trigger({type:"keydown",keyCode:e,which:e})}test("Pressing enter on the trigger should open the dropdown and not follow the trigger's link",(function(){t.appendTo(document.body);AJS.Dropdown.create({content:e,trigger:t});equal(e.is(":visible"),!1,"should not be visible upon creation");r(t);a(13,t);equal(e.is(":visible"),!0,"should be visible when the enter key is pressed on the trigger");equal(window.location.hash,"","the URL hash should not have changed to '#whoops' as a result of activating the trigger")}));test("Activating trigger multiple times should toggle the dropdown in a human-friendly way",(function(){t.appendTo(document.body);AJS.Dropdown.create({content:e,trigger:t,stopClickEventPropagation:!1});equal(e.is(":visible"),!1,"should not be visible upon creation");a(13,t);a(13,t);equal(e.is(":visible"),!0,"should be visible despite interacting with the toggle twice");this.clock.tick(4);a(13,t);equal(e.is(":visible"),!1,"should disappear after the second interaction");this.clock.tick(4);s(t);a(13,t);s(t)}));test("Pressing enter on a trigger should focus the dropdown content container when opened",(function(){t.appendTo(document.body);AJS.Dropdown.create({content:e,trigger:t});r(t);a(13,t);equal(n("#dropDown").get(0)===document.activeElement,!0,"focus should be on the dropdown content container")}));test("Pressing enter on a trigger for an autofocus dropdown should focus the first dropdown item when opened",(function(){t.appendTo(document.body);AJS.Dropdown.create({content:e,trigger:t,focusFirstItem:!0});r(t);a(13,t);equal(t.get(0)===document.activeElement,!1,"focus should not be on the trigger because this dropdown is an auto-focus dropdown");equal(n("#test-link-1").get(0)===document.activeElement,!0,"focus should be on the first menu item")}));test("Pressing escape while keyboard focus is inside the dropdown should return focus to the trigger",(function(){t.appendTo(document.body);AJS.Dropdown.create({content:e,trigger:t});r(t);a(13,t);a(40);equal(document.activeElement===document.getElementById("test-link-1"),!0,"the first dropdown item should be focussed");this.clock.tick(4);a(27);equal(document.activeElement===t.get(0),!0,"the dropdown's trigger should be focussed")}));test("Clicking outside the dropdown should NOT return focus to the trigger",(function(){var i=n("<textarea>Click me!</textarea>").appendTo("#qunit-fixture");t.appendTo(document.body);AJS.Dropdown.create({content:e,trigger:t});r(t);a(13,t);a(40);equal(document.activeElement===document.getElementById("test-link-1"),!0,"the first dropdown item should be focussed");this.clock.tick(4);s(i.get(0));equal(document.activeElement===t.get(0),!1,"the dropdown's trigger should NOT be focussed")}));module("Dropdown Menu Items",{setup:function(){t=n("<button type='button' id='trigger'>Trigger</button>").appendTo("#qunit-fixture")},teardown:function(){n(".ajs-layer").remove();e.remove();t.remove()}});test("All the links have tabindex='0' for them to be focusable even if they don't have href",(function(){e=n("<div id='dropDown' class='aui-list'><ul id='list_id'><li id='list-entry-1'><a id='test-link-1' href='/test/path/1'>Test 1</a></li><li id='list-entry-2'><a id='test-link-2'>Test 2</a></li></ul></div>");AJS.Dropdown.create({content:e,trigger:t});r(t);a(13,t);var i=!1;n("#dropDown a").each((function(){"0"!==n(this).attr("tabindex")&&(i=!0)}));equal(i,!1,"all the links are focusable")}));test("An arrow keypress does not select hidden list entries",(function(){e=n("<div id='dropDown' class='aui-list'><ul id='list_id'><li id='visible-list-entry'><a id='test-link-1' href='/test/path/1'>Test 1</a></li><li id='hidden-list-entry' class='hidden'><a id='test-link-2' href='/test/path/2'>Test 2</a></li></ul></div>");AJS.Dropdown.create({content:e,trigger:t});s(t);a(40);equal(n("#visible-list-entry").hasClass("active"),!0,"First LI has active class when down pressed once.");equal(n("#visible-list-entry").find("a").get(0)===document.activeElement,!0,"Menu item link should have document focus");a(40);equal(n("#hidden-list-entry").hasClass("active"),!1,"Hidden LI doesn't have active class when down pressed twice.");equal(n("#hidden-list-entry").find("a").get(0)===document.activeElement,!1,"Hidden LI should not have document focus.")}));test("An arrow keypress does not select nested list entries",(function(){e=n("<div id='dropDown'><ul id='nested_list_id'><li id='first-level-list-entry-1'><ul><li id='nested-list-entry'><a id='test-link-1' href='/test/path/1'>Test 1</a></li></ul></li><li id='first-level-list-entry-2'><a id='test-link-2' href='/test/path/2'>Test 2</a></li></ul></div>");AJS.Dropdown.create({content:e,trigger:t});s(t);a(40);equal(n("#nested-list-entry").hasClass("active"),!1,"Nested LI does not have active class when down pressed once.");equal(n("#first-level-list-entry-1").hasClass("active"),!0,"Top level LI has active class when down pressed once.");a(40);ok(n("#first-level-list-entry-2").hasClass("active"),"Second top level LI has active class when down pressed twice.");ok(n("#first-level-list-entry-2").find("a").get(0)===document.activeElement,!0,"Second menu item should have document focus when down pressed twice.")}));test("An arrow keypress does not select an list entry with no anchor",(function(){e=n("<div id='dropDown'><ul id='nested_list_id'><li id='empty-first-level-list-entry'><ul></ul></li><li id='first-level-list-entry-1'><a id='test-link-1' href='/test/path/1'>Test 1</a></li></ul></div>");AJS.Dropdown.create({content:e,trigger:t});s(t);a(40);equal(n("#empty-first-level-list-entry").hasClass("active"),!1,"Empty LI does not have active class when down pressed.");equal(n("#first-level-list-entry-1").hasClass("active"),!0,"First level LI has active class when down pressed once.");equal(n("#first-level-list-entry-1").find("a").get(0)===document.activeElement,!0,"First level menu item should have document focus when down pressed once.")}));module("Dropdown events propagation",{setup:function(){i=!1;o=!1;this.clock=sinon.useFakeTimers();t=n("<a id='trigger' href='#whoops'>Trigger</a>").appendTo(document.body);e=n("<div id='dropDown' class='aui-list'><ul id='list_id'><li><a id='test-link-1' href='/test/path/1'>Test 1</a></li><li><a id='test-link-2' href='/test/path/2'>Test 2</a></li><li><a id='test-link-3' href='/test/path/3'>Test 3</a></li></ul></div>");n("body").on("click",(function(){i=!0}));n("body").on("keydown",(function(e){"Escape"===e.key&&(o=!0)}))},teardown:function(){this.clock.restore();n(".ajs-layer").remove();e.remove();t.remove();n("body").off()}});test("Click event on trigger is not propagated if stopTriggerClickPropagation is set to true",(function(){AJS.Dropdown.create({content:e,trigger:t,stopTriggerClickPropagation:!0});s(t);this.clock.tick(4);equal(i,!1,"Click event is not propagated")}));test("Click event on trigger is propagated if stopTriggerClickPropagation is set to false",(function(){AJS.Dropdown.create({content:e,trigger:t,stopTriggerClickPropagation:!1});s(t);this.clock.tick(4);equal(i,!0,"Click event is propagated")}));test("Click event on trigger is propagated if stopTriggerClickPropagation is not set",(function(){AJS.Dropdown.create({content:e,trigger:t});s(t);this.clock.tick(4);equal(i,!0,"Click event is propagated")}));test("Escape keydown event on content is not propagated if stopEscapePropagation is set to true",(function(){AJS.Dropdown.create({content:e,trigger:t,stopEscapePropagation:!0});s(t);e.trigger(n.Event("keydown",{key:"Escape"}));this.clock.tick(4);equal(o,!1,"Escape keydown event is not propagated")}));test("Escape keydown event on content is propagated if stopEscapePropagation is set to false",(function(){AJS.Dropdown.create({content:e,trigger:t,stopEscapePropagation:!1});s(t);e.trigger(n.Event("keydown",{key:"Escape"}));this.clock.tick(4);equal(o,!0,"Escape keydown event is propagated")}));test("Escape keydown event on content is not propagated if stopEscapePropagation is not set",(function(){AJS.Dropdown.create({content:e,trigger:t});s(t);e.trigger(n.Event("keydown",{key:"Escape"}));this.clock.tick(4);equal(o,!1,"Escape keydown event is not propagated")}))}));