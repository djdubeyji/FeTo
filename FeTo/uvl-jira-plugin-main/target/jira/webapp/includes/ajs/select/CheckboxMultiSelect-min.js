define("jira/ajs/select/checkbox-multi-select",["jira/util/formatter","jira/util/key-code","jira/ajs/select/queryable-dropdown-select","jira/ajs/select/select-helper","jira/ajs/select/select-model","jira/ajs/select/suggestions/checkbox-multi-select-suggest-handler","jira/ajs/list/list","jira/util/events","jira/util/events/types","jquery","underscore"],(function(e,t,i,n,s,o,l,r,a,c,d){"use strict";return i.extend({init:function(e){var t=this;e.shouldNotAddAriaAttributesForSearchField=!0;this.changeFocusAfterSelect=!1!==e.changeFocusAfterSelect;c.extend(this,n);this._setOptions(e);if(!c(this.options.element).attr("multiple"))throw"Cannot create CheckboxMultiSelect without multiple-select select element.";this.options.element=c(this.options.element).hide();this.model=new s({element:this.options.element,removeOnUnSelect:this.options.removeOnUnSelect});var i=this.options.suggestionsHandler?this.options.suggestionsHandler:o;this.suggestionsHandler=new i(this.options,this.model);this.options.element.bind("updateOptions",(function(){t._setOptions(e)})).bind("selectOption",(function(e,i){t.selectItem(i)})).bind("removeOption",(function(e,i){t.unselectItem(i)})).bind("clear",(function(){t.clear()}));this._createFurniture();this._createDropdownController();this._createListController();this._assignEventsToFurniture();this.render();this.model.$element.addClass("check-list-select-select").trigger("initialized",[this]);r.trigger(a.CHECKBOXMULITSELECT_READY,[this.model.$element,this]);return this},_createListController:function(){var e=this;this.listController=new l({stallEventBind:this.options.stallEventBind,containerSelector:c(".aui-list",this.$container),scrollContainer:".aui-list-scroll",selectionEvent:"change",delegateTarget:this.$field,hasLinks:!1,suggestionsListRole:"list",itemSelector:".check-list-item",groupSelector:"ul.aui-list-section",matchingStrategy:this.options.matchingStrategy,maxInlineResultsDisplayed:this._getMaxInlineResultsDisplayed(),maxResultsDisplayedPerGroup:this.options.maxResultsDisplayedPerGroup,expandAllResults:this.options.expandAllResults,renderers:this._getCustomRenders(),selectionHandler:function(t){var i;i="change"===t.type?c(t.target).closest(this.options.itemSelector):this.getFocused();e._selectionHandler(i);return!1},prioritizeExactMatches:this.options.prioritizeExactMatches,hideSuggestionCount:this.options.hideSuggestionCount});this.$container.find(".aui-list").removeAttr("tabindex").removeAttr("role")},_createDropdownController:function(){this.dropdownController={show:c.noop,setWidth:c.noop,setPosition:c.noop,hide:c.noop}},_getCustomRenders:function(){return{suggestion:this._renders.suggestionItem,suggestionItemElement:this._renders.suggestionItemElement.bind(this),suggestionItemResolver:this._renders.suggestionItemResolver.bind(this)}},_announceResultsCount:d.debounce((function(t,i){i.html(e.I18n.getText("generic.multipicker.search.input.description",t))}),600),_handleCharacterInput:function(e){c.each(this.listController.$container.find(".invalid-item"),(function(){c(this).tipsy("hide")}));this.requestSuggestions(e).done(d.bind((function(e){this._setSuggestions(e);this._announceResultsCount(this.listController.items.length,this.$fieldAnnouncement)}),this));this.$dropDownIcon.toggleClass("clear-field aui-iconfont-remove",!!this.getQueryVal());this.$dropDownIcon.toggleClass("aui-iconfont-search",!this.getQueryVal());this.listController.moveToFirst()},_getDefaultOptions:function(){return c.extend(!0,this._super(),{errorMessage:e.I18n.getText("jira.ajax.autocomplete.error"),stallEventBind:!0})},_createFurniture:function(){var e=this.model.$element.attr("id");this.$container=this._render("container",e);this.$fieldContainer=this._render("fieldContainer").appendTo(this.$container);this.$fieldAnnouncement=this._render("fieldAnnouncement").appendTo(this.$fieldContainer);this.$field=this._render("field",e,this._getPlaceholderText()).appendTo(this.$fieldContainer);var t=this._render("suggestionsContainer",e);this.suggestionsContainerId=t.attr("id");this.$container.append(t);this.$container.insertBefore(this.model.$element);this.$dropDownIcon=this._render("dropdownAndLoadingIcon").appendTo(this.$fieldContainer)},_getPlaceholderText:function(){var t=c.trim(this.model.$element.data("placeholder-text"));return t&&""!==t?t:e.I18n.getText("common.concepts.search")},_getMaxInlineResultsDisplayed:function(){return this.options.maxInlineResultsDisplayed||parseInt(this.model.$element.data("max-inline-results-displayed"),10)||void 0},_assignEventsToFurniture:function(){var e=this;this._assignEvents("body",document);this.options.stallEventBind?window.setTimeout((function(){e._assignEvents("field",e.$field)._assignEvents("keys",e.$field)._assignEvents("container",e.$container)._assignEvents("fieldIcon",e.$dropDownIcon)}),0):e._assignEvents("field",e.$field)._assignEvents("keys",e.$field)._assignEvents("fieldIcon",e.$dropDownIcon);this.listController.$container.delegate(".clear-all","click",(function(t){t.preventDefault();var i=c(t.target);if(!i.hasClass("disabled")){i.parent().remove();e.clear()}}));this.listController.bind("itemFocus",this._onItemFocus.bind(this))},clear:function(){var e=this,t=this.model.getDisplayableSelectedDescriptors();this.model.setAllUnSelected();if(0===this.$field.val().length){this.$field.val("");this.listController.$container.find(":checkbox").removeAttr("checked")}else{this.clearQueryField();this.listController.moveToFirst()}this._toggleClearButton();c.each(t,(function(){e.model.$element.trigger("unselect",[this,e,!0])}));var i=new CustomEvent("clearall",{bubbles:!0,detail:{component:"checkboxmultiselect"}});this.options.element[0].dispatchEvent(i)},clearQueryField:function(){this.$field.val("");this._handleCharacterInput(!0);this.$field.focus()},unselectItem:function(e){this.model.setUnSelected(e);this.model.$element.trigger("unselect",[e,this,!1]);var t=new CustomEvent("unselect",{bubbles:!0,detail:{id:e.properties.value,name:e.properties.label,component:"checkboxmultiselect"}});this.options.element[0].dispatchEvent(t);this.$container.find(".aui-list input[type=checkbox]").each((function(){this.value===e.value()&&(this.checked=!1)}))},showLoading:function(){this.$dropDownIcon.addClass("loading").removeClass("noloading");return this},hideLoading:function(){this.$dropDownIcon.removeClass("loading").addClass("noloading");return this},_handleEscape:function(e){var i=this.$field;if("keydown"===e.type&&""!==i.val()){e.stopPropagation();i.val("");i.on("keyup",(function e(n){if(n.keyCode===t.ESCAPE){n.stopPropagation();i.off("keyup",e)}}));this._handleCharacterInput(!0)}},selectItem:function(e,t){this.model.setSelected(e);if(!t){this.model.$element.trigger("selected",[e,this]);var i=new CustomEvent("selected",{bubbles:!0,detail:{id:e.properties.value,name:e.properties.label,component:"checkboxmultiselect"}});this.options.element[0].dispatchEvent(i)}this.$container.find(".aui-list input[type=checkbox]").each((function(){this.value===e.value()&&(this.checked=!0)}))},_selectionHandler:function(e){var t=this;e.each((function(){var e=c.data(this,"descriptor"),i=c(this).find(":input");t._setDescriptorSelection(e,i)}));this._toggleClearButton()},_toggleClearButton:function(){var e=this.model.getSelectedValues().length>0;this.listController.$container.find(".clear-all").attr("tabindex",e?null:-1).closest(".check-list-group-actions").toggleClass("hidden",!e)},_setDescriptorSelection:function(e,t){if(e.selected()){this.unselectItem(e);t.removeAttr("checked")}else{this.selectItem(e);t.attr("checked","checked")}},render:function(){this._handleCharacterInput(!0)},_events:{field:{keydown:function(e){if(e.keyCode===t.ENTER){e.preventDefault();var i=this;this.model.$element.bind("unselect selected",n);setTimeout((function(){i.model.$element.unbind("unselect selected",n)}),0)}function n(){if(""!==c.trim(i.$field.val())){i.$field.val("");i._handleCharacterInput(!0)}}}},fieldIcon:{click:function(e){c(e.target).hasClass("clear-field")&&this.clearQueryField()}}},_renders:{errorMessage:function(e){return c('<div class="error" />').attr("id",e+"-error")},fieldContainer:function(){return c("<div class='check-list-field-container' />")},fieldAnnouncement:function(){return c("<div class='assistive' aria-live='polite'></div>")},field:function(e,t){var i=this._render("baseField").attr({placeholder:t,class:"text",id:e+"-input"});this.options.ariaLabel&&i.attr("aria-label",this.options.ariaLabel);return i},disableSelectField:function(e){return c("<input type='text' class='long-field' />").attr({name:e,id:e})},container:function(e){return c('<div class="check-list-select" />').attr("id",e+"-multi-select")},suggestionItemElement:function(e,t){var i=d.escape(e.value()),n=e.icon(),s=n&&"none"!==n,o=e.fallbackIcon(),l=d.escape(e.title()),r=t||e.html()||d.escape(e.label()),a=e.selected(),h=e.styleClass(),u=e.disabled(),p="";s&&(p="<img src="+n+" \n                    "+(o&&"none"!==o?" onerror=\"this.onerror=null;this.src='"+o+"';\"":"")+" \n                    loading='lazy' \n                    alt='' \n                    height='16' width='16' \n                    class='icon"+("rounded"===e.iconType()?" rounded":"")+"' \n                    align='absmiddle' />");return c("\n                    <li class='check-list-item"+(u?" disabled":"")+" "+(h||"")+"' id='"+i+"-"+this.options.id+"'>\n                    <label class='item-label checkbox' original-title='"+l+"' data-descriptor-title='"+l+"'>\n                        <input type='checkbox'"+(u?' disabled="disabled"':"")+" value='"+i+"'"+(a?" checked='checked'":"")+" />\n                        "+p+"\n                        "+r+"\n                    </label>\n                    </li>")},suggestionItemResolver:function(e,t){return this._render("suggestionItemElement",e,t)},suggestionItem:function(t,i){var n,s=this._render("suggestionItemResolver",t,i),o=s.find("label");if(t.invalid()||t.disabled()){s.addClass("has-invalid-item");o.append("<span class='invalid-item'></span>");n=o.find(".invalid-item");var l;if(t.title()){l=t.title();o.attr("original-title",l);o.removeAttr("title")}else l=e.I18n.getText("jira.search.context.invalid.generic",e.I18n.getText("common.concepts.value"),t.label());n.tipsy({title:function(){return l},className:"tipsy-front",trigger:"manual"});n.hoverIntent({interval:200,over:function(){n.tipsy("show")},out:function(){n.tipsy("hide")}})}return s.data("descriptor",t)},dropdownAndLoadingIcon:function(){return c('<span class="icon-default aui-icon aui-icon-small aui-iconfont-search noloading"></span>')}},handleFreeInput:c.noop,hideSuggestions:c.noop,showErrorMessage:c.noop,_deactivate:c.noop})}));AJS.namespace("AJS.CheckboxMultiSelect",null,require("jira/ajs/select/checkbox-multi-select"));