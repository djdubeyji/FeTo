define("jira/ajs/select/queryable-dropdown-select",["jira/util/formatter","jira/jquery/deferred","jira/ajs/control","jira/ajs/select/suggestions/default-suggest-handler","jira/ajs/layer/inline-layer-factory","jira/ajs/list/list","jira/util/key-code","jira/util/navigator","jira/util/assistive","jquery","underscore"],(function(t,i,e,s,n,o,r,a,d,l,h){"use strict";var u="-suggestions",c=0;return e.extend({INVALID_KEYS:{Shift:!0,Esc:!0,Right:!0},init:function(t){this.suggestionsVisible=!1;this._setOptions(t);this._createFurniture();this._createDropdownController();this._createSuggestionsController();this._createListController();this._assignEventsToFurniture();this.options.width&&this.setFieldWidth(this.options.width);this.options.loadOnInit&&this.requestSuggestions(!0)},_createDropdownController:function(){var t=this;this.options.dropdownController?this.dropdownController=this.options.dropdownController:this.dropdownController=n.createInlineLayers({offsetTarget:this.$field,width:this.$field.innerWidth(),content:this.options.element});this.dropdownController.onhide((function(){t.hideSuggestions()}))},_createSuggestionsController:function(){var t=this.options.suggestionsHandler?this.options.suggestionsHandler:s;this.suggestionsHandler=new t(this.options)},_createListController:function(){var i=this;this.listController=new o({containerSelector:this.options.element,groupSelector:"ul.aui-list-section",matchingStrategy:this.options.matchingStrategy,eventTarget:this.$field,selectionHandler:function(){i.$field.val(t.I18n.getText("common.concepts.loading")).css("color","#999");i.hideSuggestions();return!0}})},_onItemFocus:function(t,i){var e=this.$field,s=i&&i.id?i.id:"null";this.options.shouldNotAddAriaAttributesForSearchField||d.wait((function(){e.attr("aria-activedescendant",s)}))},setFieldWidth:function(t){this.$container.css({width:t,minWidth:t})},showErrorMessage:function(i){var e=this.$container.parent(".field-group");this.hideErrorMessage();this.$errorMessage.text(t.format(this.options.errorMessage,i||this.getQueryVal()));if(1!==e.length){0===e.length&&(e=this.$container.parent(".frother-control-renderer"));1!==e.length?0===e.length&&this.$container.parent().append(this.$errorMessage):this.$errorMessage.prependTo(e)}else e.append(this.$errorMessage)},hideErrorMessage:function(){this.$errorMessage&&this.$errorMessage.remove();this.$container.parent().find(".error").remove()},hideAriaInvalid:function(){this.$field.attr("aria-invalid")&&this.$field.removeAttr("aria-invalid")},hideAriaDescribedBy:function(){this.$field.attr("aria-describedby")&&this.$field.removeAttr("aria-describedby")},_getDefaultOptions:function(){return{id:c+=1}},_createFurniture:function(){this.$container=this._render("container").insertBefore(this.options.element);this.suggestionsContainerId=this.options.id+u;this.$field=this._render("field").appendTo(this.$container);this.$dropDownIcon=this._render("dropdownAndLoadingIcon",this._hasDropdownButton()).appendTo(this.$container);if(this.options.overlabel){this.$overlabel=this._render("overlabel").insertBefore(this.$field);this.$overlabel.overlabel()}},_hasDropdownButton:function(){return this.options.showDropdownButton||this.options.ajaxOptions&&0===this.options.ajaxOptions.minQueryLength},_assignEventsToFurniture:function(){var t=this;this._assignEvents("ignoreBlurElement",this.dropdownController.$layer);this._assignEvents("container",this.$container);if(this._hasDropdownButton()){this._assignEvents("ignoreBlurElement",this.$dropDownIcon);this._assignEvents("dropdownAndLoadingIcon",this.$dropDownIcon)}setTimeout((function(){t._assignEvents("field",t.$field);t._assignEvents("keys",t.$field)}),15);this.listController.bind("itemFocus",this._onItemFocus.bind(this))},requestSuggestions:function(t){var e=this,s=new i;this.outstandingRequest=this.suggestionsHandler.execute(this.getQueryVal(),t).done((function(t,i){i===e.getQueryVal()&&s.resolve(t,i)}));if("resolved"!==this.outstandingRequest.state()){window.clearTimeout(this.loadingWait);this.loadingWait=window.setTimeout((function(){"pending"===e.outstandingRequest.state()&&e.showLoading()}),150);this.outstandingRequest.always((function(){e.hideLoading()}))}return s},showLoading:function(){this.$dropDownIcon.addClass("loading").removeClass("noloading");this.$dropDownIcon.data("spinner")||this.$dropDownIcon.spin();this.$field.attr("aria-busy","true");return this},hideLoading:function(){this.$dropDownIcon.removeClass("loading").addClass("noloading");this.$dropDownIcon.spinStop();this.$field.attr("aria-busy","false");return this},_setSuggestions:function(t){if(t){this.listController.generateListFromJSON(t,this.getQueryVal());this.showSuggestions()}else this.hideSuggestions();this.$container.attr("data-query",this.getQueryVal())},disable:function(){if(!this.disabled){this.$container.addClass("aui-disabled");this.$disabledBlanket=this._render("disabledBlanket").appendTo(this.$container);this.$field.prop("disabled",!0);this.dropdownController.hide();this.disabled=!0}},enable:function(){if(this.disabled){this.$container.removeClass("aui-disabled");this.$disabledBlanket.remove();this.$field.prop("disabled",!1);this.disabled=!1}},getQueryVal:function(){return l.trim(this.$field.val())},_isValidInput:function(t){return this.$field.is(":visible")&&!("aui:keydown"===t.type&&this.INVALID_KEYS[t.key])},_handleCharacterInput:function(t){this.getQueryVal().length>=1||t?this.requestSuggestions(t).done(h.bind((function(t){this._setSuggestions(t)}),this)):this.hideSuggestions()},_handleDown:function(t){if(!this.suggestionsVisible){this.listController._latestQuery="";this._handleCharacterInput(!0)}t.preventDefault()},_rejectPendingRequests:function(){this.outstandingRequest&&this.outstandingRequest.reject()},showSuggestions:function(){if(!this.suggestionsVisible){this.suggestionsVisible=!0;this.dropdownController.show();this.dropdownController.setWidth(this.$field.innerWidth());this.dropdownController.setPosition();this.listController.enable();if(!this.options.shouldNotAddAriaAttributesForSearchField){this.$field.attr("aria-expanded","true");this.$field.attr("aria-controls",this.suggestionsContainerId);this.$field.attr("aria-owns",this.suggestionsContainerId)}}},hideSuggestions:function(){if(this.suggestionsVisible){this._rejectPendingRequests();this.suggestionsVisible=!1;this.$dropDownIcon.addClass("noloading");this.dropdownController.hide();this.listController.disable();if(!this.options.shouldNotAddAriaAttributesForSearchField){this.$field.removeAttr("aria-activedescendant");this.$field.attr("aria-expanded","false");this.$field.removeAttr("aria-controls");this.$field.removeAttr("aria-owns")}}},_deactivate:function(){this.hideSuggestions()},_handleEscape:function(t){if(this.suggestionsVisible){t.stopPropagation();if("keyup"===t.type){this.hideSuggestions();a.isIE()&&a.majorVersion()<12&&this.$field.focus()}}},acceptFocusedSuggestion:function(){var t=this.listController.getFocused();0!==t.length&&t.is(":visible")&&this.listController._acceptSuggestion(t)},keys:{Down:function(t){this._hasDropdownButton()&&this._handleDown(t)},Up:function(t){t.preventDefault()},Return:function(t){t.preventDefault()}},onEdit:function(){this._handleCharacterInput()},_events:{dropdownAndLoadingIcon:{click:function(t){if(this.suggestionsVisible)this.hideSuggestions();else{this._handleDown(t);this.$field.focus()}t.stopPropagation()}},container:{disable:function(){this.disable()},enable:function(){this.enable()}},field:{blur:function(){this.ignoreBlurEvent?this.ignoreBlurEvent=!1:this._deactivate()},click:function(t){t.stopPropagation()},"keydown keyup":function(t){t.keyCode===r.ESCAPE&&this._handleEscape(t)}},keys:{"aui:keydown input":function(t){this._handleKeyEvent(t)}},ignoreBlurElement:{mousedown:function(t){if(a.isIE()&&a.majorVersion()<12){l(t.target)[0]==l(this.dropdownController.$layer)[0]&&(this.ignoreBlurEvent=!0)}t.preventDefault()}}},_renders:{disabledBlanket:function(){return l("<div class='aui-disabled-blanket' />").height(30)},overlabel:function(){return l("<span class='overlabel' />").text(this.options.overlabel).attr({"data-target":this.options.id+"-field",id:this.options.id+"-overlabel"})},baseField:function(t){var i=document.createElement(t||"input"),e=l(i).attr({autocomplete:"off"});this.options.shouldNotAddAriaAttributesForSearchField||e.attr({role:"combobox","aria-autocomplete":"list","aria-expanded":"false"});return e},field:function(){var t=this._render("baseField").attr({class:"text",id:this.options.id+"-field",type:"text"});this.options.ariaLabel&&t.attr("aria-label",this.options.ariaLabel);this.options.ariaDescribedBy&&t.attr("aria-describedby",this.options.ariaDescribedBy);return t},container:function(){return l("<div class='queryable-select' />").attr("id",this.options.id+"-queryable-container")},dropdownAndLoadingIcon:function(t){return l('<span class="icon noloading" tabindex="-1"></span>').toggleClass("drop-menu",!!t)},suggestionsContainer:function(t){return l("<div />").attr({class:"aui-list",id:t+u,tabindex:"-1"})}}})}));AJS.namespace("AJS.QueryableDropdown",null,require("jira/ajs/select/queryable-dropdown-select"));AJS.namespace("AJS.QueryableDropdownSelect",null,require("jira/ajs/select/queryable-dropdown-select"));