define("jira/setup/setup-license",["wrm/context-path","aui/message","jira/flag","jira/util/formatter","jira/util/data/meta","jira/jquery/deferred","jquery","underscore"],(function(e,t,n,r,i,a,s,o){"use strict";var u,c,l,f=e();function d(){!function(e,n){t.error("#formError",{title:e,body:n,closeable:!1});s("#formError").scrollIntoView()}(r.I18n.getText("setupLicense.error.unknown.title"),r.I18n.getText("setupLicense.error.unknown.desc","<a href='https://support.atlassian.com' target='_blank'>","</a>"))}return{startPage:function(){var e;(u=s(JIRA.Templates.LicenseSetup.renderExistingLicenseForm({serverId:i.get("server-id"),xsrfToken:s("input[name='atl_token']").val()}))).submit(o.compose((function(t){t.fail((function(){c.find(":submit").removeAttr("disabled");l.off("click");c.find(".throbber-message").remove()})).done((function(){!function(){s("#setupLicenseKey").val(e);s("#setupLicenseForm").submit()}()}))}),(function(t){v();var n=new a,r=function(e){var t={},n=e.serializeArray();s.each(n,(function(){if(void 0!==t[this.name]){t[this.name].push||(t[this.name]=[t[this.name]]);t[this.name].push(this.value||"")}else t[this.name]=this.value||""}));return t}(s(p(t))),i=function(e){var t=s("input[name='atl_token']").val();return s.ajax({url:f+"/secure/SetupLicense!validateLicense.jspa",data:{licenseToValidate:e,atl_token:t},type:"POST"})}(r.licenseKey);i.fail(m);i.fail((function(){n.reject()}));i.done((function(){e=r.licenseKey;n.resolve()}));return n}),(function(e){var t=r.I18n.getText("setupLicense.existing.license.spinner");s(p(e)).find(".throbbers-placeholder").append(JIRA.Templates.LicenseSetup.renderSpinner({msg:t}));return e}),(function(e){s(p(e)).find(":submit").attr("disabled","disabled");return e}),v,(function(e){e.preventDefault();return e}),(function(e){l.click((function(e){e.preventDefault()}));return e})));(l=u.find("#generate-mac-license")).attr("href",s("#mac-redirect").data("mac-redirect-url"));!function(){var e=s("#setupLicenseKey").val();if(e.trim()){setTimeout((function(){n.showSuccessMsg(r.I18n.getText("setupLicense.flag.title"),r.I18n.getText("setupLicense.flag.text"),{close:"auto"})}),1e3);u.find("#licenseKey").text(e)}}();c=s("#license-input-container");function p(e){return e.target}function m(e,n){if(403===e.status){var i=JSON.parse(e.responseText);!function(e,n){var r="";o.map(n,(function(e){r+=e+"<br />"}));t.error("#formError",{title:e,body:r,closeable:!1});s("#formError").scrollIntoView()}(r.I18n.getText("setup.importlicense.validation.failure.header"),i.errors)}else d()}function v(e){s(".error").remove();s(".warn").remove();return e}!function(){c.children().detach();c.append(u).removeClass("hidden")}()}}}));