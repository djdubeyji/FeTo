AJS.test.require("jira.webresources:jira-setup",(function(){var e=require("jquery"),i=require("underscore"),s=require("jira/setup/setup-account-view"),t=require("jira/flag"),n=sinon.assert,a=sinon.match,r={invalidEmail:"invalidEmail",emailRequired:"emailRequired",passwordRequired:"passwordRequired",usernameRequired:"usernameRequired",invalidUsername:"invalidUsername",tooLongUsername:"tooLongUsername",passwordRetypeRequired:"passwordRetypeRequired",passwordsDoNotMatch:"passwordsDoNotMatch"},o={successTitle:"successTitle",successContent:"successContent",errorTitle:"errorTitle",errorContent:"errorContent"},u=JIRA.Templates.Setup.Account.pageContent({productLicense:"SomeLicenseText",errorTextsJson:JSON.stringify(r),licenseFlagTextsJson:JSON.stringify(o)}),l=function(e,i){e.val(i);e.trigger("input");e.trigger("blur")},d=function(e){return e.siblings(".error")},h=function(e){var i=d(e);equal(i.hasClass("hidden"),!0,"Errors container is visible");return i},c=function(e){var i=d(e);equal(i.hasClass("hidden"),!1,"Errors container is not visible");return i},b=function(e){return c(e).html()};function m(i){e("#qunit-fixture").empty().append(e("<div></div>").addClass("jira-setup-basic-form").html(i))}module("JIRA Instant Setup Admin Account",{setup:function(){this.sandbox=sinon.sandbox.create({useFakeTimers:!0});this.sandbox.stub(t,"showSuccessMsg");m(u)},teardown:function(){this.sandbox.restore()},initializeView:function(){this.testObj=new s({el:".setup-account-view-container"});this.testObj.bindUIElements()}});test("submit button should be disabled when no license is present",(function(){m(JIRA.Templates.Setup.Account.pageContent({}));this.sandbox.stub(t,"showErrorMsg");this.initializeView();equal(this.testObj.ui.submitButton.is(":disabled"),!0,"submit button is disabled by default")}));test("error flag should be displayed when no license is present",(function(){m(JIRA.Templates.Setup.Account.pageContent({licenseFlagTextsJson:JSON.stringify(o)}));this.sandbox.stub(t,"showErrorMsg");this.initializeView();this.sandbox.clock.tick(s.FLAG_TIMEOUT-1);n.notCalled(t.showErrorMsg);this.sandbox.clock.tick(1);n.calledOnce(t.showErrorMsg);n.calledWith(t.showErrorMsg,o.errorTitle,o.errorContent,a({close:"never"}))}));test("submit button should be enabled when license is provided",(function(){this.initializeView();equal(this.testObj.ui.submitButton.is(":disabled"),!1,"submit button is enabled when license is present")}));test("success flag should be displayed when license is provided",(function(){this.initializeView();this.sandbox.clock.tick(s.FLAG_TIMEOUT-1);n.notCalled(t.showSuccessMsg);this.sandbox.clock.tick(1);n.calledOnce(t.showSuccessMsg);n.calledWith(t.showSuccessMsg,o.successTitle,o.successContent,a({close:"auto"}))}));test("errors are displayed on all fields when next button is pressed",(function(){this.initializeView();this.testObj.ui.submitButton.trigger("click");i.each(this.testObj.fields,(function(e,i){equal(d(this.testObj.ui[i]).hasClass("hidden"),!1,"Field "+i+" should have errors")}),this)}));test("email is required",(function(){this.initializeView();l(this.testObj.ui.email,"");equal(b(this.testObj.ui.email),r.emailRequired,"Email required information should be displayed")}));test("email is invalid",(function(){this.initializeView();i.each(["aString","aStringFinishingWith@","aStringWith@butEndsIn.","a string containing @ but also space"],i.bind((function(e){l(this.testObj.ui.email,e);equal(b(this.testObj.ui.email),r.invalidEmail,"Email invalid error should be displayed for email: "+e)}),this))}));test("username is required",(function(){this.initializeView();l(this.testObj.ui.username,"");equal(b(this.testObj.ui.username),r.usernameRequired,"Username required error should be displayed")}));test("username is too long",(function(){this.initializeView();l(this.testObj.ui.username,i.range(s.MAX_USERNAME_LEN+1).map((function(){return"x"})).join(""));equal(b(this.testObj.ui.username),r.tooLongUsername,"Username too long error should be displayed");l(this.testObj.ui.username,i.range(s.MAX_USERNAME_LEN).map((function(){return"x"})).join(""));h(this.testObj.ui.username)}));test("username is invalid",(function(){this.initializeView();i.each(["aStringContaining&","aStringContaining<","aStringContaining>","a string containing space"],i.bind((function(e){l(this.testObj.ui.username,e);equal(b(this.testObj.ui.username),r.invalidUsername,"Username invalid error should be displayed for username: "+e)}),this))}));test("email is propagated to username until it is edited",(function(){this.initializeView();l(this.testObj.ui.email,"charlie@atlassian.com");equal(this.testObj.ui.emailHidden.val(),"charlie@atlassian.com","Email is processed");equal(this.testObj.ui.username.val(),"charlie","Username should have been filled by partial email");l(this.testObj.ui.username,"will");l(this.testObj.ui.email,"emma@atlassian.com");equal(this.testObj.ui.emailHidden.val(),"emma@atlassian.com","Email is processed");equal(this.testObj.ui.username.val(),"will","Username is not changed if edited earlier")}));test("password is required",(function(){this.initializeView();l(this.testObj.ui.password,"");equal(b(this.testObj.ui.password),r.passwordRequired,"Password required error should be displayed")}));test("password retype is required",(function(){this.initializeView();l(this.testObj.ui.retypePassword,"");equal(b(this.testObj.ui.retypePassword),r.passwordRetypeRequired,"Password retype required error should be displayed")}));test("passwords must match",(function(){this.initializeView();l(this.testObj.ui.password,"pass1");l(this.testObj.ui.retypePassword,"pass2");equal(b(this.testObj.ui.retypePassword),r.passwordsDoNotMatch,"Passwords do not match should be displayed");h(this.testObj.ui.password);l(this.testObj.ui.password,"pass2");this.sandbox.clock.tick(s.VALIDATION_TIMEOUT);h(this.testObj.ui.retypePassword)}));test("errors are displayed with delay as long as user types only on fields touched by user",(function(){this.initializeView();this.testObj.ui.password.val("");this.testObj.ui.password.trigger("input");this.sandbox.clock.tick(s.VALIDATION_TIMEOUT-1);i.each(this.testObj.fields,(function(e,i){h(this.testObj.ui[i])}),this);this.testObj.ui.password.trigger("blur");c(this.testObj.ui.password);this.testObj.ui.email.val("someInvalidEmail@");this.testObj.ui.email.trigger("input");this.sandbox.clock.tick(s.VALIDATION_TIMEOUT-1);c(this.testObj.ui.password);h(this.testObj.ui.email);h(this.testObj.ui.username);h(this.testObj.ui.retypePassword);this.sandbox.clock.tick(1);c(this.testObj.ui.password);c(this.testObj.ui.email);h(this.testObj.ui.username);h(this.testObj.ui.retypePassword)}))}));