define("jira/wikipreview/wiki-preview",["jira/util/formatter","wrm/context-path","jquery"],(function(e,i,n){"use strict";return function(r,t){var s,a,o,d,l,c=!1,u={show:function(){l||(l=n("<div>").html("&nbsp;").css({height:"300px"}).insertBefore(a));l.css({display:"block"})},hide:function(){l.css({display:"none"})}},p=function(){if(c){a.find(".content-inner").css({maxHeight:""});this.showInput()}else{a.find(".content-inner").css({maxHeight:s.css("maxHeight")});this.showPreview()}},w=function(e){o.find(".wiki-renderer-icon").text(e)},f=function(i){a.originalHeight=a.height();u.show();a.addClass("previewClass");d=s.val();s.hide();o.removeClass("loading").addClass("selected");w(e.I18n.getText("renderer.preview.close",r.fieldId));a.find(".content-inner").html(i);u.hide();c=!0;n(document).trigger("showWikiPreview",[a]);setTimeout((function(){o.focus()}),0)};return{showPreview:function(){var e,a=n("#pid",t).val(),l=n("#issuetype",t).val();n.isArray(a)&&(a=a[0]);n.isArray(l)&&(l=l[0]);n("#"+r.trigger,t).addClass("loading");n.ajax({url:i()+"/rest/api/1.0/render",contentType:"application/json",type:"POST",data:JSON.stringify({rendererType:r.rendererType,unrenderedMarkup:s.val(),issueKey:r.issueKey,projectId:a,issueType:l}),dataType:"html",success:f,error:(e=this,function(i,n,r){o.removeClass("loading");d=s.val();n&&alert(n);r&&alert(r);e.showInput()})})},showInput:function(){if(a){u.show();a.css({height:""});a.removeClass("previewClass").find(".content-inner").empty();(s=n("#"+r.fieldId,t)).val(d);s.show();s.focus();o.removeClass("selected");w(e.I18n.getText("renderer.preview",r.fieldId));u.hide();c=!1;n(document).trigger("showWikiInput",[a])}},init:function(){var e,i=this;r instanceof n&&(r=n.readData(r));(e=n("#"+r.trigger,t)).click((function(d){if(!e.hasClass("loading")){!function(){s=n("#"+r.fieldId,t);a=n("#"+r.fieldId+"-wiki-edit",t);o=n("#"+r.trigger,t)}();p.call(i)}d.preventDefault()}))}}}}));AJS.namespace("jira.app.wikiPreview",null,require("jira/wikipreview/wiki-preview"));AJS.namespace("JIRA.wikiPreview",null,require("jira/wikipreview/wiki-preview"));