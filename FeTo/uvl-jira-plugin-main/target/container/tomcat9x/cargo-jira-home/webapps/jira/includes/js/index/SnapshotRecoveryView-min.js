define("jira/index/snapshot-recovery-view",["jquery","jira/autocomplete/snapshot-autocomplete","jira/ajs/ajax/smart-ajax","jira/backbone-1.3.3","jira/message","jira/moment","jira/util/data/meta","jira/moment/moment.jira.formatter","jira/analytics","wrm/context-path","jira/util/formatter"],(function(t,e,a,s,n,i,o,l,r,h,u){"use strict";var m=l.translateSimpleDateFormat(o.get("date-complete")),p="in-progress",c="unknown",d="none";return s.View.extend({el:"#index-recovery",events:{"click #create-index-snapshot":"onCreateSnapshotClick"},initialize:function(){this.$createButton=this.$el.find("#create-index-snapshot");this.$createInProgressMessage=this.$el.find("#create-index-snapshot-in-progress-message");this.$snapshotGenerationStatus=this.$el.find("#snapshot-generation-status");this.$lastSnapshotName=this.$el.find("#last-index-snapshot-name");this.$lastSnapshotDate=this.$el.find("#last-index-snapshot-date");this.pollingTimeoutDefaultValue=2e4;this.pollingTimeout=this.pollingTimeoutDefaultValue;this.initSnapshotAutoComplete();this.model=new s.Model({createStatus:c,lastSnapshotName:"",lastSnapshotDate:""});this.model.on("change:createStatus",this.onCreateStatusChange.bind(this));this.model.on("change:lastSnapshotName change:lastSnapshotDate",this.onLastSnapshotDetailChange.bind(this));this.pollCreateStatus();this.loadLastSnapshotDetails()},initSnapshotAutoComplete:function(){e({field:t("#index-recovery-file-name"),minQueryLength:0,queryDelay:0})},onCreateStatusChange:function(t,e){this.$createButton.prop("disabled",e===p);this.$createInProgressMessage.prop("hidden",e!==p);this.$snapshotGenerationStatus.html(e===p?u.I18n.getText("admin.index.status.in.progress"):u.I18n.getText("admin.index.status.ready"))},onLastSnapshotDetailChange:function(){this.$lastSnapshotName.html(this.model.get("lastSnapshotName"));var t=this.model.get("lastSnapshotDate");this.$lastSnapshotDate.html(t?i(this.model.get("lastSnapshotDate")).format(m):u.I18n.getText("common.concepts.not.applicable"))},onCreateSnapshotClick:function(){r.send({name:"admin.index.snapshot.create.click"});this.model.set("createStatus",p);this.pollingTimeout=1e3;a.makeRequest({method:"POST",url:h()+"/rest/api/2/index-snapshot",success:function(t){n.showSuccessMsg(u.I18n.getText("admin.index.create.in.progress",t.futureAbsolutePath),{closeable:!0,timeout:30})},error:function(t){409===t.status?n.showErrorMsg(u.I18n.getText("admin.index.create.blocked"),{closeable:!0,timeout:30}):n.showErrorMsg(u.I18n.getText("admin.index.create.error"),{closeable:!0,timeout:30})}})},loadLastSnapshotDetails:function(){var t=this;a.makeRequest({url:h()+"/rest/api/2/index-snapshot",success:function(e){var a=e.sort((function(t,e){return e.timestamp-t.timestamp}))[0];t.model.set({lastSnapshotDate:a?a.timestamp:null,lastSnapshotName:a?a.absolutePath:u.I18n.getText("common.concepts.not.applicable")})},error:function(){n.showErrorMessage(u.I18n.getText("admin.index.status.error"),{closeable:!0})}})},pollCreateStatus:function(){var t=this;a.makeRequest({method:"GET",url:h()+"/rest/api/2/index-snapshot/isRunning",success:function(e){var a=e.running;t.model.get("createStatus")===p&&!1===a&&t.loadLastSnapshotDetails();t.model.set("createStatus",a?p:d)},error:function(){t.model.set("createStatus",d)},complete:function(){setTimeout(t.pollCreateStatus.bind(t),t.getPollingTimeout())}})},getPollingTimeout:function(){this.pollingTimeout<this.pollingTimeoutDefaultValue&&(this.pollingTimeout*=2);this.pollingTimeout>this.pollingTimeoutDefaultValue&&(this.pollingTimeout=this.pollingTimeoutDefaultValue);return this.pollingTimeout}})}));