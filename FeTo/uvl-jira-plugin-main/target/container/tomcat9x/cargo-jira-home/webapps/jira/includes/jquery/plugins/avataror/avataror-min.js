jQuery.fn.avataror=function(i){var e=jQuery,t=e(document),r=require("underscore"),a=require("jira/util/assistive"),n=require("jira/util/formatter");this.each((function(){var h=e(this),d={},o=!1;function g(i){return i.key.startsWith("Arrow")}var s=h.find("img").attr("src");h.css({"-moz-border-radius":"10px","-webkit-border-radius":"10px"});h.html("<p>Loading?</p>");var w={previewSize:48};w.preview=e("<div/>").addClass("avataror-preview").css({border:"solid 1px #000",float:"left",height:w.previewSize+"px",overflow:"hidden",width:w.previewSize+"px",position:"relative",top:"-9999em",left:"-9999em"});w.preview.prependTo(i.previewElement);w.img=e('<img alt="Avatar Source"/>');w.img.load((function(){w.image=e("<div/>").css({background:"url('"+s+"') no-repeat",clear:"left",position:"relative"});w.marker=e("<div/>").css({cursor:"move",position:"relative"});w.dash=e("<div/>");w.shadow=e("<div/>");w.dash.add(w.shadow).css({cursor:"move",opacity:.5,left:0,top:0,position:"absolute"});w.image.append(w.shadow).append(w.dash).append(w.marker);h.append(w.image);w.marker.html("<div></div><div></div><div></div><div></div>");w.marker.attr({tabindex:0,"aria-label":n.I18n.getText("avatarpicker.cropper.aria.label"),"aria-describedby":"jira-avatar-cropper-keyboard-instructions"});e("div",w.marker).each((function(i){var t=e(this);t.css({background:"#000",border:"solid 1px #fff",width:"10px",height:"10px",position:"absolute","font-size":"1px"});t.css(["left","right","right","left"][i],"-6px");t.css(["top","top","bottom","bottom"][i],"-6px");t.css("cursor",["nw-resize","ne-resize","se-resize","sw-resize"][i]);t.mousedown((function(e){e.preventDefault();e.stopPropagation();w.dragging={x:e.pageX,y:e.pageY,ax:w.x,ay:w.y,w:w.width,h:w.height,i:i+1};w.shadow.hide()}))}));w.marker.add(w.image).mousedown((function(i){i.preventDefault();w.dragging={x:i.pageX,y:i.pageY,ax:w.x,ay:w.y,w:w.width,h:w.height};w.shadow.hide()}));t.mouseup((function(i){w.handleMouseUp(i)}));t.mousemove((function(i){if(w.dragging){w.handleMouseMove(i.pageX,i.pageY);i.preventDefault()}}));w.marker.keydown(w.handleKeyDown);w.marker.keyup(w.handleKeyUp);w.imgwidth=w.img[0].naturalWidth;w.imgheight=w.img[0].naturalHeight;w.x=parseInt(e("#avatar-offsetX").val());w.y=parseInt(e("#avatar-offsetY").val());w.width=parseInt(e("#avatar-width").val());w.height=w.width;w.image.css({width:w.imgwidth+"px",height:w.imgheight+"px"});w.setMarker();h.css({width:w.imgwidth+"px"});w.preview.css({position:"static"});e("p",h).remove();h.trigger("AvatarImageLoaded");w.adjustPreview()}));w.img.attr("src",s);w.preview.append(w.img);w.setMarker=function(){w.marker.css("border","dashed 1px #fff");w.dash.css("border","solid 1px #000");w.shadow.css("border","solid 1px #000");w.marker.add(this.dash).css("left",this.x-1+"px");w.marker.add(w.dash).css("top",w.y-1+"px");w.shadow.css("border-left-width",w.x+"px");w.shadow.css("border-right-width",w.imgwidth-w.x-w.width+"px");w.shadow.css("border-top-width",w.y+"px");w.shadow.css("border-bottom-width",w.imgheight-w.y-w.height+"px");w.shadow.css("width",w.width+"px");w.shadow.css("height",w.height+"px");w.marker.add(w.dash).css("width",w.width+"px");w.marker.add(w.dash).css("height",w.height+"px")};w.adjustPreview=function(){w.img.attr("width",w.imgwidth*w.previewSize/w.width);w.img.attr("height",w.imgheight*w.previewSize/w.height);w.img.css("margin-left","-"+w.x*w.previewSize/w.width+"px");w.img.css("margin-top","-"+w.y*w.previewSize/w.height+"px");w.preview.select()};w.handleMouseMove=function(i,e){w.dragging.nextExec=w.dragging.nextExec||0;if(0==w.dragging.nextExec){w.dragging.nextExec=3;var t=i-w.dragging.x,r=e-w.dragging.y;if(this.dragging.i){(0,w.resizeHandlers[this.dragging.i-1])(t,r)}else{w.x=w.dragging.ax+t;w.y=w.dragging.ay+r;w.x+w.width>w.imgwidth&&(w.x=w.imgwidth-w.width);w.y+w.height>w.imgheight&&(w.y=w.imgheight-w.height);w.x<0&&(w.x=0);w.y<0&&(w.y=0)}w.setMarker();w.adjustPreview()}else w.dragging.nextExec--};w.handleMouseUp=function(i){e("#avatar-offsetX").val(w.x);e("#avatar-offsetY").val(w.y);e("#avatar-width").val(w.width);w.dragging=null;w.shadow.show()};w.handleKeyboardMove=function(i){if(d.ArrowUp&&0!==w.y){w.y-=i.shiftKey?5:1;w.y<0&&(w.y=0)}else if(d.ArrowDown&&w.y+w.width!==w.imgheight){w.y+=i.shiftKey?5:1;w.y+w.width>w.imgheight&&(w.y=w.imgheight-w.width)}if(d.ArrowLeft&&0!==w.x){w.x-=i.shiftKey?5:1;w.x<0&&(w.x=0)}else if(d.ArrowRight&&w.x+w.width!==w.imgwidth){w.x+=i.shiftKey?5:1;w.x+w.width>w.imgwidth&&(w.x=w.imgwidth-w.width)}};w.handleKeyboardResize=function(i){var e=i.shiftKey?5:1;(d.ArrowLeft||d.ArrowUp)&&(e=-e);var t=w.width+e;t<20&&(t=20);w.x+t>w.imgwidth&&(t=w.imgwidth-w.x);w.y+t>w.imgheight&&(t=w.imgheight-w.y);w.width=w.height=t};w.handleKeyDown=function(i){"Alt"===i.key&&(o=!0);if(g(i)){d[i.key]=!0;o?w.handleKeyboardResize(i):w.handleKeyboardMove(i);w.shadow.hide();w.adjustPreview();w.setMarker();i.preventDefault}};w.announceChange=r.debounce((function(){var i=n.I18n.getText("avatarpicker.cropper.change.announcement.text",w.width,w.width,w.x,w.y,w.imgwidth,w.imgheight);a.readText(i)}),1e3);w.handleKeyUp=function(i){"Alt"===i.key&&(o=!1);if(g(i)){d[i.key]=!1;if(!Object.values(d).includes(!0)){w.announceChange();w.shadow.show();e("#avatar-offsetX").val(w.x);e("#avatar-offsetY").val(w.y);e("#avatar-width").val(w.width)}}};w.originX=function(){return w.dragging.ax};w.originY=function(){return w.dragging.ay};w.originBottomX=function(){return w.dragging.ax+w.dragging.w};w.originBottomY=function(){return w.dragging.ay+w.dragging.h};w.originNw=function(){return{x:w.originX(),y:w.originY()}};w.originNe=function(){return{x:w.originBottomX(),y:w.originY()}};w.originSe=function(){return{x:w.originBottomX(),y:w.originBottomY()}};w.originSw=function(){return{x:w.originX(),y:w.originBottomY()}};w.nwHandler=function(i,e){var t=w.originSe(),r=w.originX()+i,a=w.originY()+e,n=Math.abs(r-t.x),h=Math.abs(a-t.y),d=Math.min(n,h);d<20&&(d=20);t.x-d<0&&(d=t.x);t.y-d<0&&(d=t.y);w.x=t.x-d;w.y=t.y-d;w.width=w.height=d};w.neHandler=function(i,e){var t=w.originSw(),r=w.originBottomX()+i,a=w.originY()+e,n=Math.abs(r-t.x),h=Math.abs(a-t.y),d=Math.min(n,h);d<20&&(d=20);t.x+d>w.imgwidth&&(d=w.imgwidth-t.x);t.y-d<0&&(d=t.y);w.y=t.y-d;w.width=w.height=d};w.seHandler=function(i,e){var t=w.originNw(),r=w.originBottomX()+i,a=w.originBottomY()+e,n=Math.abs(r-t.x),h=Math.abs(a-t.y),d=Math.min(n,h);d<20&&(d=20);t.x+d>w.imgwidth&&(d=w.imgwidth-t.x);t.y+d>w.imgheight&&(d=w.imgheight-t.y);w.width=w.height=d};w.swHandler=function(i,e){var t=w.originNe(),r=w.originX()+i,a=w.originBottomY()+e,n=Math.abs(r-t.x),h=Math.abs(a-t.y),d=Math.min(n,h);d<20&&(d=20);t.x-d<0&&(d=t.x);t.y+d>w.imgheight&&(d=w.imgheight-t.y);w.x=t.x-d;w.width=w.height=d};w.resizeHandlers=[w.nwHandler,w.neHandler,w.seHandler,w.swHandler]}))};