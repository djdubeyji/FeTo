define("jira/project/permissions/permissionschemeview",["jira/util/formatter","jira/backbone-1.3.3","underscore","internal/browser-metrics","jira/project/permissions/permissiongroupview","jira/project/permissions/addpermissionmodel","jira/project/permissions/addpermissionview","jira/project/permissions/deletepermissionview","jira/flag"],(function(e,i,s,t,r,o,n,a,d){"use strict";var l="jira.dialog.open.add-permission-dialog",p="jira.dialog.open.delete-permission-dialog";return i.View.extend({tagName:"div",template:JIRA.Templates.ProjectPermissions.permissionScheme,events:{"click .js-grant-permission-trigger":"openAddDialog"},addDialogSelector:"#grant-project-permission-popup",deleteDialogSelector:"#delete-permission-dialog",initialize:function(e){this.sharedProjects=e.sharedProjects||[];this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html(this.template({id:this.model.get("id"),name:this.model.get("name"),description:this.model.get("description"),sharedProjects:this.sharedProjects}));var e=this,i=e.model.get("displayRendering").grouping,t=e.model.isReadOnly();s.each(i,(function(i){var s=e.model.getGroupModel(i),o=new r({model:s,readOnly:t});e.$el.append(o.render().el);o.on({openAddDialog:e.openAddPermissionView,openDeleteDialog:e.openDeletePermissionView},e)}));this.trigger("renderDone",this.$el);return this},openAddDialog:function(e){e.preventDefault();this.openAddPermissionView()},openAddPermissionView:function(e){t.start({key:l,isInital:!1,threshold:500});this.$el.append(JIRA.Templates.AddProjectPermission.renderPopupContent());var i=new o({permissionSchemeId:this.model.get("id"),permissionKey:e});this._addView=new n({el:this.addDialogSelector,schemeModel:this.model,model:i});this._addView.on("permissionGranted",this.displayOperationSuccessMessage,this);this._addView.on("grantPermissionError",this.displayOperationFailureMessage,this);this._addView.once("contentLoaded",(function(){t.end({key:l})}));this._addView.open();i.fetch()},openDeletePermissionView:function(e){this.$el.append(JIRA.Templates.ProjectPermissions.deleteDialog({permissionName:e.get("permissionName")}));t.start({key:p,isInital:!1,threshold:500});this._deleteView=new a({el:this.deleteDialogSelector,model:e,permissionSchemeId:this.model.get("id")});this._deleteView.on("deleteCompleted",this.displayOperationSuccessMessage,this);this._deleteView.on("deletePermissionError",this.displayOperationFailureMessage,this);this._deleteView.once("contentLoaded",(function(){t.end({key:p})}));this._deleteView.open()},displayOperationSuccessMessage:function(e){this.model.set(this.model.parse(e));var i;switch(e.operationResult.type){case"success":i=d.showSuccessMsg;break;case"info":i=d.showInfoMsg;break;default:return}i("",s.first(e.operationResult.messages),{close:"auto"})},displayOperationFailureMessage:function(i){var s=this._extractErrorMessages(i);if(s.length>0){var t=e.I18n.getText("admin.permissions.feedback.feedbackerror.title.single"),r=JIRA.Templates.ProjectPermissions.renderMessageList({messages:s});if(s.length>1){t=e.I18n.getText("admin.permissions.feedback.feedbackerror.title.multiple");r=e.I18n.getText("admin.permissions.feedback.feedbackerror.desc")+r}d.showWarningMsg(t,r,{close:"manual"})}else d.showWarningMsg(e.I18n.getText("admin.permissions.feedback.unspecifiederror.title"),e.I18n.getText("admin.permissions.feedback.unspecifiederror.description"),{close:"manual"})},_extractErrorMessages:function(e){var i=[];if(!1===s.isObject(e))return i;!0===s.isArray(e.errorMessages)&&e.errorMessages.length>0&&i.push.apply(i,s.clone(e.errorMessages));!0===s.isObject(e.errors)&&i.push.apply(i,s.collect(e.errors,(function(e){return e})));return i}})}));