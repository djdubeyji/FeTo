AJS.test.require(["jira.webresources:application-selector"],(function(){"use strict";var e,i=require("jira/admin/application-selector"),t=require("jira/admin/application-selector/application"),a=require("aui/inline-dialog2"),o=require("underscore"),n=require("jquery");module("Application selector",{setup:function(){this.sandbox=sinon.sandbox.create();this.sandbox.stub(t.prototype,"showEffectiveWarning");this.sandbox.stub(t.prototype,"hideEffectiveWarning");e=[]},teardown:function(){this.sandbox.restore();e.forEach((function(e){e.parent&&e.parent.removeChild(e)}))},initializeApplicationSelector:function(e,t){this.selector=new i({el:n(e)});t&&this.selector.selectApplicationsBasedOnURL(t)}});function l(e){return AJS.layer(e).isVisible()}var d=function(){this.element=n("#qunit-fixture");this.dialogFor=sinon.stub()};o.extend(d.prototype,{addCombo:function(i,t,l,d,c){d=void 0===d||d;var s=n("<div></div>"),r=n("<input>").attr({type:"checkbox",class:"application application-"+i,"data-defined":""+d,"data-key":i}).val(i).prop("checked",!!t).prop("disabled",!!l).appendTo(s);if(!d){var p=new a;n(p).attr({id:"dialog-for-"+i,class:"application-not-defined-dialog"}).appendTo(s);this.dialogFor.withArgs(i).returns(p);e.push(p)}c&&o.pairs(c).forEach((function(e){r.data(e[0],e[1])}));s.appendTo(this.element);return this},addWarning:function(e){var i=n("<div></div>");n("<a></a>").attr({href:"#",class:"aui-icon aui-icon-warning application application-warning application-warning-"+e,"data-key":e}).appendTo(i);n("<label>").attr({class:"application-label","data-key":e}).appendTo(i);i.appendTo(this.element);return this},addCriticalCore:function(){this.addWarning("jira-core");return this},addCore:function(e,i){this.addCombo("jira-core",e,i);return this},getDisabled:function(){return this._getCheckboxes(".application:disabled, .application-label.disabled")},getWarnings:function(){return this._getCheckboxes(".application-warning")},getChecked:function(){return this._getCheckboxes("input:checked")},getIndeterminate:function(){return this._getCheckboxes("input:indeterminate, .application-warning.effective")},doClick:function(e){this.element.find("input[value="+e+"]").click()},setChecked:function(e,i){this.element.find("input[value="+e+"]").prop("checked",i);return this},_getCheckboxes:function(e){return this.element.find(e).map((function(){return n(this).attr("data-key")})).get()},clear:function(){this.element.empty()}});test("Initial state of combobox doesnt change when no app selected",(function(){var e=new d;e.addCombo("something").addCombo("else").addCore();this.initializeApplicationSelector(e.element);deepEqual(e.getChecked(),[],"Doesn't select any combos when no apps selected.")}));test("Initial state of combobox selects + disables core when app selected",(function(){var e=new d;e.addCombo("something").addCombo("else",!0).addCore();this.initializeApplicationSelector(e.element);deepEqual(e.getChecked(),["else","jira-core"],"Core is checked when application is selected.");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled when application is selected.")}));test("Combobox change state aproptietly when there is no core.",(function(){var e=new d;e.addCombo("something").addCombo("else",!0).addWarning("error-app");this.initializeApplicationSelector(e.element);deepEqual(e.getChecked(),["else"]);deepEqual(e.getDisabled(),[]);e.doClick("something");deepEqual(e.getChecked(),["something","else"]);deepEqual(e.getDisabled(),[])}));test("Combobox retains core checked when it was initially checked",(function(){var e=new d;e.addCombo("something").addCombo("else",!0).addWarning("error-app").addCore(!0);this.initializeApplicationSelector(e.element);deepEqual(e.getChecked(),["else","jira-core"],"Core is checked when application is selected.");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled when application is selected.");e.doClick("else");deepEqual(e.getChecked(),["jira-core"],"Core is selected and enabled");deepEqual(e.getDisabled(),[],"Core is re-enabled when no other application is selected.")}));test("Core is not checked and enabled after one app was unchecked",(function(){var e=new d;e.addCombo("something").addCombo("else",!0).addCore();this.initializeApplicationSelector(e.element);e.doClick("else");deepEqual(e.getChecked(),[],"Core is not checked");deepEqual(e.getDisabled(),[],"Core is re-enabled when no other application is selected.")}));test("Core remains checked and disabled when two apps are selected",(function(){var e=new d;e.addCombo("something").addCombo("else").addCore();this.initializeApplicationSelector(e.element);e.doClick("else");e.doClick("something");deepEqual(e.getChecked(),["something","else","jira-core"],"Core is selected and enabled");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled when other application is selected.")}));test("Core is un-checked and enabled when two apps are selected, then de-selected",(function(){var e=new d;e.addCombo("something").addCombo("else").addWarning("error-app").addCore();this.initializeApplicationSelector(e.element);e.doClick("else");e.doClick("something");e.doClick("else");e.doClick("something");deepEqual(e.getChecked(),[],"Core is not selected");deepEqual(e.getDisabled(),[],"Core is enabled when no other application are selected.")}));test("Core is checked and enabled when two apps are selected, then de-selected",(function(e){e.expect(4);var i=e.async(),t=new d;t.addCombo("something").addCombo("else").addWarning("error-app").addCore(!0);this.initializeApplicationSelector(t.element);t.doClick("else");t.doClick("something");t.doClick("else");t.doClick("something");deepEqual(t.getChecked(),["jira-core"],"Core is selected");deepEqual(t.getDisabled(),[],"Core is enabled when no other application are selected.");t.doClick("else");t.doClick("something");t.doClick("else");t.doClick("something");setTimeout((function(){t.doClick("jira-core");deepEqual(t.getChecked(),[],"Core is not selected");deepEqual(t.getDisabled(),[],"Core is enabled when no other application are selected.");i()}),1e3)}));test("Core is un-checked and disabled when other apps were selected and it was initially disabled",(function(){var e=new d;e.addCombo("something").addCombo("else").addWarning("error-app").addCore(!1,!0);this.initializeApplicationSelector(e.element);deepEqual(e.getChecked(),[],"Core is not selected");deepEqual(e.getDisabled(),["jira-core"],"Core remains disabled from initial state");e.doClick("else");e.doClick("something");e.doClick("else");e.doClick("something");deepEqual(e.getChecked(),[],"Core is not selected");deepEqual(e.getDisabled(),["jira-core"],"Core remains disabled from initial state")}));test("Only one application exists script doesn't break",(function(){var e=new d,i=e.element.html();this.initializeApplicationSelector(e.element);deepEqual(e.element.html(),i,"shall be the same")}));test("Application is selected based on the url",(function(){var e=new d;e.addCombo("something").addCombo("else",!0).addCore();this.initializeApplicationSelector(e.element,"http://example.com/?application=something");deepEqual(e.getChecked(),["something","jira-core"],"Core and something are selected");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}));test("Multiple applications are selected based on the url",(function(){var e=new d;e.addCombo("something",!0).addCombo("else",!0).addCore();this.initializeApplicationSelector(e.element,"http://example.com/?application=something&application=else");deepEqual(e.getChecked(),["something","else","jira-core"],"All applications are selected");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}));test("Application is selected also when it appears multiple times in the url",(function(){var e=new d;e.addCombo("something",!0).addCombo("else",!0).addCore();this.initializeApplicationSelector(e.element,"http://example.com/?application=something&application=something");deepEqual(e.getChecked(),["something","jira-core"],"Core and something are selected");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}));test("Nothing is selected when application key is provided in the url but the application is disabled",(function(){var e=new d;e.addCombo("something",!1,!0).addCombo("else",!0).addCore();this.initializeApplicationSelector(e.element,"?application=something");deepEqual(e.getChecked(),[],"Nothing is selected");deepEqual(e.getDisabled(),["something"],"Nothing is disabled.")}));test("Wrong application key provided in the url is not taken into account when selecting",(function(){var e=new d;e.addCombo("something",!1,!0).addCombo("else").addCore();this.initializeApplicationSelector(e.element,"?application=something&application=else");deepEqual(e.getChecked(),["else","jira-core"],"Else and core are selected");deepEqual(e.getDisabled(),["something","jira-core"],"Core and something are disabled.")}));test("Nothing is selected when wrong application key is provided in the url",(function(){var e=new d;e.addCombo("something",!0).addCombo("else").addCore();this.initializeApplicationSelector(e.element,"?application=no-such-app");deepEqual(e.getChecked(),[],"Nothing is selected");deepEqual(e.getDisabled(),[],"Nothing is disabled.")}));test("Wrong application key provided in the url is not taken into account when selecting",(function(){var e=new d;e.addCombo("something",!0).addCombo("else").addCore();this.initializeApplicationSelector(e.element,"?application=no-such-app&application=else");deepEqual(e.getChecked(),["else","jira-core"],"Else and core are selected");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}));test("Defaults are selected when there is no application param in the url",(function(){var e=new d;e.addCombo("something").addCombo("else",!0).addWarning("error-app").addCore();this.initializeApplicationSelector(e.element,"http://example.com/?no-application=no-such-app");deepEqual(e.getChecked(),["else","jira-core"],"Core and something are selected");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}));test("Doesn't break with empty url",(function(){var e=new d;e.addCombo("something",!0).addCombo("else").addCore();this.initializeApplicationSelector(e.element,"");deepEqual(e.getChecked(),["something","jira-core"],"Core and something are selected");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}));test("Effective applications checked after selectApplicationsBasedOnURL and unchecked after toggle",(function(){var e=new d;e.addCombo("something",!1,!1,!0,{effective:["foo"]}).addCombo("foo").addCombo("else",!0).addCore();this.initializeApplicationSelector(e.element,"http://example.com/?application=something");deepEqual(e.getChecked(),["something","jira-core"],"Core and something are selected");deepEqual(e.getIndeterminate(),["foo"],"Foo is indeterminate.");deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.");ok("showEffectiveWarning called once",t.prototype.showEffectiveWarning.calledOnce);e.doClick("something");deepEqual(e.getIndeterminate(),[],"Foo is not indeterminate.");ok("hideEffectiveWarning called once",t.prototype.hideEffectiveWarning.calledOnce)}));test("After disableAllApplications all applications should be disabled",(function(){var e=new d;e.addCombo("jira-func").addCombo("jira-software").addWarning("error-app").addCore();this.initializeApplicationSelector(e.element,"");this.selector.disableAllApplications();deepEqual(e.getDisabled(),["jira-func","jira-software","error-app","jira-core"],"All applications should be disabled");deepEqual(e.getChecked(),[],"None application should be selected")}));test("Undefined application's trigger showing a dialog when checked",(function(){var e=new d;e.addCombo("jira-func",!1,!1,!1);this.initializeApplicationSelector(e.element,"");equal(l(e.dialogFor("jira-func")),!1);e.doClick("jira-func");equal(l(e.dialogFor("jira-func")),!0,"inline dialog should have been shown")}));test("Undefined application's trigger hiding a dialog when unchecked",(function(){var e=new d;e.addCombo("jira-func",!1,!1,!1);this.initializeApplicationSelector(e.element,"");equal(l(e.dialogFor("jira-func")),!1,"inline dialog should start hidden");e.doClick("jira-func");equal(l(e.dialogFor("jira-func")),!0,"inline dialog should appear");e.doClick("jira-func");equal(l(e.dialogFor("jira-func")),!1,"inline dialog should have been hidden")}));test("Defined application's trigger doesn't show a dialog",(function(){var e=new d;e.addCombo("jira-func",!1,!1,!0);this.initializeApplicationSelector(e.element,"");e.doClick("jira-func");equal(l(e.dialogFor("jira-func")),!1,"inline dialog should NOT appear");e.doClick("jira-func");equal(l(e.dialogFor("jira-func")),!1,"inline dialog should not suddenly appear on close")}));test("Effective warning should appear when critical application is indeterminate selected",(function(){var e=new d;e.addCombo("clickable",!1,!1,!0,{effective:["critical"]});e.addWarning("critical");this.initializeApplicationSelector(e.element,"");e.doClick("clickable");deepEqual(e.getIndeterminate(),["critical"],"Critical is indeterminate.");ok("showEffectiveWarning called once",t.prototype.showEffectiveWarning.calledOnce)}));test("Effective warning should appear when critical Core application is indeterminate selected",(function(){var e=new d;e.addCombo("clickable",!1,!1,!0,{effective:["jira-core"]});e.addCriticalCore();this.initializeApplicationSelector(e.element,"");e.doClick("clickable");deepEqual(e.getIndeterminate(),["jira-core"],"Core is indeterminate.");ok("showEffectiveWarning called once",t.prototype.showEffectiveWarning.calledOnce)}))}));