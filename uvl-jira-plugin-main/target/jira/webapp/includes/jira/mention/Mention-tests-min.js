var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var a=[],r=!0,s=!1,n=void 0;try{for(var o,i=e[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){a.push(o.value);if(t&&a.length===t)break}}catch(e){s=!0;n=e}finally{try{!r&&i.return&&i.return()}finally{if(s)throw n}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};AJS.test.require(["jira.webresources:mentions-feature"],(function(){"use strict";var e=require("jira/mention/mention-matcher"),t=require("jira/mention/mention"),a=require("jquery"),r=[{self:"http://localhost:8090/jira/rest/api/2/user?username=admin",key:"admin",name:"admin",emailAddress:"admin@admin.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/64e1b8d34f425d19e1ee2ea7236d3028?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/64e1b8d34f425d19e1ee2ea7236d3028?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/64e1b8d34f425d19e1ee2ea7236d3028?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/64e1b8d34f425d19e1ee2ea7236d3028?d=mm&s=32"},displayName:"admin",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[{id:"assignee",label:"assignee"},{id:"reporter",label:"reporter"}],highestIssueInvolvementRank:0},{self:"http://localhost:8090/jira/rest/api/2/user?username=axafirfjr",key:"JIRAUSER10640",name:"axafirfjr",emailAddress:"axafirfjr@localdomain.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/82311ba8f074bae9ef3715290ee2136a?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/82311ba8f074bae9ef3715290ee2136a?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/82311ba8f074bae9ef3715290ee2136a?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/82311ba8f074bae9ef3715290ee2136a?d=mm&s=32"},displayName:"Aaflwdgu Xafirfjr",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[]},{self:"http://localhost:8090/jira/rest/api/2/user?username=asumlnczj",key:"JIRAUSER10624",name:"asumlnczj",emailAddress:"asumlnczj@localdomain.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/f549dbd3da17ee50c851f568ca74d05e?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/f549dbd3da17ee50c851f568ca74d05e?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/f549dbd3da17ee50c851f568ca74d05e?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/f549dbd3da17ee50c851f568ca74d05e?d=mm&s=32"},displayName:"Aajegmhy Sumlnczj",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[]},{self:"http://localhost:8090/jira/rest/api/2/user?username=axmyummap",key:"JIRAUSER11091",name:"axmyummap",emailAddress:"axmyummap@localdomain.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/0bf6ef284e3a9328e6078e9a4282e804?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/0bf6ef284e3a9328e6078e9a4282e804?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/0bf6ef284e3a9328e6078e9a4282e804?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/0bf6ef284e3a9328e6078e9a4282e804?d=mm&s=32"},displayName:"Aaomclxu Xmyummap",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[]},{self:"http://localhost:8090/jira/rest/api/2/user?username=ajsvnucxf",key:"JIRAUSER11535",name:"ajsvnucxf",emailAddress:"ajsvnucxf@localdomain.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/f491c6f658614f6609a61a36d2528b39?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/f491c6f658614f6609a61a36d2528b39?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/f491c6f658614f6609a61a36d2528b39?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/f491c6f658614f6609a61a36d2528b39?d=mm&s=32"},displayName:"Aarmwrzx Jsvnucxf",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[]}],s=175,n="fred",o="HEK-1";function i(t,a){a||(a=t.length);return e.getUserNameFromCurrentWord(t,a)}module("getUserNameFromCurrentWord - triggers");test("empty searches",(function(){equal(i("@"),"","matching @");equal(i("[@"),"","matching [@");equal(i("[~"),"","matching [~");equal(i("[~@"),"","matching [~@");equal(i("~@"),"","matching ~@")}));test("non-valid syntaxes do not trigger autocomplete",(function(){equal(i("["),null,"matching [");equal(i("[a"),null,"matching [a")}));test("simple search for 'a'",(function(){equal(i("@a"),"a","matching @a");equal(i("[@a"),"a","matching [@a");equal(i("[~a"),"a","matching [~a");equal(i("[~@a"),"a","matching [~@a")}));test("takes the last occurrence of [~ to start the search",(function(){equal(i("[~[~["),"[","should only return data after the last [~")}));test("the @ syntax takes precedence over [~ syntax",(function(){equal(i("[@~"),"~","matching [@~");equal(i("[@~a"),"~a","matching [@~a")}));test("the @ syntax does not match if preceded by alpha-numeric characters",(function(){equal(i("test@a"),null,"matching test@a");equal(i("the quick brown fox jumped over the lazy@dog"),null,"there's an alphanumeric character before the @, so shouldn't match");equal(i("the quick brown fox jumped over the lazy @dog"),"dog","no alphanumeric character before the @, so should search for 'dog'")}));test("the [~ syntax does not match if preceded by alpha-numeric characters",(function(){equal(i("test[~a"),null,"matching test[~a");equal(i("the quick brown fox jumped over the lazy[~dog"),null,"there's an alphanumeric character before the [~, so shouldn't match");equal(i("the quick brown fox jumped over the lazy [~dog"),"dog","no alphanumeric character before the [~, so should search for 'dog'")}));test("the rest",(function(){equal(i("test[@a"),"a","matching test[@a");equal(i("test[@~a"),"~a","matching test[@~a");equal(i("test[~@a"),"a","matching test[~@a");equal(i("a test[@a"),"a","matching a test[@a");equal(i("a test[@~a"),"~a","matching a test[@~a");equal(i("a test[~@a"),"a","matching a test[~@a")}));module("getUserNameFromCurrentWord - query");test("can have multiple words in the query",(function(){equal(i("the quick brown fox jumped over the @lazy dog"),"lazy dog","should return 'lazy dog'");equal(i("the quick brown fox jumped over @the lazy dog"),"the lazy dog","should return 'the lazy dog'")}));test("the query is limited to three words maximum",(function(){var e="the quick brown fox @jumped over the lazy dog";equal(i(e,45),null,"caret is at end of 5th word after the @, so should return null");equal(i(e,41),null,"caret is at end of 4th word after the @, so should return null");equal(i(e,38),null,"caret is inside 4th word after the @, so should return null");equal(i(e,36),"jumped over the","caret is at end of 3rd word after the @, so should return 'jumped over the'")}));test("the query will return multiple words up to and including any whitespace before the 4th word",(function(){var e="the quick brown fox @jumped over the lazy dog";equal(i(e,37),"jumped over the ","caret is just before the 4th word after the @, so should return everything before it (including the whitespace)");equal(i(e,38),null,"caret is just after the 'l' in lazy, which is in the 4th word, so should return null")}));test("trailing whitespace is 'preserved' in the query",(function(){equal(i("the quick brown fox jumped over the @lazy dog  "),"lazy dog  ","should keep the space after 'dog'")}));test("infix whitespace is preserved in the query",(function(){equal(i("jumped over the @lazy   dog"),"lazy   dog","should keep the three spaces between 'lazy' and 'dog'");equal(i("jumped over the @lazy \t\t  dog"),"lazy \t\t  dog","keeps everything between 'lazy' and 'dog'")}));test("carriage return and newline break the query",(function(){var e="jumped over the @lazy\ndog";equal(i(e,25),null,"when the user's caret is on the next line, it returns false");equal(i(e,22),null,"when the user's caret is just after the new line, it returns false");equal(i(e,21),"lazy","when the user's caret is just before the new line (i.e, just after 'lazy'), it will return 'lazy'")}));module("Mention - role help text");function u(e){return!!a(JIRA.Templates.mentionsSuggestions({suggestions:[],activity:!1,query:null,isRolesEnabled:e})).find(".aui-list-section-footer").length}test("help text should be available when roles is enabled",(function(){ok(u(!0))}));test("help text should not be available when roles is not enabled",(function(){ok(!u(!1))}));module("Mention#_indexOfFirstMatch");test("_indexOfFirstMatch",(function(){var e=JIRA.Mention.prototype._indexOfFirstMatch;equal(e("Mike Cannon-Brooks","Br"),12);equal(e("Mike Cannon-Brooks","Bre"),-1);equal(e("Mike Cannon-Brooks","Mi"),0);equal(e("Mike Cannon-Brooks","Cann"),5);equal(e("Mike Cannon-Brooks","Cannon-Brooks"),5);equal(e("James O'Brian","Br"),8);equal(e("James O'Brian","O'Br"),6);equal(e("cat@hat.com","ca"),0);equal(e("cat@hat.com","ha"),4);equal(e("cat@hat.com","at"),-1);equal(e("cat@hat.com","co"),8)}));module("Mentions component",{setup:function(){this.sandbox=sinon.sandbox.create();this.server=this.sandbox.useFakeServer();this.clock=this.sandbox.useFakeTimers()},teardown:function(){this.clock.restore();this.server.restore()}});var l=function(e){return e.split("?")[1].split("&").reduce((function(e,t){var a=t.split("="),r=_slicedToArray(a,2),s=r[0],n=r[1];e[s]=n;return e}),{})};test("Debounces calls to server",(function(){var e=new t("HEK-1"),r="<textarea></textarea>";sinon.stub(e,"_getMentionsOffsetTarget",(function(){return a(r)}));e.textarea(r);sinon.stub(e,"_getUserNameFromInput",(function(){return"fred"}));sinon.stub(e,"_getCaretPosition",(function(){return 0}));sinon.stub(e,"_isNewRequestRequired",(function(){return!0}));e._keyUp();e._keyUp();e._keyUp();equal(this.server.requests.length,0,"API was not called instantly");this.clock.tick(s);equal(this.server.requests.length,1,"API was called once")}));[{description:"calls proper URL when feature flag is turned off and issue key is present",issueKey:o,query:n,featureFlag:!1,expectedUrl:"/rest/internal/2/user/mention/search",urlParams:{issueKey:o}},{description:"calls proper URL when feature flag is turned off and issue key is not present",query:n,featureFlag:!1,expectedUrl:"/rest/api/2/user/viewissue/search",urlParams:{username:n}},{description:"calls proper URL when feature flag is turned on and issue key is present",issueKey:o,query:n,featureFlag:!0,expectedUrl:"/rest/internal/2/users/mention",urlParams:{issueKey:o,query:n}},{description:"calls proper URL when feature flag is turned on and issue key is not present",query:n,featureFlag:!0,expectedUrl:"/rest/internal/2/users/mention",urlParams:{query:n}},{description:"calls proper URL when feature flag is turned on and multiple project keys are present",query:n,featureFlag:!0,projectKeys:"AAA,BBB,CCC",expectedUrl:"/rest/internal/2/users/mention",urlParams:{query:n,projectKeys:"AAA%2CBBB%2CCCC"}}].forEach((function(e){test(""+e.description,(function(){var r=new t(e.issueKey,e.featureFlag),n='<textarea data-issuekey="'+(e.issueKey||"")+'" data-project-keys="'+(e.projectKeys||"")+'"></textarea>';sinon.stub(r,"_getMentionsOffsetTarget",(function(){return a(n)}));r.textarea(n);sinon.stub(r,"_getUserNameFromInput",(function(){return e.query}));sinon.stub(r,"_getCaretPosition",(function(){return 0}));sinon.stub(r,"_isNewRequestRequired",(function(){return!0}));r._keyUp();this.server.requests=[];this.clock.tick(s);var o=this.server.requests[0].url;ok(o.includes(e.expectedUrl),e.description+" - proper URL is used");equal(l(o).maxResults,5,e.description+" - maxResults is set properly");Object.entries(e.urlParams).forEach((function(t){var a=_slicedToArray(t,2),r=a[0],s=a[1];equal(l(o)[r],s,e.description+" - "+r+" is set properly")}))}))}));test("Uses queryCache to display results",(function(){var e=new t("HEK-1"),n="<textarea></textarea>",o="admin";sinon.stub(e,"_getUserNameFromInput",(function(){return o}));sinon.stub(e,"_getCaretPosition",(function(){return 1}));sinon.stub(e,"_isNewRequestRequired",(function(){return!0}));sinon.stub(e,"_getMentionsOffsetTarget",(function(){return a(n)}));var i=sinon.spy(e,"updateSuggestions");e.textarea(n);equal(e.dataSource.matcher(),!1,"matcher is not returning results");e._keyUp();this.clock.tick(s);this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify(r)]);this.sandbox.server.respond();var u,l=(u=i.secondCall.args[0],Array.from(u.find(".aui-list-item-link").map((function(e,t){return a(t).attr("rel")}))));deepEqual(l,r.map((function(e){return e.name})),"shows results in backend order");e._keyUp();this.clock.tick(s);equal(this.server.requests.length,1,"server is not polled again for the same query");o="a";e._keyUp();this.clock.tick(s);equal(this.server.requests.length,2,"server is polled even if it could populate dropdown from cache")}))}));