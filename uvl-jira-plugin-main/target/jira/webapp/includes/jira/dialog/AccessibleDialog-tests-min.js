AJS.test.require(["jira.webresources:jira-accessible-dialog"],(function(){"use strict";var e=require("jquery"),t=require("jira/dialog/accessible-dialog");module("AccessibleDialog attributes",{setup:function(){this.dialog=new t({id:"accessible-dialog"})},teardown:function(){this.dialog.remove()}});test("AccessibleDialog has all the required attributes set",(function(){this.dialog.addHeader("Dialog Title");this.dialog.show();var i=e("#accessible-dialog"),a=t.ClassNames.Dialog;ok(i.hasClass(a),"Dialog has the "+a+" class.");equal(i.attr("aria-hidden"),"false",'Dialog has aria-hidden set to "false".');equal(i.attr("role"),"dialog",'Dialog has role set to "dialog".');equal(i.attr("aria-modal"),"true",'Dialog has aria-modal set to "true".')}));module("AccessibleDialog header",{setup:function(){this.dialog=new t({id:"accessible-dialog"})},teardown:function(){this.dialog.remove()}});test("Title is placed inside the .dialog-header element and is contained within an h1",(function(){var e="Dialog Title";this.dialog.addHeader(e);var t=this.dialog.popup.element.find(".dialog-header").children(":first");ok(t.is(".dialog-title"),"Dialog's title is the first child of the dialog' header.");ok(t.is("h1"),"Dialog's title is contained within an h1 element.");equal(t.text(),e)}));function i(e,t){var i=e.curpage;e.addHeader("Page"+i+" title");t?e.addPanel("Panel"+i,t):e.addPanel("Panel"+i,"<p>Test content "+i+"</p>");e.addButton("Next",(function(){e.nextPage()}));e.addCancel("Cancel",(function(){e.remove()}))}module("AccessibleDialog labelling",{setup:function(){var e=new t({id:"accessible-dialog"});i(e);this.dialog=e;this.dialog.show()},teardown:function(){this.dialog.remove()}});test("Dialog is initially labelled by its title element",(function(){var e=this.dialog.popup.element,t=e.find(".dialog-title");equal(e.attr("aria-labelledby"),t.attr("id"))}));test("Dialog keeps being labelled by the current page's title when navigating between pages",(function(){this.dialog.addPage("page1");i(this.dialog);var e=this.dialog.popup.element,t=e.find(".dialog-title:visible");equal(e.attr("aria-labelledby"),t.attr("id"),"Dialog is labelled by the 2nd page's title after adding a new page.");this.dialog.addPage("page2");i(this.dialog);this.dialog.prevPage();t=e.find(".dialog-title:visible");equal(e.attr("aria-labelledby"),t.attr("id"),"Dialog is labelled by the 2nd page's title after using prevPage.");this.dialog.nextPage();t=e.find(".dialog-title:visible");equal(e.attr("aria-labelledby"),t.attr("id"),"Dialog is labelled by the 3rd page's title after using nextPage.");this.dialog.gotoPage(0);t=e.find(".dialog-title:visible");equal(e.attr("aria-labelledby"),t.attr("id"),"Dialog is labelled by the 1st page's title after using gotoPage(0).")}));module("AccessibleDialog default focus management",{setup:function(){var e=new t({id:"accessible-dialog"});i(e);e.addPage("page1");i(e);e.addPage("page2");i(e);e.gotoPage(0);this.dialog=e;this.sandbox=sinon.sandbox.create({useFakeTimers:!0})},teardown:function(){this.dialog.remove()}});test("When showing a dialog, the focus jumps to the dialog title, if no options provided",(function(){var e=this.dialog.popup.element;this.dialog.show();var t=e.find(".dialog-title:visible")[0];this.sandbox.clock.tick(200);equal(document.activeElement,t)}));test("When moving between pages, the focus jumps to the current page's title, if no options provided",(function(){this.dialog.show();this.dialog.nextPage();this.sandbox.clock.tick(200);var e=this.dialog.popup.element,t=e.find(".dialog-title:visible")[0];equal(document.activeElement,t,"The focus moves to the page's title after using nextPage.");this.dialog.prevPage();this.sandbox.clock.tick(200);t=e.find(".dialog-title:visible")[0];equal(document.activeElement,t,"The focus moves to the page's title after using prevPage.");this.dialog.gotoPage(2);this.sandbox.clock.tick(200);t=e.find(".dialog-title:visible")[0];equal(document.activeElement,t,"The focus moves to the page's title after using gotoPage.")}));module("AccessibleDialog custom focus management",{setup:function(){var a=e('<button id="first-interactive-element">Interactive element</button>'),o=e('<button id="accessible-dialog-trigger">Open dialog</button>');e("#qunit-fixture").append(o);var l=new t({id:"accessible-dialog",onPageLoadFocusBehavior:t.OnPageLoadFocusBehavior.Title,$elementToFocusOnClose:o});i(l);l.addPage("page1",t.OnPageLoadFocusBehavior.FirstInteractiveElement);i(l,a);l.addPage("page2",(function(e){e.getCurrentPage().element.find(".button-panel-cancel-link").focus()}));i(l);l.addPage("page3");i(l);l.gotoPage(0);this.dialog=l;this.$interactiveElement=a;this.$triggerButton=o;this.sandbox=sinon.sandbox.create({useFakeTimers:!0})},teardown:function(){this.dialog.popup.element&&this.dialog.remove()}});test("When showing a dialog, the focus jumps to the dialog title, as provided in the options",(function(){var e=this.dialog.popup.element;this.dialog.show();var t=e.find(".dialog-title:visible")[0];this.sandbox.clock.tick(200);equal(document.activeElement,t)}));test("When navigating to the second page, the focus jumps to the first interactive element, as stated in the options",(function(){this.dialog.show();this.dialog.nextPage();this.sandbox.clock.tick(200);var e=this.$interactiveElement[0];equal(document.activeElement,e,"The focus moves to the first interactive element after using nextPage.");this.dialog.nextPage();this.dialog.prevPage();this.sandbox.clock.tick(200);equal(document.activeElement,e,"The focus moves to the first interactive element after using prevPage.");this.dialog.nextPage();this.dialog.gotoPage(1);this.sandbox.clock.tick(200);equal(document.activeElement,e,"The focus moves to the first interactive element after using gotoPage.")}));test("When navigating to the third page, the focus jumps to the custom element, as stated in the options",(function(){this.dialog.show();this.dialog.nextPage();this.dialog.nextPage();this.sandbox.clock.tick(200);var e=this.dialog.page[this.dialog.curpage].element.find(".button-panel-cancel-link")[0];equal(document.activeElement,e,"The focus moves to the custom element after using nextPage.");this.dialog.nextPage();this.dialog.prevPage();this.sandbox.clock.tick(200);equal(document.activeElement,e,"The focus moves to the the custom element after using prevPage.");this.dialog.nextPage();this.dialog.gotoPage(2);this.sandbox.clock.tick(200);equal(document.activeElement,e,"The focus moves to the custom element after using gotoPage.")}));test("After hiding the dialog, the focus jumps to the provided element",(function(){this.dialog.show();this.sandbox.clock.tick(200);this.dialog.hide();this.sandbox.clock.tick(200);equal(document.activeElement,this.$triggerButton[0])}));test("After removing the dialog, the focus jumps to the provided element",(function(){this.dialog.show();this.sandbox.clock.tick(200);this.dialog.remove();this.sandbox.clock.tick(200);equal(document.activeElement,this.$triggerButton[0])}))}));