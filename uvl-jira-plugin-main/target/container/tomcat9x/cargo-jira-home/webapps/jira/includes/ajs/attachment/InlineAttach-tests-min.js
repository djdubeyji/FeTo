AJS.test.require(["jira.webresources:inline-attach"],(function(){var e=require("jquery"),t=require("jira/lib/class"),r=require("jira/attachment/inline-attach"),a=require("jira/util/formatter"),o=function(t){for(var r=e(t).find("*").toArray(),a=1;a<arguments.length;a++){var o=arguments[a];o&&o.get&&(o=o.get(0)||o);if(!e.inArray(o,r)<0)return!1}return!0},l=function(e,t){this.name=e;this.size=t;this.toSimple=function(){return{name:e,size:t,file:this}}},n=function(){return 0===arguments.length?void 0:1===arguments.length?arguments[0]:Array.prototype.slice.call(arguments).join(",")},u={tr:function(){if(0!==arguments.length){if(1===arguments.length)return arguments[0];for(var e=Array.prototype.slice.call(arguments),t=0;t<e.length;t++)"number"==typeof e[t]&&(e[t]=e[t].toFixed(4));return e.join(",")}},currentOutOfTotalSize:function(e,t){return e+"/"+t},time:function(e){return e},rate:function(e){return e},fileSize:function(){return 0===arguments.length?void 0:1===arguments.length?arguments[0]:Array.prototype.slice.call(arguments)}},s=function(){this.hidden=!0;this.started=!1;this.removed=!1;this.onCancel=function(e){this.cancel=e;return this};this.triggerCancel=function(){this.cancel.call(this);return this};this.toString=function(){return"MockStaticProgress["+JSON.stringify(this)+"]"};this.show=function(){this.hidden=!1;return this};this.start=function(){this.started=!0;return this};this.remove=function(){this.removed=!0;return this}},i=function(e){this.file=e;this.hidden=!0;this.value=1/0;this.started=!1;this.finished=!1;this.removed=!1;this.hide=function(){this.hidden=!0;return this};this.show=function(){this.hidden=!1;return this};this.start=function(){this.started=!0;return this};this.update=function(e){this.value=e;return this};this.onCancel=function(e){this.cancel=e;return this};this.triggerCancel=function(){this.cancel.call(this);return this};this.finish=function(){this.finished=!0;return this};this.remove=function(){this.removed=!0;return this};this.toString=function(){return"MockProgress["+JSON.stringify(this)+"]"}},c=function(e){var t=function(){var t=arguments.callee;t.lastScope=this;t.lastArgs=Array.prototype.slice.call(arguments);t.count++;return e&&e.apply?e.apply(this,arguments):e};t.count=0;return t},d=function(e,t){this.$element=this.element=e;this.multiple=t;this.onChange=function(e){this.change=e};this.focus=c(this);this.clear=c(this);this.cloneInput=c((function(){return{count:this.cloneInput.count,cloneInput:!0}}))},p=function(e){this.nextToken=33737;this.formToken="form-token";this.errors=[];this.fileNames=[];this.fileSelector=e;this.maxSize=1e3;this.disabled=!1;this.progress=[];this.lastReplace=null;this.lastInput=null;this.onCancel=function(e){this.cancel=e;return this};this.addError=function(e,t){this.errors.push(e);this.lastReplace=t;return this};this.addErrorWithFileName=function(e,t,r){this.errors.push(e+"|"+t);this.lastReplace=r};this.clearErrors=c((function(){this.errors=[];return this}));this.getAtlToken=function(){return this.nextToken++};this.setAtlToken=function(e){this.lastToken=e;return this};this.getFormToken=function(){return this.formToken};this.disable=function(){this.disabled=!0;return this};this.enable=function(){this.disabled=!1;return this};this.addProgress=function(e){var t=new i(e);this.progress.push(t);return t};this.addStaticProgress=function(e){var t=new s(e);this.progress.push(t);return t};this.addTemporaryFileCheckbox=c(this);this.cloneFileInput=function(){return this.fileSelector.cloneInput()}},h=function(e){return function(){ok(!1,"Should not be calling "+e+".")}},f=1024,m=1048576,q=1024*m;module("Text",{setup:function(){this.tr=r.Text.tr},teardown:function(){r.Text.tr=this.tr}});test("Test Translate No Key",(function(){equal(r.Text.tr(),void 0,"Return undefined on no key.")}));test("Test Translate No Args",(function(){equal(r.Text.tr("upload.cancel"),"common.words.cancel","Return the translation.");equal(r.Text.tr("doesnotexist.12627"),"doesnotexist.12627","Return the key.")}));test("Test Translate Args",(function(){this.stub(a,"format");r.Text.tr("upload.bytes.per.second",5);sinon.assert.calledWith(a.format,"upload.bytes.per.second",5);equal(r.Text.tr("doesnotexist.12627",5),"doesnotexist.12627","Return the key.")}));test("Test for fileSize No args",(function(){equal(r.Text.fileSize(),void 0,"Return undefined on no arguments.")}));test("Test for fileSize Single Arg",(function(){r.Text.tr=n;var t=e.proxy(r.Text.fileSize,r.Text);equal(t(0),n("upload.kilobyte",0),"0 should return as kB with no decimal places.");equal(t(512),n("upload.kilobyte","0.50"),"Return a 1/2 kB");equal(t(1024),n("upload.kilobyte","1.00"),"Return a 1 kB");equal(t(10496),n("upload.kilobyte","10.25"),"Return a 10.25 kB");equal(t(Math.floor(.995*m)),n("upload.kilobyte","1018.88"),"Return a 1018.88 kB");equal(t(Math.ceil(.995*m)),n("upload.megabyte","1.00"),"Return a 1 MB because of rounding.");equal(t(2.5*m),n("upload.megabyte","2.50"),"Return a 2.5 MB.");equal(t(Math.floor(.995*q)),n("upload.megabyte","1018.88"),"Return a 1018.88 MB.");equal(t(Math.ceil(.995*q)),n("upload.gigabyte","1.00"),"Return a 1.0 GB.");equal(t(3.5*q),n("upload.gigabyte","3.50"),"Return a 3.5 GB.");equal(t(1024*q),n("upload.gigabyte","1024.00"),"Return a 1024 GB.")}));test("Test for fileSize Multiple Arg",(function(){r.Text.tr=n;var t=e.proxy(r.Text.fileSize,r.Text);deepEqual(t(0,m),[n("upload.kilobyte","0"),n("upload.kilobyte","1024.00")],"[0, 1024kb] should be returned.");deepEqual(t(512,2*m),[n("upload.kilobyte","0.50"),n("upload.kilobyte","2048.00")],"[0.50kB, 2048.00kB]");deepEqual(t(1024,2.5*m),[n("upload.kilobyte","1.00"),n("upload.kilobyte","2560.00")],"[1kB, 2560kB]");deepEqual(t(10496,10240,5120),[n("upload.kilobyte","10.25"),n("upload.kilobyte","10.00"),n("upload.kilobyte","5.00")],"[10.25kB, 10.00kB, 5.00kB]");deepEqual(t(Math.floor(.995*m),686080,56*m),[n("upload.kilobyte","1018.88"),n("upload.kilobyte","670.00"),n("upload.kilobyte","57344.00")],"[1018.88kB, 670kB, 57344kB]");deepEqual(t(Math.ceil(.995*m),524288,1),[n("upload.megabyte","1.00"),n("upload.megabyte","0.50"),n("upload.megabyte","0")],"[1.00 MB, 0.50 MB, 0]");deepEqual(t(2.5*m,q,10240),[n("upload.megabyte","2.50"),n("upload.megabyte","1024.00"),n("upload.megabyte","0.01")],"[2.50MB, 1024.00MB, 0.01MB]");deepEqual(t(Math.floor(.995*q),q,0),[n("upload.megabyte","1018.88"),n("upload.megabyte","1024.00"),n("upload.megabyte","0")],"[1018.88 MB, 1024MB, 0]");deepEqual(t(Math.ceil(.995*q),.5*q,.25*q),[n("upload.gigabyte","1.00"),n("upload.gigabyte","0.50"),n("upload.gigabyte","0.25")],"[1GB, 0.5GB, 0.25GB]");deepEqual(t(3.5*q,5*m,6*m),[n("upload.gigabyte","3.50"),n("upload.gigabyte","0"),n("upload.gigabyte","0.01")],"[3.5GB, 0GB, 0.01GB]");deepEqual(t(1024*q,50*m,57578*q,57578*m),[n("upload.gigabyte","1024.00"),n("upload.gigabyte","0.05"),n("upload.gigabyte","57578.00"),n("upload.gigabyte","56.23")],"[1024GB, 0.05GB, 57578.00GB, 56.23GB]")}));test("Test for currentOutOfTotalSize",(function(){r.Text.tr=n;var t=e.proxy(r.Text.currentOutOfTotalSize,r.Text);equal(t(0,0),n("upload.kilobyte.part","0","0"),"0/0 kb.");equal(t(5,524288),n("upload.kilobyte.part","0","512.00"),"0/512.00 kb.");equal(t(6,524288),n("upload.kilobyte.part","0.01","512.00"),"0.01/512.00 kb.");equal(t(f,Math.floor(.995*m)),n("upload.kilobyte.part","1.00","1018.88"),"0.01/1018.88 kb.");equal(t(5120,Math.ceil(.995*m)),"upload.megabyte.part,0,1.00","0/1.00 MB.");equal(t(6144,Math.ceil(.995*m)),n("upload.megabyte.part","0.01","1.00"),"0.01/1.00 MB.");equal(t(524288,Math.floor(.995*q)),n("upload.megabyte.part","0.50","1018.88"),"0.5/1018.88 MB.");equal(t(5*m,Math.ceil(.995*q)),"upload.gigabyte.part,0,1.00","0/1GB.");equal(t(6*m,Math.ceil(.995*q)),n("upload.gigabyte.part","0.01","1.00"),"0.01/1GB.");equal(t(8.5*q,9*q),n("upload.gigabyte.part","8.50","9.00"),"8.5/9GB.");equal(t(8.5*q,1055*q),n("upload.gigabyte.part","8.50","1055.00"),"8.5/1055GB.")}));test("Test for Text.rate",(function(){r.Text.tr=n;var t=e.proxy(r.Text.rate,r.Text);equal(t(0),n("upload.bytes.per.second","0"),"0 B/sec");equal(t(512),n("upload.bytes.per.second","512.00"),"512 B/sec");equal(t(Math.floor(1018.88)),n("upload.bytes.per.second","1018.00"),"1018.00 B/sec");equal(t(Math.ceil(1018.88)),n("upload.kilobytes.per.second","1.00"),"1.00 kB/sec");equal(t(3840),n("upload.kilobytes.per.second","3.75"),"3.75 kB/sec");equal(t(Math.floor(.995*m)),n("upload.kilobytes.per.second","1018.88"),"1018.88 kB/sec");equal(t(Math.ceil(.995*m)),n("upload.megabytes.per.second","1.00"),"1.00 MB/sec");equal(t(5505024),n("upload.megabytes.per.second","5.25"),"5.25 MB/sec");equal(t(1025*m),n("upload.megabytes.per.second","1025.00"),"1025.00 MB/sec")}));test("Test for Text.time",(function(){r.Text.tr=n;var t=e.proxy(r.Text.time,r.Text);equal(t(0),n("upload.seconds","0"),"0 sec");equal(t(45),n("upload.seconds","45"),"45 sec");equal(t(59),n("upload.seconds","59"),"59 sec");equal(t(60),n("upload.minutes","1"),"1 min");equal(t(1800),n("upload.minutes","30"),"30 min");equal(t(3540),n("upload.minutes","59"),"59 min");equal(t(3600),n("upload.hours","1"),"1hr");equal(t(3660),n("upload.hours.minutes","1","1"),"1hr 1 min");equal(t(3615),n("upload.hours","1"),"1.0004hr");equal(t(3900),n("upload.hours.minutes","1","5"),"1hr 5 min");equal(t(7140),n("upload.hours.minutes","1","59"),"1hr 59 min");equal(t(7200),n("upload.hours","2"),"2hr");equal(t(7260),n("upload.hours.minutes","2","1"),"2hr 1 min");equal(t(60*(60+70.234)),n("upload.hours.minutes","2","10"),"2hr 10min")}));module("Timer");test("Test for Timer.schedule no scope",(function(){var e,t,a,o=0,l=!1,n=!1,u=new r.Timer((function(){l=!0;a=this}));u._startTimeout=function(r,a){e=r;t=a;return++o};u.cancel=function(){n=!0};ok(!u.timeoutId,"No Timeout");equal(u.schedule(16),u,"Return the timer");equal(16,t,"Correct Timeout");equal(u.timeoutId,1,"Correct Id");e.call(window);ok(!u.timeoutId,"Timer destroyed");ok(l,"Callback should be called.");ok(n,"Cancel was called.");equal(u,a,"Is the scope correctly set.")}));test("Test for Timer.schedule scope",(function(){var e,t,a,o=0,l=!1,n={},u=new r.Timer((function(){l=!0;a=this}),n);u._startTimeout=function(r,a){e=r;t=a;return++o};ok(!u.timeoutId,"No Timeout");equal(u.schedule(678),u,"Return the timer");equal(678,t,"Correct Timeout");equal(u.timeoutId,1,"Correct Id");e.call(window);ok(!u.timeoutId,"Timer destroyed");ok(l,"Callback should be called.");equal(n,a,"Is the scope correctly set.")}));test("Test for Timer.schedule double schedule",(function(){var e=0,t=new r.Timer;t._startTimeout=function(){return++e};t._endTimeout=function(e){equal(1,e,"Cancel called with the correct id.")};ok(!t.timeoutId,"No Timeout");equal(t.schedule(678),t,"Return the timer");equal(t.timeoutId,1,"Correct Id");equal(t.schedule(56),t,"This should cancel the timer.");equal(t.timeoutId,2,"Correct Id")}));module("AjaxUpload",{setup:function(){this.rescope=r.rescope;this.xhr=r.AjaxUpload.xhr;this._xhrJquery=r.AjaxUpload._xhrJquery;this._xhrDirect=r.AjaxUpload._xhrDirect;this.apisupport=r.AjaxUpload._fileApiSupport;this.xhrsupport=r.AjaxUpload._xhrSupport;this.text=r.Text;r.Text=u},teardown:function(){r.rescope=this.rescope;r.AjaxUpload.xhr=this.xhr;r.AjaxUpload._xhrJquery=this._xhrJquery;r.AjaxUpload._xhrDirect=this._xhrDirect;r.AjaxUpload._fileApiSupport=this.apisupport;r.AjaxUpload._xhrSupport=this.xhrsupport;r.Text=this.text}});var g=t.extend({init:function(e){this.throwdata=e||null;this.headers={};this.upload={};this.aborted=!1},open:function(e,t,r){this.method=e;this.url=t;this.async=r},setRequestHeader:function(e,t){this.headers[e]=t},send:function(e){this.data=e;if(this.throwdata)throw this.throwdata},abort:function(){this.aborted=!0}});test("xhr constructor",(function(){var e=r.AjaxUpload.xhr;r.AjaxUpload._xhrJquery=function(){return null};r.AjaxUpload._xhrDirect=function(){return 1};equal(1,e(),"Should used direct");equal(r.AjaxUpload._xhrDirect,r.AjaxUpload.xhr,"Updated the function.");var t=function(){return 2};r.AjaxUpload._xhrJquery=function(){return t};equal(2,e(),"Should use jQuery");equal(t,r.AjaxUpload.xhr,"Updated the function.")}));test("isSupported",(function(){var e=r.AjaxUpload.isSupported;r.AjaxUpload._fileApiSupport=c(!1);r.AjaxUpload._xhrSupport=h("_xhrSupport");equal(!1,e(),"No File Api Support");r.AjaxUpload._fileApiSupport=c(!0);r.AjaxUpload._xhrSupport=c(!1);equal(!1,e(),"No xhr.upload.");r.AjaxUpload._xhrSupport=c(!0);equal(!0,e(),"Has support")}));test("_xhrSupport",(function(){var e=r.AjaxUpload._xhrSupport;r.AjaxUpload.xhr=function(){return null};equal(!1,e(),"No xhr.");r.AjaxUpload.xhr=function(){return{}};equal(!1,e(),"No xhr.upload.");r.AjaxUpload.xhr=function(){throw"Exception"};equal(!1,e(),"No xhr error is not supported.");r.AjaxUpload.xhr=function(){return{upload:!0}};equal(!0,e(),"No xhr with xhr.upload is supported.")}));test("test constructor",(function(){var e=r.AjaxUpload,t="file",a="url",o={test:!0},l={scope:!0};r.rescope=function(e,t){deepEqual(l,t,"Correct scope?");return e+1};var n=new e({scope:l,file:t,url:a,params:o,progress:"progress",error:"error",success:"success",abort:"abort",after:"after",before:"before"});equal(t,n.file,"File correctly set.");equal(a,n.url,"URL correctly set.");deepEqual(o,n.params,"Params correctly set.");equal("progress1",n.progresscb,"Progress correctly set.");equal("error1",n.errorcb,"Error correctly set.");equal("success1",n.successcb,"Success correctly set.");equal("abort1",n.abortcb,"Abort correctly set.");equal("after1",n.finalcb,"Final correctly set.");equal("before1",n.beforecb,"Before correctly set.");equal(!1,n.aborted,"Aborted correctly set.");r.rescope=function(e,t){equal(null,t,"Correct scope for "+e+"?");return e+2};n=new e({file:t,url:a,progress:"progress",error:"error",success:"success",abort:"abort",after:"after",before:"before"});equal(t,n.file,"File correctly set.");equal(a,n.url,"URL correctly set.");deepEqual({},n.params,"Params correctly set.");equal("progress2",n.progresscb,"Progress correctly set.");equal("error2",n.errorcb,"Error correctly set.");equal("success2",n.successcb,"Success correctly set.");equal("abort2",n.abortcb,"Abort correctly set.");equal("after2",n.finalcb,"Final correctly set.");equal("before2",n.beforecb,"Before correctly set.");equal(!1,n.aborted,"Aborted correctly set.")}));test("upload not aborted",(function(){var e=r.AjaxUpload,t=new g;r.AjaxUpload.xhr=function(){return t};var a=0,o={type:"type"},l=new e({url:"url",params:{test:!0},file:o,before:function(){a++}}),n=0,u=l._statechange=function(){++n;equal(l,this,"Correct scope for on state change?")},s=0,i=l._upload=function(){s++;equal(l,this,"Correct scope for upload?")};l.upload();equal(1,a,"Before should have been called.");equal("POST",t.method,"Posting?");equal("url?test=true",t.url,"Correct url?");equal(!0,t.async,"Asynchronous?");deepEqual({"Content-Type":"type"},t.headers,"Content type set?");equal(o,t.data,"File being sent?");equal(0,n,"statechange not called yet.");t.onreadystatechange();equal(1,n,"statechange not called.");equal(0,s,"upload not called yet.");t.upload.onprogress();equal(1,s,"upload not called.");t=new g;r.AjaxUpload.xhr=function(){return t};(l=new e({url:"url",file:o={blarg:"type"}}))._statechange=u;l._upload=i;l.upload();equal("POST",t.method,"Posting?");equal("url",t.url,"Correct url?");equal(!0,t.async,"Asynchronous?");deepEqual({"Content-Type":"application/octet-stream"},t.headers,"Content type set?");equal(o,t.data,"File being sent?");equal(1,n,"statechange not called yet.");t.onreadystatechange();equal(2,n,"statechange not called.");equal(1,s,"upload not called yet.");t.upload.onprogress();equal(2,s,"upload not called.")}));test("abort not uploading",(function(){var e=r.AjaxUpload;r.AjaxUpload.xhr=function(){ok(!1,"Should not be creating the XHR if its aborted.")};var t=!1,a=!1,o=new e({url:"url",file:"file",abort:function(){ok(!t,"First call in abort?.");ok(!a,"Abort called before final.");t=!0},after:function(){ok(!a,"Final call in after?.");ok(t,"Abort not called before final.");a=!0},progress:h("progess"),error:h("error"),success:h("success"),before:h("before")});ok(!o.aborted,"Not aborted initially.");o.abort();ok(o.aborted,"Aborted?.");ok(t&&a,"Correct callbacks called.");o.abort();ok(o.aborted,"Still Aborted?.")}));test("progess",(function(){var e=r.AjaxUpload,t=new g;r.AjaxUpload.xhr=function(){return t};var a=0,o=0,l=new e({url:"url",file:"file",abort:h("abort"),after:h("after"),progress:function(e){a++;o=e},error:h("error"),success:h("success"),before:h("before")});equal(0,a,"Callback not called.");l._upload({});equal(0,a,"Callback still not called.");l._upload({lengthComputable:!0,loaded:1});equal(1,a,"Callback called.");equal(1,o,"Loaded correctly passed?");l._upload({loaded:2});equal(1,a,"Callback not called again.");l._upload({lengthComputable:!0,loaded:78});equal(2,a,"Callback called.");equal(78,o,"Loaded correctly passed?")}));test("statechange aborted",(function(){var t=r.AjaxUpload,a=new g;r.AjaxUpload.xhr=function(){return a};var o=0,l=0,n=0,u=new t({url:"url",file:"file",abort:function(){o++},after:function(){l++;equal(o,l,"After called after the abort.")},before:function(){n++},progress:h("progress"),error:h("error"),success:h("success")}),s=e.proxy(u._statechange,u);u.upload();u.aborted=!0;equal(1,n,"Before called.");equal(0,o,"Abort not called.");s();equal(0,o,"Abort still not called.");a.readyState=4;s();equal(1,o,"Abort is called.");equal(1,l,"After is called.")}));test("statechange errors",(function(){var t=r.AjaxUpload,a=new g;r.AjaxUpload.xhr=function(){return a};var o=c("after"),l=c("error"),n=new t({url:"url",file:{name:"thisIsAFileName"},abort:h("abort"),after:o,progress:h("progress"),error:l,success:h("success")}),u=e.proxy(n._statechange,n);n.upload();equal(l.count,0,"Error not called.");u();equal(l.count,0,"Error still not called.");a.readyState=4;a.responseText="Not JSON";a.status=400012;u();equal(l.count,1,"Error is called.");equal(o.count,1,"After is called.");deepEqual(l.lastArgs,[a.responseText,a.status,a],"Error passed the correct arguments?")}));test("client errors",(function(){var e,t=r.AjaxUpload,a="thisIsAFileName",o=c("after"),l=c("error"),u=function(n){e=new g(n);r.AjaxUpload.xhr=function(){return e};return new t({url:"url",file:{name:a},abort:h("abort"),after:o,progress:h("progress"),error:l,success:h("success")})},s=u({name:"NS_ERROR_FILE_ACCESS_DENIED"});s.upload();equal(l.count,1,"Error is called.");equal(o.count,1,"After is called.");deepEqual(l.lastArgs,[n("upload.error.no.access",a),-1,e],"Error passed the correct arguments?");(s=u({name:"NS_ERROR_FILE_NOT_FOUND"})).upload();equal(l.count,2,"Error is called.");equal(o.count,2,"After is called.");deepEqual(l.lastArgs,[n("upload.error.does.not.exist",a),-1,e],"Error passed the correct arguments?");var i="Some kind of error";(s=u(i)).upload();equal(l.count,3,"Error is called.");equal(o.count,3,"After is called.");deepEqual(l.lastArgs,[n("upload.error.client.unknown",a,i),-1,e],"Error passed the correct arguments?")}));test("statechange success",(function(){var t=r.AjaxUpload,a=new g;r.AjaxUpload.xhr=function(){return a};var o={bad:"fase",caount:574758},l=c("before"),n=c("after"),u=c("success"),s=new t({url:"url",file:{name:name},abort:h("abort"),progress:h("progress"),error:h("error"),after:n,success:u,before:l}),i=e.proxy(s._statechange,s);s.upload();equal(l.count,1,"Before was called.");equal(u.count,0,"Succcess not called.");i();equal(u.count,0,"Success still not called.");a.readyState=4;a.responseText=JSON.stringify(o);a.status=201;i();equal(u.count,1,"Success called.");equal(n.count,1,"After called after success");deepEqual(u.lastArgs,[o,a.status,a],"Is the correct result passed?")}));test("getClientErrorMessage",(function(){var e=r.AjaxUpload.getClientErrorMessage,t={name:"name"},a="error";equal(e(a,t),r.Text.tr("upload.error.client.unknown",t.name,a));a={message:"Don't know"};equal(e(a,t),r.Text.tr("upload.error.client.unknown",t.name,a.message));a.name="NS_ERROR_FILE_ACCESS_DENIED";equal(e(a,t),r.Text.tr("upload.error.no.access",t.name));a.name="NS_ERROR_FILE_NOT_FOUND";equal(e(a,t),r.Text.tr("upload.error.does.not.exist",t.name));a.name="NS_ERROR_FILE_TARGET_DOES_NOT_EXIST";equal(e(a,t),r.Text.tr("upload.error.does.not.exist",t.name))}));module("FormUpload",{setup:function(){this.rescope=r.rescope},teardown:function(){r.rescope=this.rescope}});test("test constructor",(function(){var e=r.FormUpload,t="input",a="url",o={test:!0},l={scope:!0};r.rescope=function(e,t){deepEqual(l,t,"Correct for "+e+" scope?");return e+1};var n=new e({scope:l,$input:t,url:a,params:o,before:"before",error:"error",success:"success",after:"after",abort:"abort"});equal(t,n.$input,"$input correctly set.");equal(a,n.url,"URL correctly set.");deepEqual(o,n.params,"Params correctly set.");equal("error1",n.errorcb,"Error correctly set.");equal("success1",n.successcb,"Success correctly set.");equal("before1",n.before,"Before correctly set.");equal("after1",n.after,"Final correctly set.");equal("abort1",n.abortcb,"Abort correctly set.");equal(n.aborted,!1,"Aborted set correctly?");equal(n.$form,null,"No form should have been set.");equal(n.xhr,null,"XHR not set?");r.rescope=function(e,t){equal(null,t,"Correct scope for "+e+"?");return e+2};n=new e({$input:t,url:a,before:"before",error:"error",success:"success",after:"after",abort:"abort"});equal(t,n.$input,"$input correctly set.");equal(a,n.url,"URL correctly set.");deepEqual({},n.params,"Params correctly set.");equal("error2",n.errorcb,"Error correctly set.");equal("success2",n.successcb,"Success correctly set.");equal("before2",n.before,"Before correctly set.");equal("after2",n.after,"Final correctly set.");equal("abort2",n.abortcb,"Abort correctly set.");equal(n.aborted,!1,"Aborted set correctly?");equal(n.$form,null,"No form should have been set.");equal(n.xhr,null,"XHR not set?")}));test("test upload",(function(){var t,a,o,l=r.FormUpload,n="url",u={test:!0},s=!1,i=0,c={ajaxForm:function(e){t=e;return c},submit:function(){s=!0;return c},append:function(){return c},remove:function(){i++;return c}},d=0,p=0,h=0,f=0,m=new l({$input:"<input type='file'>",url:n,params:u,before:function(){d++},error:function(e){p++;a=e},success:function(e){o=e;h++},after:function(){f++}});m._renders={form:function(t){var r=e.param(u),a=n;r&&(a=n+"?"+r);equal(a,t,"Is the post url correctly set with parameters added to querystring?");return c}};m._addToBody=function(e){equal(e,c,"Appending form to the body?")};m.upload();equal("json",t.dataType,"Is data correct?");deepEqual(u,t.data,"Are the parameters correct?");equal(0,t.timeout,"Is AJAX timeout zero?");equal(!0,s,"Is the form submitted?");var q={};t.beforeSend(q);equal(m.xhr,q,"XHR correctly set?");equal(0,d,"Before not called.");t.beforeSubmit();equal(1,d,"Before called.");equal(0,h,"Success not called.");equal(0,f,"After not called.");equal(0,i,"Removed not called.");t.success({data:"data"});equal(1,h,"Before called.");t.error();equal(1,p,"Before called.");equal("",a,"Correct errror passed.");t.error({});equal(2,p,"Before called.");equal("",a,"Correct errror passed.");t.error({responseText:"error"});equal(3,p,"Before called.");equal("error",a,"Correct errror passed.");t.success();equal(2,h,"Before called.");deepEqual(o,{},"Correct data passed.");equal(i,0,"Initial remove count correct?");equal(m.$form,c,"Initial form correct?");t.complete();equal(1,i,"Removed called.");equal(m.$form,null,"Form removed?");equal(1,f,"After called.");t.complete();equal(1,i,"Removed called.");equal(2,f,"After called.")}));test("test abort",(function(){var e=r.FormUpload,t="<input type='file'>",a={test:!0},o=c("abort"),l=c("after"),n=new e({$input:t,url:"url",params:a,abort:o,after:l});equal(n.aborted,!1,"Initially not aborted");n.abort();equal(o.count,1,"Abort called");equal(l.count,1,"After called");equal(n.aborted,!0,"Aborted after?");var u={abort:o=c("abort")};(n=new e({$input:t,url:"url",params:a,abort:h("abort"),after:h("after")})).xhr=u;equal(n.aborted,!1,"Initially not aborted");n.abort();equal(o.count,1,"XHR abort called?");equal(n.aborted,!0,"Aborted after?")}));module("Form",{setup:function(){this.progress=r.UploadProgress;this.staticprogress=r.UnknownProgress;this.tr=r.Text.tr;r.Text.tr=n;var t=this.$body=e("#qunit-fixture"),a=this.$form=e("<form>"),o=this.$input=e("<input type='file'>");this.$id=e("<input name='id' value='10'>").appendTo(a);this.$pid=e("<input name='pid' value='20'>").appendTo(a);this.$maxSize=e("<div id='attach-max-size'>30</div>").appendTo(t);t.append(a.append(o))},teardown:function(){r.Text.tr=this.tr;r.UploadProgress=this.progress;r.UnknownProgress=this.staticprogress}});test("Form init",(function(){this.$body.append("<input name='id' value='2272782'>");this.$body.append("<input name='pid' value='2828282'>");var e=new r.Form({$element:this.$input});equal(this.$form.get(0),e.$form.get(0),"Correct form found?");equal(e.maxSize,30,"Correct max size.");equal(e.issueId,10,"Correct issue id.");equal(e.projectId,20,"Correct issue pid.");this.$pid.remove();e=new r.Form({$element:this.$input});equal(this.$form.get(0),e.$form.get(0),"Correct form found?");equal(e.maxSize,30,"Correct max size.");equal(e.issueId,10,"Correct issue id.");equal(e.projectId,void 0,"Correct issue pid.");this.$pid.appendTo(this.$form);this.$id.remove();e=new r.Form({$element:this.$input});equal(this.$form.get(0),e.$form.get(0),"Correct form found?");equal(e.maxSize,30,"Correct max size.");equal(e.issueId,void 0,"Correct issue id.");equal(e.projectId,20,"Correct issue pid.");this.$maxSize.remove();try{e=new r.Form({$element:this.$input});ok(!1,"Should not be able to create form wihtout maxSize")}catch(e){}this.$maxSize.appendTo(this.$body);this.$pid.remove();try{e=new r.Form({$element:this.$input});ok(!1,"Should not be able to create form wihtout pid or id.")}catch(e){}}));test("Form getAtlToken",(function(){this.$form.append("<input name='atl_token' value='78'>");var e=new r.Form({$element:this.$input});equal("78",e.getAtlToken(),"Do it get the current token.")}));test("Form setAtlToken",(function(){var t="someTokenValue;",a=e("<input name='atl_token' value='78'>");this.$form.append(a);var o=new r.Form({$element:this.$input});ok(o.setAtlToken(t)===o,"Returning itself?");equal(a.val(),t,"Is token value set correctly?")}));test("Form disable/enable",(function(){var t=e("<input type='submit' name='atl_token' value='78'>"),a=e("<input name='atl_token' value='78'>");this.$form.append(t).append(a);var o=new r.Form({$element:this.$input});o.disable();equal(t.prop("disabled"),!0,"Submit 1 disabled?");equal(a.prop("disabled"),!1,"Submit 2 enabled?");a.attr("disabled","disabled");o.enable();equal(t.prop("disabled"),!1,"Submit 1 enabled?");equal(a.prop("disabled"),!0,"Submit 2 disabled?")}));test("Add Progress",(function(){var e,t=327373.333,a=new r.Form({$element:this.$input});a._addElement=function(t){e=t};r.UploadProgress=function(e){equal(e,t,"Input file is correct?");this.$element=e};var o=a.addProgress(t);ok(o,"Progress actuall returned?");equal(e,t,"Element correct?")}));test("Add Static Progress",(function(){var e,t=327373.333,a=new r.Form({$element:this.$input});a._addElement=function(t){e=t};r.UnknownProgress=function(e){equal(e,t,"Input file is correct?");this.$element=e};var o=a.addStaticProgress(t);ok(o,"Progress actuall returned?");equal(e,t,"Element correct?")}));test("Add Temporary Checkbox",(function(){var e,t,a=327373,o="name",l={},u=new r.Form({$element:this.$input});u._replaceElement=function(r,a){e=r;t=a};u.addTemporaryFileCheckbox(a,o,l);ok(e,"The checkox was actually created?");equal(t,l,"The replacement object was correct");var s=e.children("label");equal(s.text(),o,"Label created with name.");var i=e.children("input[type=checkbox]");equal(i.attr("value"),String(a),"Checkbox value correct.");equal(i.attr("title"),n("upload.checkbox.title"),"Checkbox value correct.")}));test("Add Error",(function(){var e,t,a="name",o={},l=new r.Form({$element:this.$input});l._replaceElement=function(r,a){e=r;t=a};l.addError(a,o);ok(e,"The checkox was actually created?");equal(t,o,"The replacement object was correct");var n=e.find("div");equal(n.text(),a,"Error created.")}));test("Clear Error",(function(){var t=new r.Form({$element:this.$input});this.$form.append(e("<div>").addClass("error").text("bad"));this.$form.append(e("<div>").text("good"));this.$form.append(e("<div>").addClass("error").text("bad"));var a=t.clearErrors();equal(a,t,"Returned self?");equal(this.$form.find("div.error").size(),0,"All Errors removed.");equal(this.$form.find("div").size(),1,"Left around non-errors")}));test("Clone File Input",(function(){var e=new r.Form({$element:this.$input}),t={};e.fileSelector={cloneInput:function(){return t}};var a=e.cloneFileInput();equal(a,t,"Old selector returned?")}));test("On Cancel",(function(){var t=e("<a>").addClass("cancel"),a=e("<a>").addClass("notCancel");this.$form.append(t,a);var o,l=new r.Form({$element:this.$input}),n=0,u=l.onCancel((function(){o=this;n++}));equal(u,l,"Returned self?");a.click();equal(n,0,"Cancel not called.");t.click();equal(n,1,"Cancel called.");equal(o,l,"Is scope correct for callback.")}));test("Replace Element",(function(){var e,t,a=new r.Form({$element:this.$input}),o=0,l=0,n={$element:{replaceWith:function(t){l++;e=t}}},u=function(e){return{id:e,fadeIn:function(){}}};a._addElement=function(e){o++;t=e};var s=u(0);a._replaceElement(s);equal(l,0,"Replace should not have been called.");equal(o,1,"Add should have been called.");equal(t,s,"Added right element?");s=u(1);a._replaceElement(s,{});equal(l,0,"Replace should not have been called.");equal(o,2,"Add should have been called.");equal(t,s,"Added right element?");s=u(2);a._replaceElement(s,n);equal(l,1,"Replace should not have been called.");equal(o,2,"Add should have been called.");equal(e,s,"Replaced right element?")}));module("UnknownProgress",{setup:function(){this.tr=r.Text.tr;r.Text.tr=n},teardown:function(){r.Text.tr=this.tr}});test("Constructor",(function(){var e="fileName",t=new r.UnknownProgress(e);equal(t.$element.attr("title"),n("upload.progress.title.waiting"),"Title is set to waiting.");equal(t.$content.text(),n("upload.file.waiting",e),"Content set correctly to file name.");ok(o(t.$element,t.$cancel),"Cancel added to element.");t.start();equal(t.$element.attr("title"),n("upload.progress.title.running"),"Title is set to running.")}));test("onCancel",(function(){var e=new r.UnknownProgress("Name"),t=0;e.onCancel((function(){t++;equal(this,e,"Callback called with correct scope?")}));e.$cancel.click();equal(t,1,"Callback should have been called.")}));test("start",(function(){var e="fileName",t=new r.UnknownProgress(e);t.start();equal(t.$element.attr("title"),n("upload.progress.title.running"),"Title set to running.");equal(t.$content.text(),e,"Title set to the name.")}));module("UploadProgress",{setup:function(){this.text=r.Text;this.pb=r.ProgressBar;this.timer=r.Timer;r.Text=u},teardown:function(){r.Text=this.text;r.ProgressBar=this.pb;r.Timer=this.timer}});test("Constructor",(function(){var e,t,a="Name",l={name:a,size:500};r.Timer=function(r,a){e=r;t=a};var u=new r.UploadProgress(l);equal(e,u._update,"Timer function correctly set?");equal(t,u,"Timer scope correctly set?");equal(u.total,500,"Total Size set correctly?");equal(u.current,0,"Current Size set correctly?");equal(u.rateNumerator,0,"Rate setup?");equal(u.rateDenominator,0,"Rate setup?");equal(u.name,a,"File name correctly set?");equal(u.$element.attr("title"),n("upload.progress.title.waiting"),"Correct Waiting title.");equal(u.$cancel.text(),n("upload.cancel"),"Cancel Link Name.");equal(u.$content.text(),n("upload.file.waiting",a),"Element text.");ok(o(u.$element,u.$cancel),"Cancel added to element.");ok(o(u.$element,u.$content),"Content added to element.");ok(o(u.$element,u.progress.$element,"Progress added to element."))}));test("Start",(function(){var e,t=new r.UploadProgress({name:"Name",size:500});t._now=function(){return e=(new Date).getTime()};equal(t.started,void 0,"Started should not be defined until started.");equal(t.startedSize,void 0,"SatrtedSize should not be defined until started.");equal(t.start(),t,"Returning self?");equal(t.started,e,"Started was not set correctly.");equal(t.startedSize,0,"StartedSize was not set to zero.")}));test("Update",(function(){var e,t=0,a=new r.UploadProgress({name:"Name",size:500});a._update=function(t){e=t;return a};a.timer={cancel:function(){t++}};equal(a.update(15),a,"Returning self?");equal(e,15,"_update called with value of 15?");equal(t,1,"Timer.cancel called?")}));test("finish",(function(){var e,t=new r.UploadProgress({name:"Name",size:500}),a=0;t.timer={cancel:function(){a++}};t.progress={value:function(t){e=t}};equal(t.finish(),t,"Returning self?");equal(a,1,"Timer cancelled?");equal(e,100,"Progress bar set to 100?")}));test("onCancel",(function(){var e=new r.UploadProgress({name:"Name",size:500}),t=0;e.onCancel((function(){t++;equal(this,e,"Callback called with correct scope?")}));e.$cancel.click();equal(t,1,"Callback should have been called.")}));test("_addRate",(function(){for(var e=new r.UploadProgress({name:"Name",size:500}),t=r.UploadProgress.WEIGHT,a=[0,0,0,5,6,7,8,9,10,11,0,0,68689],o=0,l=0,n=0;n<a.length;n++){o=o*t+a[n];l=l*t+1;e._addRate(a[n]);ok(Math.abs(e.rateNumerator-o)<1e-4,"Numerator is the same? ("+e.rateNumerator+", "+o+").");ok(Math.abs(e.rateDenominator-l)<1e-4,"Denominator is the same? ("+e.rateDenominator+", "+l+").")}}));test("_calcRate",(function(){var e=new r.UploadProgress({name:"Name",size:500});equal(e._calcRate(),0,"Return zero with no data?");e.rateNumerator=5;equal(e._calcRate(),0,"Return zero with no denominator?");e.rateDenominator=1e3;equal(e._calcRate(),.005,"Return the fraction?");e.rateNumerator=4;equal(e._calcRate(),0,"Return zero with small fraction?")}));test("_update",(function(){var e,t,a,o,l={name:"Name",size:1048576},s=new r.UploadProgress(l),i=0,c=0,d=0;s._now=function(){return i};s._calcRate=function(){return c};s._addRate=h("_addRate");s._title=function(e){a=e};s._content=function(e){o=e};s.progress.value=function(e){t=e};s.timer.schedule=function(e){equal(e,r.UploadProgress.UPLOAD_REFRESH,"Timer reset?");d++};var p=0,f=0,m=Math.floor(.005*l.size);equal(s._update(m),s,"Returned self?");equal(t,p,"Percentage is zero?");equal(d,++f,"Timer reset correctly?");equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?");equal(o,l.name,"Content set correctly?");s.start();p=1;m=Math.ceil(.005*l.size);equal(s._update(m),s,"Returned self?");equal(t,1,"Percentage is 1?");equal(d,++f,"Timer reset correctly?");equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?");equal(o,l.name,"Content set correctly?");equal(s.lastUpdate,i,"Last update correct?");equal(s.current,m,"Current set?");equal(s.started,i,"Started correct?");equal(s.startedSize,0,"Started size?");var q=i;i+=1e3;equal(s._update(m),s,"Returned self?");equal(t,p,"Percentage is correct?");equal(d,++f,"Timer reset correctly?");equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?");equal(o,l.name,"Content set correctly?");equal(s.lastUpdate,q,"Last update correct?");equal(s.current,m,"Current set?");equal(s.started,0,"Started correct?");equal(s.startedSize,0,"Started size?");var g=i+=1e3,b=m;equal(s._update(m),s,"Returned self?");equal(t,p,"Percentage is correct?");equal(d,++f,"Timer reset correctly?");equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?");equal(o,l.name,"Content set correctly?");equal(s.lastUpdate,q,"Last update correct?");equal(s.current,m,"Current set?");equal(s.started,g,"Started correct?");equal(s.startedSize,b,"Started size?");i+=2e3;m=r.UploadProgress.DATA_MIN-1;p=Math.round(m/l.size*100);var x=1e3*(m-b)/(i-g);g=i;b=m;q=i;s._addRate=function(t){e=t};equal(s._update(m),s,"Returned self?");equal(t,p,"Percentage is correct?");equal(d,++f,"Timer reset correctly?");equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?");equal(o,l.name,"Content set correctly?");equal(s.lastUpdate,q,"Last update correct?");equal(s.current,m,"Current set?");equal(s.started,g,"Started correct?");equal(s.startedSize,b,"Started size?");ok(Math.abs(e-x)<.005,"Rate correctly added?");x=1e3*(m-b)/((i+=r.UploadProgress.STALLED_TIMEOUT)-g);g=i;b=m;c=0;equal(s._update(m),s,"Returned self?");equal(t,p,"Percentage is correct?");equal(d,++f,"Timer reset correctly?");equal(a,u.tr("upload.progress.title.unknown.stalled",u.currentOutOfTotalSize(m,l.size)),"Title set correctly?");equal(o,u.tr("upload.file.stalled",l.name),"Content set correctly?");equal(s.lastUpdate,q,"Last update correct?");equal(s.current,m,"Current set?");equal(s.started,g,"Started correct?");equal(s.startedSize,b,"Started size?");ok(Math.abs(e-x)<.005,"Rate correctly added?");i+=1e3;m=r.UploadProgress.DATA_MIN;c=25784.3;p=Math.round(m/l.size*100);q=i;var y=(l.size-m)/c;equal(s._update(m),s,"Returned self?");equal(t,p,"Percentage is correct?");equal(d,++f,"Timer reset correctly?");equal(a,u.tr("upload.progress.title.known",c,u.currentOutOfTotalSize(m,l.size),y),"Title set correctly?");equal(o,u.tr("upload.file.remaining",l.name,y),"Content set correctly?");equal(s.lastUpdate,q,"Last update correct?");equal(s.current,m,"Current set?");equal(s.started,g,"Started correct?");equal(s.startedSize,b,"Started size?");i+=500;y=(l.size-m)/(c=48484.25);equal(s._update(),s,"Returned self?");equal(t,p,"Percentage is correct?");equal(d,++f,"Timer reset correctly?");equal(a,u.tr("upload.progress.title.known",c,u.currentOutOfTotalSize(m,l.size),y),"Title set correctly?");equal(o,u.tr("upload.file.remaining",l.name,y),"Content set correctly?");equal(s.lastUpdate,q,"Last update correct?");equal(s.current,m,"Current set?");equal(s.started,g,"Started correct?");equal(s.startedSize,b,"Started size?");i+=r.UploadProgress.STALLED_TIMEOUT;c=33738739.74748;x=1e3*(m-b)/(i-g);g=i;b=m;equal(s._update(m),s,"Returned self?");equal(t,p,"Percentage is correct?");equal(d,++f,"Timer reset correctly?");equal(a,u.tr("upload.progress.title.known.stalled",c,u.currentOutOfTotalSize(m,l.size)),"Title set correctly?");equal(o,n("upload.file.stalled",l.name),"Content set correctly?");equal(s.lastUpdate,q,"Last update correct?");equal(s.current,m,"Current set?");equal(s.started,g,"Started correct?");equal(s.startedSize,b,"Started size?");ok(Math.abs(e-x)<.005,"Rate correctly added?");c=473482743823.3384;p=100;x=1e3*((m=l.size)-b)/((i+=6e4)-g);g=i;b=m;y=1;q=i;equal(s._update(m),s,"Returned self?");equal(t,p,"Percentage is correct?");equal(d,9,"Timer not reset correctly?");equal(a,u.tr("upload.progress.title.known",c,u.currentOutOfTotalSize(m,l.size),y),"Title set correctly?");equal(o,u.tr("upload.file.remaining",l.name,y),"Content set correctly?");equal(s.lastUpdate,q,"Last update correct?");equal(s.current,m,"Current set?");equal(s.started,g,"Started correct?");equal(s.startedSize,b,"Started size?");ok(Math.abs(e-x)<.005,"Rate correctly added?")}));module("ProgressBar");test("Constructor",(function(){var e=/upload-progress-(\d+)/,t=new r.ProgressBar;equal(t.old,0,"Old value is zero.");ok(t.hidden,"The progress state is hidden?");ok(o(t.$element,t.$progress),"The progress bar is in the element");var a=t.$progress.attr("id");ok(e.test(a),"Id Element set");t=new r.ProgressBar;equal(t.old,0,"Old value is zero.");ok(t.hidden,"The progress state is hidden?");ok(o(t.$element,t.$progress),"The progress bar is in the element");var l=t.$progress.attr("id");ok(e.test(l),"Id Element set");notEqual(l,a,"Ids should not have matched.")}));test("Value",(function(){var e,t,a=new r.ProgressBar,o=0,l=0,n=0,u={showPercentage:!1,height:"2px"};a.$progress={show:function(){o++},progressBar:function(r,a){e=r;t=a;l++},fadeOut:function(){n++}};a.value(-1);equal(o,1,"Show was called.");equal(l,0,"Progress should not have been called.");equal(n,0,"Fade out should not have been called.");a.value(0);equal(o,1,"Should only be called once.");equal(l,0,"Progress should not have been called.");equal(n,0,"Fade out should not have been called.");a.value(1);equal(o,1,"Should only be called once.");equal(l,1,"Progress called?.");deepEqual(t,u,"Correct options?");equal(e,1,"Last value correctly updated?");equal(n,0,"Fade out should not have been called.");a.value(1);equal(o,1,"Should only be called once.");equal(l,1,"Progress not called?.");equal(n,0,"Fade out should not have been called.");a.value(101);equal(o,1,"Should only be called once.");equal(l,2,"Progress not called?.");deepEqual(t,u,"Correct options?");equal(e,100,"Last value correctly updated?");equal(n,1,"Fade should be called at 100%.")}));module("FileInput");test("Contructor",(function(){var e={},t=function(){return e},a=[{}];a.parent=t;var o,l,n=new r.FileInput(a,!0);equal(n.multiple,!1,"Multiple set correctly?");(a=[{files:{}}]).attr=function(e,t){o=e;l=t};a.parent=t;n=new r.FileInput(a);equal(o,void 0,"Attribute not set?");equal(l,void 0,"Value not set?");equal(n.multiple,!1,"Multiple set correctly?");equal(n.$container,e,"Parent set correctly?");n=new r.FileInput(a,!0);equal(o,"multiple","Attribute set?");equal(l,"multiple","Value set?");equal(n.multiple,!0,"Multiple set correctly?");equal(n.$container,e,"Parent set correctly?")}));test("onChange",(function(){var e,t,a,o={parent:function(){return o}},l=new r.FileInput(o);l.$element.change=function(t){e=t};l.getFileName=function(){return"FileName"};var n=l.onChange((function(e){t=this;a=e}));equal(n,l,"Returned self?");e.call({});equal(t,l,"Correct callback scope?");equal(a,"FileName","Correct argument?");e.call({files:"Files"});equal(t,l,"Correct callback scope?");equal(a,"FileName","Correct argument?");l.multiple=!0;e.call({files:"Files"});equal(t,l,"Correct callback scope?");equal(a,"Files","Correct argument?")}));test("cloneInput",(function(){var e=0,t=new function t(){this.count=e++;this.bound=!0;this.clone=function(){return new t};this.replaceWith=function(e){this.replace=e};this.parent=function(){return this};this.unbind=function(){this.bound=!1;return this}},a=new r.FileInput(t),o=a.cloneInput();equal(t,o,"Should have returned the old element.");equal(a.$element.count,t.count+1,"Created a new element");equal(o.replace,a.$element,"Replaced correct element?");ok(!o.bound,"Should have been unbound.")}));test("getFileName",(function(){var e,t=!1,a={val:function(){return e},parent:c()},o=new r.FileInput(a);o._isIE=function(){return t};e="abc";equal(o.getFileName(),e,"abc not changed?");e="c:\\fakepATH\\abc";equal(o.getFileName(),"abc","c:\\fakepATH\\abc changed?");e="c:\\fakepath\\";equal(o.getFileName(),"c:\\fakepath\\","c:\\fakepath\\ not changed when last?");e="c:\\fakepath\\c\\drive.txt";equal(o.getFileName(),"c\\drive.txt","\\ not cut when when not IE");t=!0;equal(o.getFileName(),"drive.txt","\\ cut when when IE")}));module("Test AjaxPresenter",{setup:function(){this.form=r.Form;this.fileInput=r.FileInput;this.text=r.Text;this.t=r.Timer;this.ajax=r.AjaxUpload;this.max=r.MAX_UPLOADS;r.Text=u;r.MAX_UPLOADS=2;r.FileInput=d;r.Form=p},teardown:function(){r.Form=this.form;r.FileInput=this.fileInput;r.Text=this.text;r.Timer=this.t;r.AjaxUpload=this.ajax;r.MAX_UPLOADS=this.max}});test("isSupported",(function(){r.AjaxUpload.isSupported=h("isSupported");ok(!r.AjaxPresenter.isSupported(),"No argument is not supported?");ok(!r.AjaxPresenter.isSupported(null),"Null argument is not supported?");ok(!r.AjaxPresenter.isSupported([]),"Empty not supported.");ok(!r.AjaxPresenter.isSupported([{}]),"No files not supported.");var e=!1;r.AjaxUpload.isSupported=function(){return e};ok(!r.AjaxPresenter.isSupported([{files:"files"}]),"Not supported when AJAX upload is not supported.");e=!0;ok(r.AjaxPresenter.isSupported([{files:"files"}]),"Supported?")}));test("Constructor",(function(){var e={},t=new r.AjaxPresenter(e);equal(t.form.fileSelector.element,e,"File input correctly wrapped!");ok(t.form.fileSelector.multiple,"Multiple files added?")}));test("Cancel",(function(){var e=new r.AjaxPresenter({});e.form.disable();e._cancel();ok(!e.form.disabled,"Form should not be disabled.")}));test("_attach",(function(){var e=new r.AjaxPresenter({}),t=e.form,a=t.fileSelector,o=0,n=function(){equal(t.clearErrors.count,++o,"Called clear errors?");equal(a.clear.count,o,"Called clear?");equal(a.focus.count,o,"Called focus?")},u=e._uploadFiles=h("_uploadFiles"),s=e._checkAndFilterFiles=h("_checkAndFilterFiles");e._attach();n();ok(!t.disabled,"Form still enabled?");e._attach([]);n();var i=[new l("name",3637)];s=e._checkAndFilterFiles=c(null);e._attach(i);n();equal(s.count,1,"_checkAndFilterFiles called?");deepEqual(s.lastArgs,[i],"_checkAndFilterFiles called with correct arguments?");var d=(i=[new l("name",3637),new l("name2",38383829)]).slice(0,1);u=e._uploadFiles=c(null);s=e._checkAndFilterFiles=c(d);e._attach(i);n();equal(s.count,1,"_checkAndFilterFiles called?");equal(u.count,1,"_uploadFiles called?");deepEqual(s.lastArgs,[i],"_checkAndFilterFiles called with correct arguments?");deepEqual(u.lastArgs,[d],"_uploadFiles called with correct arguments?")}));test("_checkAndFilterFiles",(function(){var e=new r.AjaxPresenter({}),t=e.form,a=t.maxSize+1,o=new l("zero",0),n=new l("big",a),s=[o,n],i=e._checkAndFilterFiles(s);deepEqual(t.errors,["upload.empty.file,zero","upload.too.big,big,"+a.toFixed(4)+","+t.maxSize.toFixed(4)],"Errors correctly added?");equal(i,null,"Null returned for no good files?");t.errors=[];var c=new l("size",t.maxSize),d=new l("size",1),p=new l("size",t.maxSize/2);s=[d,o,p,n,c];i=e._checkAndFilterFiles(s);deepEqual(t.errors,["upload.empty.file,zero","upload.too.big,big,"+a.toFixed(4)+","+t.maxSize.toFixed(4)],"Errors correctly added?");deepEqual(i,[d.toSimple(),p.toSimple(),c.toSimple()],"Good files returned?");s=[];for(var h=[],f=0;f<r.AjaxPresenter.MAX_SELECTED_FILES;f++){var m=new l("File"+f,56);s.push(m);h.push(m.toSimple())}t.errors=[];i=e._checkAndFilterFiles(s);deepEqual(t.errors,[],"No errors added?");deepEqual(i,h,"Good files returned?");s.push(new l("FileThatBrokeTheCamelsBack",t.maxSize+1e3));i=e._checkAndFilterFiles(s);deepEqual(t.errors,[u.tr("upload.error.too.many.files",s.length,s.length-1)],"Too many error added?");equal(i,null,"No files returned?")}));test("_createSubmitData",(function(){var e=new r.AjaxPresenter({}),t=e.form;t.projectId=38383838302020;var a={projectId:t.projectId,atl_token:t.nextToken,formToken:t.formToken};deepEqual(e._createSubmitData(),a,"Generated correct data?");t.issueId=5858658;a={issueId:t.issueId,atl_token:t.nextToken,formToken:t.formToken};deepEqual(e._createSubmitData(),a,"Generated correct data?");delete t.projectId;a={issueId:t.issueId,atl_token:t.nextToken,formToken:t.formToken};deepEqual(e._createSubmitData(),a,"Generated correct data?");delete t.issueId;try{e._createSubmitData();ok(!1,"Did not get exception on bad state!")}catch(e){}}));test("_checkStatus",(function(){var e=new r.AjaxPresenter({}),t={name:"name"};equal(e._getErrorFromStatus(400,t),u.tr("upload.error.badrequest",t.name),"Error for bad request?");equal(e._getErrorFromStatus(401,t),u.tr("upload.error.auth",t.name),"Error for bad auth?");equal(e._getErrorFromStatus(0,t),u.tr("upload.error.server.no.reply",t.name),"Error for bad auth?");var a=40383;equal(e._getErrorFromStatus(a,t),u.tr("upload.error.unknown.status",t.name,a),"Error for unexpected status?");a=475858;equal(e._getErrorFromStatus(a,t),u.tr("upload.error.unknown.status",t.name,a),"Error for unexpected status?")}));test("_uploadFiles",(function(){var t=new r.AjaxPresenter({}),a=t.form,o={data:!0},n=new l("one",1),s=n.toSimple(),i=new l("two",2).toSimple(),d=new l("three",3).toSimple();t._createSubmitData=c(o);t._getErrorFromStatus=h("_checkStatus");var p=!0,f=[];t._addUpload=function(e){f.push(e);return p};var m=!1,q=[];t._finishUpload=function(e){q.push(e);return m};var g=[];r.AjaxUpload=function(r){this.running=!1;g.push(this);var a=r.scope;equal(a,t,"Correct scope for AJAXUpload?");for(var o in r)if("scope"!==o){var l=r[o];l.apply&&l.call?this[o]=e.proxy(l,a):this[o]=l}this.upload=function(){this.running=!0};this.abort=function(){this.aborted=!0}};var b=[];r.Timer=function(e){this.fn=e;this.cancel=c(this);this.schedule=c(this);this.trigger=function(){this.fn.call(this)};b.push(this)};var x=function(){var e=b.length,t=[];equal(g.length,e,"Created Uploads?");equal(a.progress.length,e,"Created progress bars?");for(var r=0;r<e;r++)t.push({timer:b[r],upload:g[r],progress:a.progress[r]});b=[];g=[];a.progress=[];return t},y=function(t,a,l){for(var n=0;n<t.length;n++){var u=t[n],s=a[n];equal(u.progress.hidden,!0,"Is Progress Hidden?");equal(u.progress.started,!1,"Progress not started!");equal(u.progress.value,1/0,"No value?");equal(u.upload.file,s.file,"Correct File?");deepEqual(u.upload.params,e.extend({filename:s.name,size:s.size},o),"Same params?");equal(u.upload.url,r.AjaxPresenter.DEFAULT_URL,"Correct URL?");if(void 0===l||l){equal(u.timer.schedule.count,1,"Timer called?");ok(!u.timer.cancel.count,"Timer not cancelled called?");deepEqual(u.timer.schedule.lastArgs,[r.DISPLAY_WAIT],"Timer started with correct timeout?")}}},v=function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r].upload;t.push(a)}deepEqual(f,t,"Added expected uploads?");f=[]},k=function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r].upload;t.push(a)}deepEqual(q,t,"Expected uploads finished?");q=[]},T=[s];t._uploadFiles(T);var A=x();equal(A.length,1,"Added the upload?");var w=A[0];y(A,T);v(A);k([]);ok(a.disabled,"Is form disabled?");w.timer.trigger();ok(!w.progress.hidden,"Progress bar shown after timeout.");w.upload.before();ok(w.progress.started,"Progress should have started.");w.upload.progress(5);equal(w.progress.value,5,"Progress reported?");w.upload.success({errorMessage:"Error"},304);deepEqual(a.errors,["Error|"+s.name],"Error correctly reported?");equal(a.lastReplace,w.progress,"Progress bar replaced with error?");a.errors=[];w.upload.success({errorMessage:"Token Error",token:"someKindOfToken"},304);deepEqual(a.errors,["Token Error|"+s.name],"Error correctly reported?");equal(a.lastReplace,w.progress,"Progress bar replaced with error?");equal(a.lastToken,"someKindOfToken","Was the token replaced?");var E=t._getErrorFromStatus=c("Status Error");a.errors=[];w.upload.success({error:"Error"},405);deepEqual(a.errors,["Status Error"],"Error correctly reported?");equal(a.lastReplace,w.progress,"Progress bar replaced with error?");deepEqual(E.lastArgs,[405,s],"Error from status?");equal(E.count,1,"Error from status?");a.errors=[];w.upload.success({id:1,name:"name"},201);deepEqual(a.errors,[],"No errors to report?");deepEqual(a.addTemporaryFileCheckbox.lastArgs,[1,"name",w.progress,n],"Added temporary checkbox?");a.errors=[];w.upload.success({id:1234},201);deepEqual(a.errors,[u.tr("upload.error.bad.response",s.name)],"Error correctly reported?");equal(a.lastReplace,w.progress,"Progress bar replaced with error?");a.errors=[];w.upload.success({name:"name"},201);deepEqual(a.errors,[u.tr("upload.error.bad.response",s.name)],"Error correctly reported?");equal(a.lastReplace,w.progress,"Progress bar replaced with error?");E=t._getErrorFromStatus=c("Bad Status Found");a.errors=[];w.upload.error("Bad Ajax Request",204);deepEqual(a.errors,["Bad Status Found"],"Error correctly reported?");equal(a.lastReplace,w.progress,"Progress bar replaced with error?");deepEqual(E.lastArgs,[204,s],"Error from status?");equal(E.count,1,"Error from status?");E=t._getErrorFromStatus=h("_getErrorFromStatus");a.errors=[];w.upload.error("Client Error",-1);deepEqual(a.errors,["Client Error"],"Error from client correctly reported?");equal(a.lastReplace,w.progress,"Progress bar replaced with error?");w.progress.triggerCancel();ok(w.upload.aborted,"Was aborted?");m=!0;w.upload.after();equal(w.timer.cancel.count,1,"Timer cancelled?");ok(w.progress.finished,"Progress finished?");ok(w.progress.removed,"Progress removed?");k(A);ok(a.disabled,"Form not enabled becasue there are still running builds.");m=!1;w.upload.after();equal(w.timer.cancel.count,2,"Timer cancelled?");ok(w.progress.finished,"Progress finished?");ok(w.progress.removed,"Progress removed?");k(A);ok(!a.disabled,"Form enabled after completion.");p=!1;a.disabled=!1;T=[s,i,d];t._uploadFiles(T);A=x();equal(A.length,3,"Added the upload?");y(A,T,!1);v(A);k([]);ok(!a.disabled,"Is form enabled?");p=!0;m=!1;a.errors=[];a.addTemporaryFileCheckbox.count=0;T=[s];t._uploadFiles(T);A=x();equal(A.length,1,"Added the upload?");y(A,T);v(A);k([]);w=A[0];ok(a.disabled,"Is form disabled?");t.cancelled=!0;w.timer.trigger();ok(w.progress.hidden,"Don't display progress bar when hidden?");w.upload.before();ok(!w.progress.started,"Progress should not have started.");w.upload.progress(5);equal(w.progress.value,1/0,"Progress ignored reported?");w.upload.success({id:1,name:"name"});equal(a.addTemporaryFileCheckbox.count,0,"Didn't add temporary checkbox?");w.upload.error("Bad Ajax Request");deepEqual(a.errors,[],"Didn't add error?");w.upload.after();equal(w.timer.cancel.count,1,"Timer cancelled?");ok(w.progress.finished,"Progress finished?");ok(w.progress.removed,"Progress removed?");k([])}));module("Test FormPresenter",{setup:function(){this.form=r.Form;this.fileInput=r.FileInput;this.text=r.Text;this.t=r.Timer;this.upload=r.FormUpload;this.max=r.MAX_UPLOADS;r.Text=u;r.MAX_UPLOADS=2;r.FileInput=d;r.Form=p},teardown:function(){r.Form=this.form;r.FileInput=this.fileInput;r.Text=this.text;r.Timer=this.t;r.FormUpload=this.upload;r.MAX_UPLOADS=this.max}});test("Constructor",(function(){var e={},t=new r.FormPresenter(e);equal(t.form.fileSelector.element,e,"File input correctly wrapped!");ok(!t.form.fileSelector.multiple,"Simple files only?")}));test("Cancel",(function(){var e=new r.AjaxPresenter({});e.form.disable();e._cancel();ok(!e.form.disabled,"Form should not be disabled.")}));test("_createSubmitData",(function(){var e=new r.FormPresenter({}),t=e.form;t.projectId=38383838302020;var a={projectId:t.projectId,atl_token:t.nextToken,create:!0,formToken:t.formToken};deepEqual(e._createSubmitData(),a,"Generated correct data?");t.issueId=5858658;a={id:t.issueId,atl_token:t.nextToken,formToken:t.formToken};deepEqual(e._createSubmitData(),a,"Generated correct data?");delete t.projectId;a={id:t.issueId,atl_token:t.nextToken,formToken:t.formToken};deepEqual(e._createSubmitData(),a,"Generated correct data?");delete t.issueId;try{e._createSubmitData();ok(!1,"Did not get exception on bad state!")}catch(e){}}));test("_attach",(function(){var t=new r.FormPresenter({$element:{}}),a=t.form,o={data:!0};t._createSubmitData=c(o);var l=[];r.FormUpload=function(r){l.push(this);var a=r.scope;equal(a,t,"Correct scope for FormUpload?");for(var o in r)if("scope"!==o){var n=r[o];n&&n.apply&&n.call?this[o]=e.proxy(n,a):this[o]=n}this.abort=c("abort")};var n=[];t._addUpload=function(e){n.push(e);return arguments.callee.returnValue};t._addUpload.returnValue=!0;var u=[];t._finishUpload=function(e){u.push(e);return arguments.callee.returnValue};t._finishUpload.returnValue=!1;var s=function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r].upload;t.push(a)}deepEqual(u,t,"Expected uploads finished?");u=[]},i=[];r.Timer=function(e,r){equal(r,t,"Correct timer scope?");this.fn=e;this.cancel=c(this);this.schedule=c(this);this.trigger=function(){this.fn.call(r,this)};i.push(this)};var d=0,p=function(e,u){u=void 0===u||u;d++;var s=a.clearErrors.count+1||1;t._attach(e);var c=function(){var e=i.length,t=[];equal(l.length,e,"Created Uploads?");equal(a.progress.length,e,"Created progress bars?");for(var r=0;r<e;r++)t.push({timer:i[r],upload:l[r],progress:a.progress[r]});i=[];l=[];a.progress=[];return t}();!function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r].upload;t.push(a)}deepEqual(n,t,"Added expected uploads?");n=[]}(c);equal(c.length,1,"Created one upload?");var p=c[0];equal(a.clearErrors.count,s,"Cleared the errors?");equal(a.fileSelector.focus.count,d,"Focused the element?");equal(p.progress.hidden,!0,"Is Progress Hidden?");equal(p.progress.started,!1,"Is Progress started?");deepEqual(p.upload.$input,{count:d,cloneInput:!0},"Correct input?");deepEqual(p.upload.params,o,"Same params?");equal(p.upload.url,r.FormPresenter.DEFAULT_URL,"Correct URL?");if(u){equal(p.timer.schedule.count,1,"Timer called?");ok(!p.timer.cancel.count,"Timer not cancelled called?");deepEqual(p.timer.schedule.lastArgs,[r.DISPLAY_WAIT],"Timer started with correct timeout?")}equal(a.disabled,u,"Form in correct state?");return p},h="file",f=p(h);f.timer.trigger();equal(f.progress.hidden,!1,"Progress shown?");f.upload.before();equal(f.progress.started,!0,"Progress started?");f.upload.success({errorMsg:"Error"});deepEqual(a.errors,["Error|"+h],"Error correctly reported?");equal(a.lastReplace,f.progress,"Progress bar replaced with error?");a.errors=[];f.upload.success({error:"Error"});deepEqual(a.errors,[r.Text.tr("upload.error.bad.response",h)],"Error correctly reported?");equal(a.lastReplace,f.progress,"Progress bar replaced with error?");a.errors=[];f.upload.success({id:1,name:"name"});deepEqual(a.errors,[],"No errors to report?");deepEqual(a.addTemporaryFileCheckbox.lastArgs,[1,"name",f.progress],"Added temporary checkbox?");a.errors=[];f.upload.error("Bad Ajax Request");deepEqual(a.errors,[r.Text.tr("upload.error.unknown",h)],"Error correctly reported?");equal(a.lastReplace,f.progress,"Progress bar replaced with error?");a.errors=[];f.upload.error("ssssssSecurityTokenMissingssss");deepEqual(a.errors,[r.Text.tr("upload.xsrf.timeout",h)],"Error correctly reported?");equal(a.lastReplace,f.progress,"Progress bar replaced with error?");f.upload.after();s([f]);equal(f.timer.cancel.count,1,"Timer cancelled?");ok(f.progress.removed,"Progress removed?");ok(!a.disabled,"Form enabled after completion.");(f=p(h="file2.txt")).progress.triggerCancel();equal(f.upload.abort.count,1,"Abort was called?");t._addUpload.returnValue=!1;t.form.enable();f=p(h="WontAttachMe",!1);f=p(h,!1);t._addUpload.returnValue=!0;f=p(h,!0);t._finishUpload.returnValue=!0;f.upload.after();s([f]);ok(a.disabled,"Form not enabled because there are still running uploads.");t._finishUpload.returnValue=!1;a.addTemporaryFileCheckbox.count=0;a.errors=[];f=p("cancel");t.cancelled=!0;f.timer.trigger();ok(f.progress.hidden,"Don't display progress bar when cancelled?");f.upload.before();ok(!f.progress.started,"Don't start progress bar when cancelled?");f.upload.success({id:1,name:"name"});equal(a.addTemporaryFileCheckbox.count,0,"Didn't add temporary checkbox?");f.upload.error("Bad Ajax Request");deepEqual(a.errors,[],"Didn't add error?");f.upload.after();equal(f.timer.cancel.count,1,"Timer cancelled?");ok(f.progress.removed,"Progress removed?")}));module("Presenter",{setup:function(){this.max=r.MAX_UPLOADS;r.MAX_UPLOADS=2},teardown:function(){r.MAX_UPLOADS=this.max}});test("removeFromArray",(function(){var e=r.Presenter.removeFromArray,t=[1,2,3,4];equal(e(t,0),null,"Remove nothing?");deepEqual(t,[1,2,3,4],"Remove nothing?");equal(e(t,1),1,"Remove 1?");deepEqual(t,[2,3,4],"Array correctly altered?");equal(e(t,3),3,"Remove 3?");deepEqual(t,[2,4],"Array correctly altered?");equal(e(t,4),4,"Remove 4?");deepEqual(t,[2],"Array correctly altered?");equal(e(t,2),2,"Remove 2?");deepEqual(t,[],"Array correctly altered?");equal(e(t,2),null,"Remove from empty does nothing?");deepEqual(t,[],"Array not changed?")}));test("_addUpload & _finishUpload",(function(){var e=function(){return{upload:c("upload"),abort:h("abort")}},t=new r.Presenter,a=new e,o=new e,l=new e,n=new e;equal(t._addUpload(a),!0,"Correct return?");deepEqual(t.waiting,[],"No Waiting uploads.");deepEqual(t.running,[a],"Running uploads?");equal(a.upload.count,1,"Upload called?");equal(t._addUpload(o),!0,"Correct return?");deepEqual(t.waiting,[],"No Waiting uploads.");deepEqual(t.running,[a,o],"Running uploads?");equal(a.upload.count,1,"Upload called?");equal(o.upload.count,1,"Upload called?");equal(t._addUpload(l),!0,"Correct return?");deepEqual(t.waiting,[l],"Waiting uploads?");deepEqual(t.running,[a,o],"Running uploads?");equal(a.upload.count,1,"Upload called?");equal(o.upload.count,1,"Upload called?");equal(l.upload.count,0,"Upload not called?");equal(t._finishUpload(a),!0,"Correct return?");deepEqual(t.waiting,[],"No Waiting uploads?");deepEqual(t.running,[o,l],"Running uploads?");equal(a.upload.count,1,"Upload called?");equal(o.upload.count,1,"Upload called?");equal(l.upload.count,1,"Upload called?");equal(t._addUpload(n),!0,"Correct return?");deepEqual(t.waiting,[n],"Waiting uploads?");deepEqual(t.running,[o,l],"Running uploads?");equal(o.upload.count,1,"Upload called?");equal(l.upload.count,1,"Upload called?");equal(n.upload.count,0,"Upload not called?");equal(t._finishUpload(new e),!0,"Correct return?");deepEqual(t.waiting,[n],"Waiting uploads not touched?");deepEqual(t.running,[o,l],"Running uploads not touched?");equal(o.upload.count,1,"Upload called?");equal(l.upload.count,1,"Upload called?");equal(n.upload.count,0,"Upload not called?");equal(t._finishUpload(n),!0,"Correct return?");deepEqual(t.waiting,[],"No waiting uploads");deepEqual(t.running,[o,l],"Running uploads?");equal(o.upload.count,1,"Upload called?");equal(l.upload.count,1,"Upload called?");equal(t._finishUpload(o),!0,"Correct return?");deepEqual(t.waiting,[],"No waiting uploads");deepEqual(t.running,[l],"Running uploads?");equal(o.upload.count,1,"Upload called?");equal(l.upload.count,1,"Upload called?");equal(t._finishUpload(l),!1,"Correct return?");deepEqual(t.waiting,[],"Not waiting uploads");deepEqual(t.running,[],"No running uploads");equal(o.upload.count,1,"Upload called?");equal(l.upload.count,1,"Upload called?")}));test("_cancel",(function(){var e=function(){return{upload:h("upload"),abort:c("abort")}},t=new r.Presenter,a=new e,o=new e,l=new e,n=new e;t.running=[a,l];t.waiting=[n,o];equal(t.cancelled,!1,"Not cancelled?");t._cancel();equal(t.cancelled,!0,"Cancelled now?");deepEqual(t.running,[],"Nothing running?");deepEqual(t.waiting,[],"Nothing waiting?");equal(a.abort.count,1,"Abort called?");equal(o.abort.count,1,"Abort called?");equal(l.abort.count,1,"Abort called?");equal(n.abort.count,1,"Abort called?")}));module("InlineAttach",{setup:function(){this.ajax=r.AjaxPresenter;this.form=r.FormPresenter;this.text=r.Text;r.Text=u},teardown:function(){r.AjaxPresenter=this.ajax;r.FormPresenter=this.form;r.Text=this.text}});test("rescope",(function(){var t=r.rescope;equal(t(),e.noop,"No arg returns noop function.");equal(t(null),e.noop,"Null arg return noop function.");var a={},o={},l=c(a),n=t(l);equal(n.call(o),a,"Correct result?");equal(l.count,1,"Called once?");equal(l.lastScope,o,"Correct scope?");n=t(l,o);equal(n.call({"never the same":"ssj"}),a,"Correct result?");equal(l.count,2,"Called again?");equal(l.lastScope,o,"Correct scope?")}));test("copyArrayLike",(function(){var e=r.copyArrayLike,t=function(){for(var e=0;e<arguments.length;e++)this[e]=arguments[e];this.length=arguments.length};deepEqual(e(new t),[],"Empty works?");deepEqual(e(new t(1)),[1],"One element works?");deepEqual(e(new t(1,!0,"hello")),[1,!0,"hello"],"Multiple elements works?")}));test("Constructor",(function(){r.AjaxPresenter=c("ajax");r.FormPresenter=c("form");r.AjaxPresenter.isSupported=c(!0);new r("<div/>");equal(r.AjaxPresenter.count,1,"Ajax presenter created?");equal(r.FormPresenter.count,0,"Form presenter not created?");r.AjaxPresenter.isSupported=c(!1);new r("<div/>");equal(r.AjaxPresenter.count,1,"Ajax presenter not created?");equal(r.FormPresenter.count,1,"Form presenter created?")}))}));