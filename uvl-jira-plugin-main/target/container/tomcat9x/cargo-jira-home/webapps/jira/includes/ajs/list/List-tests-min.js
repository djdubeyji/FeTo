AJS.test.require(["jira.webresources:list"],(function(){"use strict";require(["jira/ajs/list/list","jira/ajs/list/item-descriptor","jquery","underscore"],(function(t,e,i,s){module("AJS.List",{buildList:function(l){var n=i("#qunit-fixture"),a={containerSelector:n,delegateTarget:n,stallEventBind:!1,expandAllResults:!0};this.options=i.extend(!0,a,l);var u={},r=[];return{withMaxResultsDisplayed:function(t){u.maxInlineResultsDisplayed=t;return this},withExpandAllResults:function(t){u.expandAllResults=t;return this},withTotalResults:function(t){r.push((function(i){for(var s=[],l=0;l<t;l++)s.push(new e({highlighted:!0,label:"Label #"+l,title:"Title #"+l}));i.generateListFromJSON(s,"Label")}));return this},withData:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"label";r.push((function(i){i.generateListFromJSON(t,e)}));return this},withEventsEnabled:function(){r.push((function(t){t.enable()}));return this},withScrollAtItem:function(t){r.push((function(){var e=i.Event("keydown");e.which=i.ui.keyCode.DOWN;for(var s=0;s<t;s++)n.trigger(e)}));return this},withLoopThroughOptions:function(){u.loopThroughOptions=!0;return this},withPrioritizeExactMatches:function(){u.prioritizeExactMatches=!0;return this},withHideSuggestionCount:function(){u.hideSuggestionCount=!0;return this},build:function(){var e=new t(s.defaults(u,a));s.each(r,(function(t){t(e)}));return e}}},pressDownArrowOn:function(t){var e=i.Event("keydown");e.which=i.ui.keyCode.DOWN;t.trigger(e)}});test("List should use title from AJS.ItemDescriptor",(function(){var t=[new e({label:"Label with title",title:"some tile"}),new e({label:"Label without title"}),new e({label:"Label with empty tile",title:""})];this.buildList().withData(t).build();var s=i("#qunit-fixture").find(".aui-list-item-link");equal(s.length,3,"There should be three links rendered");equal(i(s.get(0)).prop("title"),t[0].title(),"Link have valid title");equal(i(s.get(0)).text(),t[0].label(),"Link have valid text");equal(i(s.get(1)).text(),t[1].label(),"Link have valid text");equal(i(s.get(2)).text(),t[2].label(),"Link have valid text")}));test("List should use passed in HTML tag for items",(function(){var t=[new e({label:"Label with title",title:"some tile"})];this.buildList({listItemTag:"span"}).withData(t).build();var s=i("#qunit-fixture").find(".aui-list-item-link");equal(s.length,1,"There should be one link rendered");equal(i(s.get(0)).prop("tagName"),"SPAN","Passed tag is used for links");equal(i(s.get(0)).attr("role"),"presentation","Items have valid roles");equal(i(s.get(0)).attr("class"),"aui-list-item-link","Items have valid class")}));test("List should use anchor for items if no HTML tag was passed as option",(function(){var t=[new e({label:"Label with title",title:"some tile"})];this.buildList().withData(t).build();var s=i("#qunit-fixture").find(".aui-list-item-link");equal(s.length,1,"There should be one link rendered");equal(i(s.get(0)).prop("tagName"),"A","Anchor is a default tag for links");equal(i(s.get(0)).attr("role"),"presentation","Items have valid roles");equal(i(s.get(0)).attr("class"),"aui-list-item-link","Items have valid class")}));test("List should prepend passed prefix to subtext",(function(){var t=[new e({label:"main text",keywords:"subtext Label"})];this.buildList({subtextPrefix:" £@! some prefix -"}).withData(t).build();var s=i("#qunit-fixture .aui-item-text"),l=i("#qunit-fixture .aui-item-suffix");equal(i(s.get(0)).text(),"main text","Main text is set correctly");equal(i(l.get(0)).text()," £@! some prefix - subtext Label","Subtext is prepended with passed prefix")}));test("Protect against XSS vulnerability injected in descriptor icon",(function(){var t={xssCall:function(){}};sinon.mock(t).expects("xssCall").never();window.xssCall=t.xssCall;var e=[new AJS.ItemDescriptor({label:"Label with title",title:"some tile",icon:function(){return'genericissue.png"><script>window.xssCall()<\/script>'}})];this.buildList().withData(e).build();window.xssCall=null;expect(0)}));test("It limits the number of results displayed",(function(){this.buildList().withMaxResultsDisplayed(10).withTotalResults(20).build();var t=i("#qunit-fixture");equal(t.find(".aui-list-item-link").length,10,"Only 10 links are rendered")}));test("It displays a 'View more' link when there is too many results if expandAllResults is true",(function(){this.buildList().withMaxResultsDisplayed(10).withExpandAllResults(!0).withTotalResults(20).build();var t=i("#qunit-fixture");equal(t.find("button.view-all").length,1,"There is one 'view-all' button")}));test("It does not display a 'View more' link when there is too many results if expandAllResults is false",(function(){this.buildList().withMaxResultsDisplayed(10).withExpandAllResults(!1).withTotalResults(20).build();var t=i("#qunit-fixture");equal(t.find("button.view-all").length,0,"There is not 'view-all' button")}));test("'View more' expand the list so it contains all the results",(function(){this.buildList().withMaxResultsDisplayed(10).withTotalResults(20).build();var t=i("#qunit-fixture");t.find("button.view-all").click();equal(t.find(".aui-list-item-link").length,20,"All the results are rendered")}));test("In a limited list, scrolling down using arrow keys expand all the list when reaching the last item if expandAllResults is true",(function(){this.buildList().withMaxResultsDisplayed(3).withTotalResults(6).withEventsEnabled().withScrollAtItem(2).build();var t=i("#qunit-fixture");this.pressDownArrowOn(t);equal(t.find(".aui-list-item-link").length,6,"All the results are rendered");equal(t.find("button.view-all").length,0,"The 'view-all' link is removed")}));test("In a limited list, scrolling down using arrow keys does not expand the list when reaching the last item if expandAllResults is false",(function(){this.buildList().withMaxResultsDisplayed(3).withTotalResults(6).withExpandAllResults(!1).withEventsEnabled().withScrollAtItem(2).build();var t=i("#qunit-fixture");this.pressDownArrowOn(t);equal(t.find(".aui-list-item-link").length,3,"Three links are rendered")}));test("It triggers an event when item is active/focused.",(function(){var t=this.buildList().withMaxResultsDisplayed(3).withTotalResults(6).withExpandAllResults(!1).withLoopThroughOptions().withEventsEnabled().withScrollAtItem(2).build(),e=sinon.spy();t.bind("itemFocus",e);var s=i("#qunit-fixture");this.pressDownArrowOn(s);this.pressDownArrowOn(s);sinon.assert.calledTwice(e);equal(e.secondCall.args[1],t.getFocused()[0],"Correct item is passed as an argument.")}));test("Stops at the last element by default",(function(){this.buildList().withEventsEnabled().withMaxResultsDisplayed(3).withTotalResults(3).withExpandAllResults(!1).withScrollAtItem(2).build();var t=i("#qunit-fixture");this.pressDownArrowOn(t);ok(t.find("ul li:last-child").hasClass("active"))}));test("Cycles back from the top when configured",(function(){this.buildList().withEventsEnabled().withMaxResultsDisplayed(3).withTotalResults(3).withExpandAllResults(!1).withScrollAtItem(2).withLoopThroughOptions().build();var t=i("#qunit-fixture");this.pressDownArrowOn(t);ok(t.find("ul li:first-child").hasClass("active"))}));test("when prioritizeExactMatches is false should not change the order of items in the list",(function(){var t=["base type","baseline type","color type","custom type","magic type","type"].map((function(t){return new e({highlighted:!0,label:t,title:t})}));this.buildList().withMaxResultsDisplayed(5).withExpandAllResults(!0).withData(t,"type").build();var s=i("#qunit-fixture").find("ul li:first-child");equal(s.text(),"base type","The first item in the list is not changed")}));test("when prioritizeExactMatches is true should set exact matches first in the list",(function(){var t=["base type","baseline type","color type","custom type","magic type","new type","old type","solo type","some type","system type","type","uber type","Type","uniform type"].map((function(t){return new e({highlighted:!0,label:t,title:t})}));this.buildList().withPrioritizeExactMatches().withMaxResultsDisplayed(5).withExpandAllResults(!0).withData(t,"type").build();var s=i("#qunit-fixture"),l=s.find("ul li:first-child"),n=s.find("ul li:nth-child(2)"),a=s.find("ul li:nth-child(3)");equal(l.text(),"type","First exact match is first in the list");equal(n.text(),"Type","Another exact match is second in the list");equal(a.text(),"base type","Next item in the list is the first from the filtered results")}));test("when hideSuggestionCount is false should display the default footer message with suggestion count",(function(){var t=["base type","baseline type","color type","custom type","magic type","type"].map((function(t){return new e({highlighted:!0,label:t,title:t})}));this.buildList().withMaxResultsDisplayed(5).withExpandAllResults(!1).withData(t,"type").build();var s=i("#qunit-fixture").find("ul li:last-child");equal(s.text(),"common.concepts.too.many.matches","The footer item has the default message")}));test("when hideSuggestionCount is true should display the footer message without suggestion count",(function(){var t=["base type","baseline type","color type","custom type","magic type","new type","old type","solo type","some type","system type","type","uber type","Type","uniform type"].map((function(t){return new e({highlighted:!0,label:t,title:t})}));this.buildList().withHideSuggestionCount().withExpandAllResults(!1).withMaxResultsDisplayed(5).withData(t,"type").build();var s=i("#qunit-fixture").find("ul li:last-child");equal(s.text(),"common.concepts.continue.typing.to.refine.further","The footer item has correct message")}))}))}));