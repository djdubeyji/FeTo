var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};AJS.test.require(["jira.webresources:inline-layer","jira.webresources:ajs-underscorejs-amd-shim"],(function(){"use strict";var e,t=require("jira/lib/class"),i=require("jira/ajs/contentretriever/content-retriever"),o=require("jira/ajs/layer/inline-layer/options-descriptor"),n=require("jira/ajs/layer/inline-layer/window-positioning"),s=require("jira/ajs/layer/inline-layer/standard-positioning"),r=require("jira/ajs/layer/layer-constants"),l=require("underscore"),a=require("jquery");var h={isLeftAligned:function(e,t,i){i=i||"should be left-aligned";equal(t.offset().left,e.offset().left,i)},isRightAligned:function(e,t,i){i=i||"should be right-aligned";equal(t.offset().left+t.outerWidth(!0),e.offset().left+e.outerWidth(!0),i)},isOnLeftSide:function(e,t,i){i=i||"should be on the left of the trigger";equal(t.offset().left+t.outerWidth(!0),e.offset().left,i)},isOnRightSide:function(e,t,i){i=i||"should be on the right of the trigger";equal(t.offset().left,e.offset().left+e.outerWidth(!0),i)},isUnderneath:function(e,t,i){i=i||"should have been placed underneath the trigger";equal(t.offset().top,e.offset().top+e.outerHeight(!0),i)},isAbove:function(e,t,i){i=i||"should have been placed above the trigger";equal(t.offset().top+t.height(),e.offset().top,i)},isNearBottom:function(e,t){t=t||"should have been placed near the bottom of the page";equal(e.offset().top+e.outerHeight(!0),a(window).height()-0,t)}};module("jira/ajs/layer/inline-layer",{setup:function(){this.context=AJS.test.mockableModuleContext();this.context.mock("jira/ajs/layer/inline-layer/options-descriptor",o);this.context.mock("jira/ajs/contentretriever/content-retriever",i);this.$field=a('<button type="button">Offset target</button>').appendTo(document.body);this.$field.css({position:"absolute",width:"100px",height:"100px"})},teardown:function(){this.$field.remove();if(this.__layer){this.__layer.hide();this.clock&&this.clock.tick(0);this.__layer.layer().remove()}},makeLayer:function(t){t="object"===(void 0===t?"undefined":_typeof(t))?t:{};e=this.context.require("jira/ajs/layer/inline-layer");this.__layer=new e(l.extend({content:"<p>dummy</p>",offsetTarget:this.$field},t));this.__layer.layer().css({padding:"0px",margin:"0px",border:"0px"});return this.__layer}});test("can be constructed",(function(){var t=new(e=require("jira/ajs/layer/inline-layer"))({content:"<p>dummy</p>"});equal(void 0===t?"undefined":_typeof(t),"object","should be an object")}));test("keep left align when near right window edge and still having space",(function(){var e=a(window).width();this.$field.css({left:e-250,top:0});var t=this.makeLayer({width:200,positioningController:new s,alignment:r.LEFT});t.show();h.isLeftAligned(this.$field,t.layer());h.isUnderneath(this.$field,t.layer())}));test("change align to right from left if out of right window edge",(function(){var e=a(window).width();this.$field.css({left:e-150,top:0});var t=this.makeLayer({width:200,positioningController:new s,alignment:r.LEFT});t.show();h.isRightAligned(this.$field,t.layer());h.isUnderneath(this.$field,t.layer())}));test("keep right align when near left window edge and still having space",(function(){this.$field.css({left:101,top:0});var e=this.makeLayer({width:200,positioningController:new s,alignment:r.RIGHT});e.show();h.isRightAligned(this.$field,e.layer());h.isUnderneath(this.$field,e.layer())}));test("change align to left from right if out of left window edge",(function(){this.$field.css({left:100,top:0});var e=this.makeLayer({width:200,positioningController:new s,alignment:r.RIGHT});e.show();h.isLeftAligned(this.$field,e.layer());h.isUnderneath(this.$field,e.layer())}));test("[WindowPositioning] should appear below trigger if enough room",(function(){this.$field.css({left:0,top:0});var e=this.makeLayer({positioningController:new n});e.show();h.isLeftAligned(this.$field,e.layer());h.isUnderneath(this.$field,e.layer())}));test("[WindowPositioning] should move to the RHS if not enough room below",(function(){this.$field.css({left:0,bottom:0});var e=this.makeLayer({positioningController:new n});e.show();h.isOnRightSide(this.$field,e.layer());h.isNearBottom(e.layer())}));test("[WindowPositioning] should move to the LHS if not enough room below or to the right",(function(){this.$field.css({right:0,bottom:0});var e=this.makeLayer({positioningController:new n});e.show();h.isOnLeftSide(this.$field,e.layer());h.isNearBottom(e.layer())}));test("[WindowPositioning] should move to the LHS when would otherwise clip if moved to the RHS (JSEV-397)",(function(){var e=a(window).width();this.$field.css({left:e-250,bottom:10,width:175});var t=this.makeLayer({positioningController:new n,alignment:r.LEFT});t.show();h.isOnLeftSide(this.$field,t.layer());h.isNearBottom(t.layer())}));test("[WindowPositioning] should move to the RHS when would otherwise clip if moved to the LHS",(function(){this.$field.css({left:50,bottom:10,width:175});var e=this.makeLayer({positioningController:new n,alignment:r.RIGHT});e.show();h.isOnRightSide(this.$field,e.layer());h.isNearBottom(e.layer())}));test("[WindowPositioning] should inverse positioning if inversion behaviour is toggled on",(function(){this.$field.css({left:0,bottom:10,width:175});var e=new n;e.setInversePositioningIfNotFit(!0);var t=this.makeLayer({positioningController:e,alignment:r.LEFT});t.show();h.isAbove(this.$field,t.layer())}));module("jira/ajs/layer/inline-layer - XSS",{setup:function(){this.context=AJS.test.mockableModuleContext();this.context.mock("jira/ajs/layer/inline-layer/standard-positioning",t.extend({offset:function(){return{top:0,left:0}}}));this.xssElement=document.createElement("iframe");document.querySelector("#qunit-fixture").appendChild(this.xssElement)},teardown:function(){window.xssSpy=null}});asyncTest("offset still works without window.name xss",(function(){window.xssSpy=this.spy();var e="1,<img src='/' onerror=xssSpy()>";this.xssElement.name=e;var t=this.context.require("jira/ajs/layer/inline-layer/iframe-positioning");this.stub(t,"window").returns({name:e});this.stub(t,"topWindow").returns(window);(new t).offset();setTimeout((function(){ok(window.xssSpy.notCalled,"xssSpy() was called, when it shouldn't have");start()}),4)}))}));